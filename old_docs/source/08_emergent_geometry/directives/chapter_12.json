{
  "chapter_index": 12,
  "section_id": "## 10. Companion Selection Flux Balance at Stationarity",
  "directive_count": 2,
  "hints": [
    {
      "directive_type": "lemma",
      "label": "lem-companion-flux-balance",
      "title": "Companion Flux Balance at QSD",
      "start_line": 3667,
      "end_line": 3685,
      "header_lines": [
        3668
      ],
      "content_start": 3670,
      "content_end": 3684,
      "content": "3670: :label: lem-companion-flux-balance\n3671: \n3672: At the quasi-stationary distribution (QSD), the companion selection flux satisfies a geometric balance condition. For any walker $i$ in the alive set:\n3673: \n3674: $$\n3675: \\sum_{j \\in \\mathcal{A}, j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) = p_i(S) \\cdot \\sqrt{\\frac{\\det g(x_i)}{\\langle \\det g \\rangle}}\n3676: $$\n3677: \n3678: where:\n3679: - $P_{\\text{comp}}(i|j; S) \\propto 1/d_{\\text{alg}}(j,i)^{2+\\nu}$ is the companion selection probability\n3680: - $p_i(S) = \\mathbb{E}_{c \\sim P_{\\text{comp}}}[\\text{clip}(S_i(c)/p_{\\max})]$ is the cloning probability\n3681: - $g(x_i)$ is the emergent Riemannian metric at position $x_i$\n3682: - $\\langle \\det g \\rangle = \\frac{1}{|\\mathcal{A}|}\\sum_{k \\in \\mathcal{A}} \\sqrt{\\det g(x_k)}$ is the mean metric determinant\n3683: \n3684: **Physical interpretation**: The left side is the **rate at which walker $i$ is selected as a companion** by all other walkers. The right side is the **rate at which walker $i$ selects companions**, weighted by the local geometric volume factor $\\sqrt{\\det g(x_i)}$.",
      "metadata": {
        "label": "lem-companion-flux-balance"
      },
      "section": "## 10. Companion Selection Flux Balance at Stationarity",
      "references": [
        "thm-qsd-riemannian-volume-main"
      ],
      "raw_directive": "3667: This section proves a critical result connecting the microscopic companion selection dynamics to the emergent Riemannian geometry at the quasi-stationary distribution (QSD).\n3668: \n3669: :::{prf:lemma} Companion Flux Balance at QSD\n3670: :label: lem-companion-flux-balance\n3671: \n3672: At the quasi-stationary distribution (QSD), the companion selection flux satisfies a geometric balance condition. For any walker $i$ in the alive set:\n3673: \n3674: $$\n3675: \\sum_{j \\in \\mathcal{A}, j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) = p_i(S) \\cdot \\sqrt{\\frac{\\det g(x_i)}{\\langle \\det g \\rangle}}\n3676: $$\n3677: \n3678: where:\n3679: - $P_{\\text{comp}}(i|j; S) \\propto 1/d_{\\text{alg}}(j,i)^{2+\\nu}$ is the companion selection probability\n3680: - $p_i(S) = \\mathbb{E}_{c \\sim P_{\\text{comp}}}[\\text{clip}(S_i(c)/p_{\\max})]$ is the cloning probability\n3681: - $g(x_i)$ is the emergent Riemannian metric at position $x_i$\n3682: - $\\langle \\det g \\rangle = \\frac{1}{|\\mathcal{A}|}\\sum_{k \\in \\mathcal{A}} \\sqrt{\\det g(x_k)}$ is the mean metric determinant\n3683: \n3684: **Physical interpretation**: The left side is the **rate at which walker $i$ is selected as a companion** by all other walkers. The right side is the **rate at which walker $i$ selects companions**, weighted by the local geometric volume factor $\\sqrt{\\det g(x_i)}$.\n3685: "
    },
    {
      "directive_type": "proof",
      "label": "unlabeled-proof-23",
      "title": null,
      "start_line": 3687,
      "end_line": 3814,
      "header_lines": [],
      "content_start": 3688,
      "content_end": 3813,
      "content": "3688: \n3689: :::{prf:proof}\n3690: **Strategy**: We show that at stationarity, the detailed balance condition for the cloning operator implies this flux balance through the Riemannian volume measure.\n3691: \n3692: **Part 1: Stationary Master Equation**\n3693: \n3694: At the QSD, the probability flux into and out of any configuration must balance. For the cloning operator, this reads:\n3695: \n3696: $$\n3697: \\sum_{X'} T_{\\text{clone}}(X \\to X') \\pi_{\\text{QSD}}(X) = \\sum_{X'} T_{\\text{clone}}(X' \\to X) \\pi_{\\text{QSD}}(X')\n3698: $$\n3699: \n3700: Focus on transitions where walker $i$ is replaced. The incoming flux (walker $i$ is created by some $j$ cloning from $k$) equals the outgoing flux (walker $i$ clones and is replaced).\n3701: \n3702: **Part 2: Spatial Marginal and Factorization**\n3703: \n3704: From Theorem {prf:ref}`thm-qsd-spatial-riemannian-volume` in {doc}`13_fractal_set_new/04_rigorous_additions.md`, the spatial marginal of QSD is:\n3705: \n3706: $$\n3707: \\rho_{\\text{spatial}}(x) \\propto \\sqrt{\\det g(x)} \\exp(-U_{\\text{eff}}(x)/T)\n3708: $$\n3709: \n3710: In the mean-field limit $N \\to \\infty$, the QSD factorizes as:\n3711: \n3712: $$\n3713: \\pi_{\\text{QSD}}(X) \\approx \\prod_{i=1}^N \\rho_1(x_i, v_i)\n3714: $$\n3715: \n3716: where $\\rho_1(x, v) \\propto \\sqrt{\\det g(x)} \\exp(-H_{\\text{eff}}(x,v)/T)$ is the single-particle density.\n3717: \n3718: **Part 3: Explicit Form of Single-Particle Density**\n3719: \n3720: From Part 2, the single-particle density at walker $i$'s state $(x_i, v_i)$ is:\n3721: \n3722: $$\n3723: \\rho_1(x_i, v_i) = C \\cdot \\sqrt{\\det g(x_i)} \\cdot \\exp(-H_{\\text{eff}}(x_i, v_i)/T)\n3724: $$\n3725: \n3726: where $C$ is a normalization constant. The key point: the **geometric factor $\\sqrt{\\det g(x_i)}$ is already present** in the stationary density.\n3727: \n3728: **Part 4: Cloning Flux Computation with Geometric Factors**\n3729: \n3730: The **outgoing flux** from walker $i$ (rate at which walker $i$ is replaced by cloning):\n3731: \n3732: $$\n3733: \\Gamma_{\\text{out}}(i) = p_i(S) \\cdot \\rho_1(x_i, v_i) = p_i(S) \\cdot C \\cdot \\sqrt{\\det g(x_i)} \\cdot e^{-H_{\\text{eff}}(x_i, v_i)/T}\n3734: $$\n3735: \n3736: where $p_i(S) = \\mathbb{E}_{c \\sim P_{\\text{comp}}}[\\text{clip}(S_i(c)/p_{\\max})]$ is the total cloning probability for walker $i$.\n3737: \n3738: The **incoming flux** to position $x_i$ (rate at which other walkers clone to create a new walker near $x_i$):\n3739: \n3740: $$\n3741: \\begin{align}\n3742: \\Gamma_{\\text{in}}(i) &= \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\rho_1(x_j, v_j) \\cdot K_{\\text{clone}}(x_j \\to x_i) \\\\\n3743: &\\approx \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\rho_1(x_j, v_j)\n3744: \\end{align}\n3745: $$\n3746: \n3747: where the second line uses the **local cloning approximation**: $K_{\\text{clone}}(x_j \\to x_i) \\approx \\delta(x_i - x_j)$ in the continuum limit (see justification below).\n3748: \n3749: **Crucially**, $\\rho_1(x_j, v_j)$ includes the factor $\\sqrt{\\det g(x_j)}$ from Part 3:\n3750: \n3751: $$\n3752: \\Gamma_{\\text{in}}(i) \\approx \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot C \\cdot \\sqrt{\\det g(x_j)} \\cdot e^{-H_{\\text{eff}}(x_j, v_j)/T}\n3753: $$\n3754: \n3755: **Justification of local cloning**: The cloning kernel $K_{\\text{clone}}(x_j \\to x_i) \\propto \\exp(-\\|x_i - x_j\\|^2/2\\sigma_{\\text{clone}}^2)$ has width $\\sigma_{\\text{clone}}$ much smaller than the typical distance over which $g(x)$ varies. In the continuum limit $N \\to \\infty$ with inter-particle spacing $O(N^{-1/d})$, the kernel converges weakly to $\\delta(x_i - x_j)$, making cloning effectively local.\n3756: \n3757: **Part 5: Stationarity and Geometric Balance**\n3758: \n3759: At stationarity, $\\Gamma_{\\text{in}}(i) = \\Gamma_{\\text{out}}(i)$. Using the explicit forms from Part 4:\n3760: \n3761: $$\n3762: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot C \\cdot \\sqrt{\\det g(x_j)} \\cdot e^{-H_{\\text{eff}}(x_j, v_j)/T} = p_i(S) \\cdot C \\cdot \\sqrt{\\det g(x_i)} \\cdot e^{-H_{\\text{eff}}(x_i, v_i)/T}\n3763: $$\n3764: \n3765: **Velocity thermalization**: On the timescale of spatial cloning dynamics, velocities rapidly thermalize to the Maxwell-Boltzmann distribution (Lemma 1.3.2 in {doc}`13_fractal_set_new/04_rigorous_additions.md`). Therefore, for walkers at the same position $x$, the velocity-dependent factors $e^{-H_{\\text{eff}}/T}$ average out, and we can write:\n3766: \n3767: $$\n3768: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\sqrt{\\det g(x_j)} = p_i(S) \\cdot \\sqrt{\\det g(x_i)}\n3769: $$\n3770: \n3771: **Mean-field approximation**: In the large-$N$ limit, walkers are distributed according to the spatial marginal $\\rho_{\\text{spatial}}(x) \\propto \\sqrt{\\det g(x)} \\exp(-U_{\\text{eff}}(x)/T)$. For a sum over $j$ weighted by $P_{\\text{comp}}(i|j; S)$ (which depends on the swarm distribution), the geometric factors at different positions satisfy:\n3772: \n3773: $$\n3774: \\frac{1}{|\\mathcal{A}|} \\sum_{j \\in \\mathcal{A}} \\sqrt{\\det g(x_j)} \\xrightarrow{N \\to \\infty} \\langle \\det g \\rangle := \\frac{1}{|\\mathcal{A}|} \\sum_{k \\in \\mathcal{A}} \\sqrt{\\det g(x_k)}\n3775: $$\n3776: \n3777: where the convergence holds by the law of large numbers applied to the spatial marginal.\n3778: \n3779: Dividing both sides of the flux balance by $\\sqrt{\\det g(x_i)}$ and using the mean-field approximation:\n3780: \n3781: $$\n3782: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\frac{\\sqrt{\\det g(x_j)}}{\\sqrt{\\det g(x_i)}} = p_i(S)\n3783: $$\n3784: \n3785: **Weighted average convergence**: Define the selection-weighted average:\n3786: \n3787: $$\n3788: \\langle f \\rangle_{i,S} := \\frac{\\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot f(x_j)}{\\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S)}\n3789: $$\n3790: \n3791: For sufficiently smooth functions $f$, standard mean-field theory (McKean-Vlasov propagation of chaos; see Sznitman *Topics in propagation of chaos*, 1991, \u00a73) gives:\n3792: \n3793: $$\n3794: \\mathbb{E}_{X \\sim \\pi_{\\text{QSD}}}[\\langle f \\rangle_{i,S}] \\xrightarrow{N \\to \\infty} \\int_{\\mathcal{X}} f(x) \\rho_{\\text{spatial}}(x) \\, dx\n3795: $$\n3796: \n3797: with variance $\\text{Var}[\\langle f \\rangle_{i,S}] = O(1/N)$. Applying this with $f(x) = \\sqrt{\\det g(x)}$ and using concentration of measure, the weighted average converges to the spatial mean $\\langle \\det g \\rangle$ with high probability. Therefore:\n3798: \n3799: $$\n3800: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\sqrt{\\det g(x_j)} \\approx \\left[\\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S)\\right] \\cdot \\langle \\det g \\rangle\n3801: $$\n3802: \n3803: which gives:\n3804: \n3805: $$\n3806: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\approx p_i(S) \\cdot \\frac{\\langle \\det g \\rangle}{\\sqrt{\\det g(x_i)}}\n3807: $$\n3808: \n3809: Rearranging gives the flux balance condition:\n3810: \n3811: $$\n3812: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) = p_i(S) \\cdot \\sqrt{\\frac{\\det g(x_i)}{\\langle \\det g \\rangle}}\n3813: $$",
      "metadata": {},
      "section": "## 10. Companion Selection Flux Balance at Stationarity",
      "references": [
        "thm-qsd-spatial-riemannian-volume"
      ],
      "raw_directive": "3687: :::\n3688: \n3689: :::{prf:proof}\n3690: **Strategy**: We show that at stationarity, the detailed balance condition for the cloning operator implies this flux balance through the Riemannian volume measure.\n3691: \n3692: **Part 1: Stationary Master Equation**\n3693: \n3694: At the QSD, the probability flux into and out of any configuration must balance. For the cloning operator, this reads:\n3695: \n3696: $$\n3697: \\sum_{X'} T_{\\text{clone}}(X \\to X') \\pi_{\\text{QSD}}(X) = \\sum_{X'} T_{\\text{clone}}(X' \\to X) \\pi_{\\text{QSD}}(X')\n3698: $$\n3699: \n3700: Focus on transitions where walker $i$ is replaced. The incoming flux (walker $i$ is created by some $j$ cloning from $k$) equals the outgoing flux (walker $i$ clones and is replaced).\n3701: \n3702: **Part 2: Spatial Marginal and Factorization**\n3703: \n3704: From Theorem {prf:ref}`thm-qsd-spatial-riemannian-volume` in {doc}`13_fractal_set_new/04_rigorous_additions.md`, the spatial marginal of QSD is:\n3705: \n3706: $$\n3707: \\rho_{\\text{spatial}}(x) \\propto \\sqrt{\\det g(x)} \\exp(-U_{\\text{eff}}(x)/T)\n3708: $$\n3709: \n3710: In the mean-field limit $N \\to \\infty$, the QSD factorizes as:\n3711: \n3712: $$\n3713: \\pi_{\\text{QSD}}(X) \\approx \\prod_{i=1}^N \\rho_1(x_i, v_i)\n3714: $$\n3715: \n3716: where $\\rho_1(x, v) \\propto \\sqrt{\\det g(x)} \\exp(-H_{\\text{eff}}(x,v)/T)$ is the single-particle density.\n3717: \n3718: **Part 3: Explicit Form of Single-Particle Density**\n3719: \n3720: From Part 2, the single-particle density at walker $i$'s state $(x_i, v_i)$ is:\n3721: \n3722: $$\n3723: \\rho_1(x_i, v_i) = C \\cdot \\sqrt{\\det g(x_i)} \\cdot \\exp(-H_{\\text{eff}}(x_i, v_i)/T)\n3724: $$\n3725: \n3726: where $C$ is a normalization constant. The key point: the **geometric factor $\\sqrt{\\det g(x_i)}$ is already present** in the stationary density.\n3727: \n3728: **Part 4: Cloning Flux Computation with Geometric Factors**\n3729: \n3730: The **outgoing flux** from walker $i$ (rate at which walker $i$ is replaced by cloning):\n3731: \n3732: $$\n3733: \\Gamma_{\\text{out}}(i) = p_i(S) \\cdot \\rho_1(x_i, v_i) = p_i(S) \\cdot C \\cdot \\sqrt{\\det g(x_i)} \\cdot e^{-H_{\\text{eff}}(x_i, v_i)/T}\n3734: $$\n3735: \n3736: where $p_i(S) = \\mathbb{E}_{c \\sim P_{\\text{comp}}}[\\text{clip}(S_i(c)/p_{\\max})]$ is the total cloning probability for walker $i$.\n3737: \n3738: The **incoming flux** to position $x_i$ (rate at which other walkers clone to create a new walker near $x_i$):\n3739: \n3740: $$\n3741: \\begin{align}\n3742: \\Gamma_{\\text{in}}(i) &= \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\rho_1(x_j, v_j) \\cdot K_{\\text{clone}}(x_j \\to x_i) \\\\\n3743: &\\approx \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\rho_1(x_j, v_j)\n3744: \\end{align}\n3745: $$\n3746: \n3747: where the second line uses the **local cloning approximation**: $K_{\\text{clone}}(x_j \\to x_i) \\approx \\delta(x_i - x_j)$ in the continuum limit (see justification below).\n3748: \n3749: **Crucially**, $\\rho_1(x_j, v_j)$ includes the factor $\\sqrt{\\det g(x_j)}$ from Part 3:\n3750: \n3751: $$\n3752: \\Gamma_{\\text{in}}(i) \\approx \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot C \\cdot \\sqrt{\\det g(x_j)} \\cdot e^{-H_{\\text{eff}}(x_j, v_j)/T}\n3753: $$\n3754: \n3755: **Justification of local cloning**: The cloning kernel $K_{\\text{clone}}(x_j \\to x_i) \\propto \\exp(-\\|x_i - x_j\\|^2/2\\sigma_{\\text{clone}}^2)$ has width $\\sigma_{\\text{clone}}$ much smaller than the typical distance over which $g(x)$ varies. In the continuum limit $N \\to \\infty$ with inter-particle spacing $O(N^{-1/d})$, the kernel converges weakly to $\\delta(x_i - x_j)$, making cloning effectively local.\n3756: \n3757: **Part 5: Stationarity and Geometric Balance**\n3758: \n3759: At stationarity, $\\Gamma_{\\text{in}}(i) = \\Gamma_{\\text{out}}(i)$. Using the explicit forms from Part 4:\n3760: \n3761: $$\n3762: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot C \\cdot \\sqrt{\\det g(x_j)} \\cdot e^{-H_{\\text{eff}}(x_j, v_j)/T} = p_i(S) \\cdot C \\cdot \\sqrt{\\det g(x_i)} \\cdot e^{-H_{\\text{eff}}(x_i, v_i)/T}\n3763: $$\n3764: \n3765: **Velocity thermalization**: On the timescale of spatial cloning dynamics, velocities rapidly thermalize to the Maxwell-Boltzmann distribution (Lemma 1.3.2 in {doc}`13_fractal_set_new/04_rigorous_additions.md`). Therefore, for walkers at the same position $x$, the velocity-dependent factors $e^{-H_{\\text{eff}}/T}$ average out, and we can write:\n3766: \n3767: $$\n3768: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\sqrt{\\det g(x_j)} = p_i(S) \\cdot \\sqrt{\\det g(x_i)}\n3769: $$\n3770: \n3771: **Mean-field approximation**: In the large-$N$ limit, walkers are distributed according to the spatial marginal $\\rho_{\\text{spatial}}(x) \\propto \\sqrt{\\det g(x)} \\exp(-U_{\\text{eff}}(x)/T)$. For a sum over $j$ weighted by $P_{\\text{comp}}(i|j; S)$ (which depends on the swarm distribution), the geometric factors at different positions satisfy:\n3772: \n3773: $$\n3774: \\frac{1}{|\\mathcal{A}|} \\sum_{j \\in \\mathcal{A}} \\sqrt{\\det g(x_j)} \\xrightarrow{N \\to \\infty} \\langle \\det g \\rangle := \\frac{1}{|\\mathcal{A}|} \\sum_{k \\in \\mathcal{A}} \\sqrt{\\det g(x_k)}\n3775: $$\n3776: \n3777: where the convergence holds by the law of large numbers applied to the spatial marginal.\n3778: \n3779: Dividing both sides of the flux balance by $\\sqrt{\\det g(x_i)}$ and using the mean-field approximation:\n3780: \n3781: $$\n3782: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\frac{\\sqrt{\\det g(x_j)}}{\\sqrt{\\det g(x_i)}} = p_i(S)\n3783: $$\n3784: \n3785: **Weighted average convergence**: Define the selection-weighted average:\n3786: \n3787: $$\n3788: \\langle f \\rangle_{i,S} := \\frac{\\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot f(x_j)}{\\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S)}\n3789: $$\n3790: \n3791: For sufficiently smooth functions $f$, standard mean-field theory (McKean-Vlasov propagation of chaos; see Sznitman *Topics in propagation of chaos*, 1991, \u00a73) gives:\n3792: \n3793: $$\n3794: \\mathbb{E}_{X \\sim \\pi_{\\text{QSD}}}[\\langle f \\rangle_{i,S}] \\xrightarrow{N \\to \\infty} \\int_{\\mathcal{X}} f(x) \\rho_{\\text{spatial}}(x) \\, dx\n3795: $$\n3796: \n3797: with variance $\\text{Var}[\\langle f \\rangle_{i,S}] = O(1/N)$. Applying this with $f(x) = \\sqrt{\\det g(x)}$ and using concentration of measure, the weighted average converges to the spatial mean $\\langle \\det g \\rangle$ with high probability. Therefore:\n3798: \n3799: $$\n3800: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\sqrt{\\det g(x_j)} \\approx \\left[\\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S)\\right] \\cdot \\langle \\det g \\rangle\n3801: $$\n3802: \n3803: which gives:\n3804: \n3805: $$\n3806: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\approx p_i(S) \\cdot \\frac{\\langle \\det g \\rangle}{\\sqrt{\\det g(x_i)}}\n3807: $$\n3808: \n3809: Rearranging gives the flux balance condition:\n3810: \n3811: $$\n3812: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) = p_i(S) \\cdot \\sqrt{\\frac{\\det g(x_i)}{\\langle \\det g \\rangle}}\n3813: $$\n3814: "
    }
  ],
  "validation": {
    "ok": true,
    "errors": []
  }
}