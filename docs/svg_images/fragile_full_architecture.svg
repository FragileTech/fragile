<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 960" width="1400" height="960">
  <title>Fragile Agent: Full System Architecture</title>
  <desc>Comprehensive architecture diagram showing all components: Environment, Encoder/Shutter with Attentive Atlas, Decoder, World Model, Critic, Policy, Holographic Screen, Governor/Sieve, plus latent spaces (X, Z, motor A, context C, Theta) and dual-atlas encoders/decoders.</desc>

  <!-- Definitions -->
  <defs>
    <!-- Arrow markers for different signal types -->
    <marker id="arrow-observation" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#3B82F6"/>
    </marker>
    <marker id="arrow-latent" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#10B981"/>
    </marker>
    <marker id="arrow-reward" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#F59E0B"/>
    </marker>
    <marker id="arrow-action" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#8B5CF6"/>
    </marker>
    <marker id="arrow-monitor" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#6B7280"/>
    </marker>
    <marker id="arrow-dark" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
    </marker>

    <!-- Gradients -->
    <linearGradient id="envGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#ECFDF5;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#D1FAE5;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="encoderGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#EFF6FF;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#DBEAFE;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="decoderGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#ECFDF5;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#D1FAE5;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="worldGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#FAF5FF;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#F3E8FF;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="criticGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#FFFBEB;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#FEF3C7;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="policyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#F5F3FF;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#EDE9FE;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="memoryGradient" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#FEF3C7;stop-opacity:1" />
      <stop offset="50%" style="stop-color:#FFFBEB;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#FEF3C7;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="governorGradient" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#FEF2F2;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#FEE2E2;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="latentGradient" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#F3E8FF;stop-opacity:0.5" />
      <stop offset="50%" style="stop-color:#EFF6FF;stop-opacity:0.5" />
      <stop offset="100%" style="stop-color:#F9FAFB;stop-opacity:0.5" />
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="1400" height="960" fill="#FAFAFA"/>

  <!-- Title -->
  <g id="title">
    <text x="700" y="32" font-family="system-ui, -apple-system, sans-serif" font-size="18" font-weight="600" fill="#1F2937" text-anchor="middle">Fragile Agent: Full System Architecture</text>
  </g>

  <!-- ==================== GOVERNOR/SIEVE (Surrounding Frame) ==================== -->
  <g id="governor-frame">
    <!-- Outer monitoring boundary -->
    <rect x="170" y="120" width="1140" height="720" rx="12" ry="12" fill="none" stroke="#EF4444" stroke-width="2" stroke-dasharray="6,4" opacity="0.6"/>

    <!-- Governor label top-right -->
    <g transform="translate(1120, 40)">
      <rect x="0" y="0" width="200" height="60" rx="6" ry="6" fill="url(#governorGradient)" stroke="#EF4444" stroke-width="2"/>
      <text x="100" y="22" font-family="system-ui, -apple-system, sans-serif" font-size="11" font-weight="700" fill="#DC2626" text-anchor="middle">GOVERNOR / SIEVE</text>
      <text x="100" y="40" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280" text-anchor="middle">55 Runtime Contracts</text>
      <text x="100" y="54" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#9CA3AF" text-anchor="middle" font-style="italic">WARN / HALT / KILL</text>
    </g>

    <!-- Monitoring indicators around perimeter -->
    <circle cx="185" cy="260" r="4" fill="#EF4444" opacity="0.5"/>
    <circle cx="185" cy="470" r="4" fill="#EF4444" opacity="0.5"/>
    <circle cx="185" cy="680" r="4" fill="#EF4444" opacity="0.5"/>
    <circle cx="1295" cy="260" r="4" fill="#EF4444" opacity="0.5"/>
    <circle cx="1295" cy="470" r="4" fill="#EF4444" opacity="0.5"/>
    <circle cx="1295" cy="680" r="4" fill="#EF4444" opacity="0.5"/>
  </g>

  <!-- ==================== HOLOGRAPHIC SCREEN (Top Memory Bar) ==================== -->
  <g id="holographic-screen" transform="translate(80, 80)">
    <rect x="180" y="55" width="700" height="50" rx="8" ry="8" fill="url(#memoryGradient)" stroke="#F59E0B" stroke-width="2"/>

    <!-- Header -->
    <text x="530" y="75" font-family="system-ui, -apple-system, sans-serif" font-size="12" font-weight="600" fill="#92400E" text-anchor="middle">HOLOGRAPHIC SCREEN</text>
    <text x="530" y="92" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280" text-anchor="middle" font-style="italic">Memory: {z<tspan font-size="7" baseline-shift="sub">t'</tspan>, a<tspan font-size="7" baseline-shift="sub">t'</tspan>, r<tspan font-size="7" baseline-shift="sub">t'</tspan>} for t' &lt; t</text>

    <!-- Memory slots visualization -->
    <g transform="translate(200, 65)">
      <rect x="0" y="0" width="18" height="25" rx="2" fill="#FEF3C7" stroke="#FCD34D" stroke-width="1"/>
      <rect x="22" y="0" width="18" height="25" rx="2" fill="#FEF3C7" stroke="#FCD34D" stroke-width="1"/>
      <rect x="44" y="0" width="18" height="25" rx="2" fill="#FEFCE8" stroke="#FCD34D" stroke-width="1"/>
      <rect x="66" y="0" width="18" height="25" rx="2" fill="#FEFCE8" stroke="#FCD34D" stroke-width="1"/>
      <text x="48" y="36" font-family="system-ui, -apple-system, sans-serif" font-size="7" fill="#92400E" text-anchor="middle">past tuples</text>
    </g>

    <!-- Attention retrieval indicator -->
    <g transform="translate(750, 68)">
      <text x="0" y="10" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280" text-anchor="start"><tspan fill="#92400E">z<tspan font-size="7" baseline-shift="sub">t</tspan></tspan> queries past</text>
    </g>
  </g>

  <!-- ==================== ENVIRONMENT (Left Side) ==================== -->
  <g id="environment" transform="translate(10, 40)">
    <rect x="20" y="280" width="100" height="200" rx="10" ry="10" fill="url(#envGradient)" stroke="#10B981" stroke-width="2.5"/>

    <!-- Header -->
    <rect x="20" y="280" width="100" height="30" rx="10" ry="10" fill="#10B981"/>
    <rect x="20" y="300" width="100" height="12" fill="#10B981"/>
    <text x="70" y="300" font-family="system-ui, -apple-system, sans-serif" font-size="11" font-weight="700" fill="white" text-anchor="middle">ENVIRONMENT</text>

    <!-- Outputs from environment -->
    <g transform="translate(35, 325)">
      <text x="35" y="12" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#047857" text-anchor="middle" font-weight="500">Provides:</text>

      <!-- x_t -->
      <rect x="5" y="20" width="60" height="22" rx="3" fill="#D1FAE5" stroke="#6EE7B7" stroke-width="1"/>
      <text x="35" y="35" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#047857" text-anchor="middle">x<tspan font-size="7" baseline-shift="sub">t</tspan></text>

      <!-- r_t -->
      <rect x="5" y="48" width="60" height="22" rx="3" fill="#FEF3C7" stroke="#FCD34D" stroke-width="1"/>
      <text x="35" y="63" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#92400E" text-anchor="middle">r<tspan font-size="7" baseline-shift="sub">t</tspan></text>

      <!-- d_t -->
      <rect x="5" y="76" width="60" height="22" rx="3" fill="#F3F4F6" stroke="#D1D5DB" stroke-width="1"/>
      <text x="35" y="91" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#6B7280" text-anchor="middle">d<tspan font-size="7" baseline-shift="sub">t</tspan></text>
    </g>

    <!-- Input to environment -->
    <g transform="translate(35, 435)">
      <text x="35" y="12" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#047857" text-anchor="middle" font-weight="500">Receives:</text>
      <rect x="5" y="18" width="60" height="22" rx="3" fill="#EDE9FE" stroke="#C4B5FD" stroke-width="1"/>
      <text x="35" y="33" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#7C3AED" text-anchor="middle">a<tspan font-size="7" baseline-shift="sub">t</tspan></text>
    </g>
  </g>

  <!-- ==================== ENCODER/SHUTTER (Split VQ-VAE) ==================== -->
  <g id="encoder-shutter" transform="translate(40, 90)">
    <rect x="160" y="130" width="340" height="260" rx="10" ry="10" fill="url(#encoderGradient)" stroke="#2563EB" stroke-width="2.5"/>

    <!-- Header -->
    <rect x="160" y="130" width="340" height="32" rx="10" ry="10" fill="#2563EB"/>
    <rect x="160" y="152" width="340" height="12" fill="#2563EB"/>
    <text x="330" y="152" font-family="system-ui, -apple-system, sans-serif" font-size="12" font-weight="700" fill="white" text-anchor="middle">ENCODER / SHUTTER</text>

    <!-- Subtitle -->
    <text x="330" y="180" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#2563EB" text-anchor="middle" font-style="italic">Split VQ-VAE with Attentive Atlas</text>

    <!-- Feature Extractor -->
    <g transform="translate(175, 195)">
      <rect x="0" y="0" width="140" height="35" rx="4" fill="#DBEAFE" stroke="#93C5FD" stroke-width="1.5"/>
      <text x="70" y="15" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="600" fill="#1D4ED8" text-anchor="middle">Feature Extractor</text>
      <text x="70" y="28" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#3B82F6" text-anchor="middle" font-style="italic">f(x) backbone</text>
    </g>

    <!-- Key/Value Projections -->
    <g transform="translate(175, 238)">
      <rect x="0" y="0" width="65" height="28" rx="3" fill="#BFDBFE" stroke="#60A5FA" stroke-width="1"/>
      <text x="32" y="13" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#1D4ED8" text-anchor="middle" font-weight="500">k(x)=W<tspan font-size="6" baseline-shift="sub">k</tspan></text>
      <text x="32" y="23" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#1D4ED8" text-anchor="middle">f(x)</text>
    </g>
    <g transform="translate(250, 238)">
      <rect x="0" y="0" width="65" height="28" rx="3" fill="#BFDBFE" stroke="#60A5FA" stroke-width="1"/>
      <text x="32" y="13" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#1D4ED8" text-anchor="middle" font-weight="500">v(x)=W<tspan font-size="6" baseline-shift="sub">v</tspan></text>
      <text x="32" y="23" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#1D4ED8" text-anchor="middle">f(x)</text>
    </g>

    <!-- Chart Query Bank -->
    <g transform="translate(330, 195)">
      <rect x="0" y="0" width="155" height="35" rx="4" fill="#E0E7FF" stroke="#A5B4FC" stroke-width="1.5"/>
      <text x="77" y="15" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="600" fill="#4338CA" text-anchor="middle">Chart Query Bank</text>
      <text x="77" y="28" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6366F1" text-anchor="middle" font-style="italic">{q<tspan font-size="6" baseline-shift="sub">i</tspan>} prototypes</text>
    </g>

    <!-- Cross-Attention Router -->
    <g transform="translate(330, 238)">
      <rect x="0" y="0" width="155" height="28" rx="3" fill="#C7D2FE" stroke="#818CF8" stroke-width="1"/>
      <text x="77" y="12" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#4338CA" text-anchor="middle" font-weight="500">Cross-Attention Router</text>
      <text x="77" y="23" font-family="system-ui, -apple-system, sans-serif" font-size="7" fill="#6366F1" text-anchor="middle">softmax(k@q.T/sqrt(d))</text>
    </g>

    <!-- VQ Codebook -->
    <g transform="translate(175, 278)">
      <rect x="0" y="0" width="310" height="45" rx="4" fill="#F3E8FF" stroke="#C4B5FD" stroke-width="1.5"/>
      <text x="155" y="15" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="600" fill="#7C3AED" text-anchor="middle">VQ Codebook {e<tspan font-size="6" baseline-shift="sub">i,c</tspan>} per-chart codes</text>

      <!-- Codebook grid -->
      <g transform="translate(30, 22)">
        <rect x="0" y="0" width="12" height="12" rx="2" fill="#DDD6FE" stroke="#A78BFA" stroke-width="1"/>
        <rect x="16" y="0" width="12" height="12" rx="2" fill="#C4B5FD" stroke="#A78BFA" stroke-width="1"/>
        <rect x="32" y="0" width="12" height="12" rx="2" fill="#DDD6FE" stroke="#A78BFA" stroke-width="1"/>
        <rect x="48" y="0" width="12" height="12" rx="2" fill="#EDE9FE" stroke="#A78BFA" stroke-width="1"/>
        <rect x="64" y="0" width="12" height="12" rx="2" fill="#C4B5FD" stroke="#A78BFA" stroke-width="1"/>
        <text x="95" y="10" font-family="system-ui, -apple-system, sans-serif" font-size="7" fill="#7C3AED">chart 1</text>
      </g>
      <g transform="translate(145, 22)">
        <rect x="0" y="0" width="12" height="12" rx="2" fill="#EDE9FE" stroke="#A78BFA" stroke-width="1"/>
        <rect x="16" y="0" width="12" height="12" rx="2" fill="#DDD6FE" stroke="#A78BFA" stroke-width="1"/>
        <rect x="32" y="0" width="12" height="12" rx="2" fill="#8B5CF6" stroke="#7C3AED" stroke-width="1.5"/>
        <rect x="48" y="0" width="12" height="12" rx="2" fill="#DDD6FE" stroke="#A78BFA" stroke-width="1"/>
        <rect x="64" y="0" width="12" height="12" rx="2" fill="#EDE9FE" stroke="#A78BFA" stroke-width="1"/>
        <text x="95" y="10" font-family="system-ui, -apple-system, sans-serif" font-size="7" fill="#7C3AED">chart 2</text>
        <circle cx="38" cy="6" r="2" fill="white"/>
      </g>
    </g>

    <!-- Outputs label -->
    <text x="330" y="340" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="600" fill="#1F2937" text-anchor="middle">Outputs:</text>

    <!-- Output boxes -->
    <g transform="translate(175, 350)">
      <!-- K -->
      <rect x="0" y="0" width="90" height="30" rx="4" fill="#F3E8FF" stroke="#8B5CF6" stroke-width="1.5"/>
      <text x="45" y="14" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="600" fill="#7C3AED" text-anchor="middle">K = (K<tspan font-size="6" baseline-shift="sub">chart</tspan>,</text>
      <text x="45" y="26" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#7C3AED" text-anchor="middle">K<tspan font-size="6" baseline-shift="sub">code</tspan>)</text>
    </g>
    <g transform="translate(275, 350)">
      <!-- z_n -->
      <rect x="0" y="0" width="70" height="30" rx="4" fill="#EFF6FF" stroke="#3B82F6" stroke-width="1.5"/>
      <text x="35" y="18" font-family="system-ui, -apple-system, sans-serif" font-size="10" font-weight="500" fill="#2563EB" text-anchor="middle">z<tspan font-size="7" baseline-shift="sub">n</tspan></text>
    </g>
    <g transform="translate(355, 350)">
      <!-- z_tex -->
      <rect x="0" y="0" width="70" height="30" rx="4" fill="#F9FAFB" stroke="#9CA3AF" stroke-width="1.5"/>
      <text x="35" y="18" font-family="system-ui, -apple-system, sans-serif" font-size="10" font-weight="500" fill="#6B7280" text-anchor="middle">z<tspan font-size="7" baseline-shift="sub">tex</tspan></text>
    </g>
  </g>

  <!-- ==================== VISUAL LATENT SPACE ==================== -->
  <g id="visual-latent">
    <rect x="550" y="510" width="200" height="120" rx="8" ry="8" fill="url(#latentGradient)" stroke="#374151" stroke-width="2"/>
    <text x="650" y="530" font-family="system-ui, -apple-system, sans-serif" font-size="11" font-weight="600" fill="#1F2937" text-anchor="middle">Visual Latent Z</text>
    <text x="650" y="544" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#6B7280" text-anchor="middle">K, z<tspan font-size="6" baseline-shift="sub">n</tspan>, z<tspan font-size="6" baseline-shift="sub">tex</tspan></text>

    <!-- Three-tier visualization -->
    <rect x="562" y="550" width="52" height="30" rx="4" fill="#F3E8FF" stroke="#8B5CF6" stroke-width="1.5"/>
    <text x="588" y="568" font-family="system-ui, -apple-system, sans-serif" font-size="11" font-weight="600" fill="#7C3AED" text-anchor="middle">K</text>

    <rect x="622" y="550" width="52" height="30" rx="4" fill="#EFF6FF" stroke="#3B82F6" stroke-width="1.5"/>
    <text x="648" y="568" font-family="system-ui, -apple-system, sans-serif" font-size="10" font-weight="500" fill="#2563EB" text-anchor="middle">z<tspan font-size="7" baseline-shift="sub">n</tspan></text>

    <rect x="682" y="550" width="52" height="30" rx="4" fill="#F9FAFB" stroke="#9CA3AF" stroke-width="1.5"/>
    <text x="708" y="568" font-family="system-ui, -apple-system, sans-serif" font-size="10" font-weight="500" fill="#6B7280" text-anchor="middle">z<tspan font-size="7" baseline-shift="sub">tex</tspan></text>

    <!-- Control-relevant bracket -->
    <path d="M562 586 L562 593 L674 593 L674 586" fill="none" stroke="#2563EB" stroke-width="1.5"/>
    <text x="618" y="606" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#2563EB" text-anchor="middle" font-weight="500">control-relevant</text>

    <!-- Firewall indicator -->
    <line x1="678" y1="550" x2="678" y2="580" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2"/>
    <text x="710" y="606" font-family="system-ui, -apple-system, sans-serif" font-size="7" fill="#EF4444" text-anchor="middle" font-weight="500">firewall</text>
  </g>

  <!-- ==================== MOTOR LATENT SPACE ==================== -->
  <g id="motor-latent">
    <rect x="760" y="750" width="200" height="90" rx="8" ry="8" fill="#F5F3FF" stroke="#8B5CF6" stroke-width="2"/>
    <text x="860" y="766" font-family="system-ui, -apple-system, sans-serif" font-size="10" font-weight="600" fill="#4C1D95" text-anchor="middle">Motor Latent A</text>
    <text x="860" y="780" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#6B7280" text-anchor="middle">A, z<tspan font-size="6" baseline-shift="sub">n,motor</tspan>, z<tspan font-size="6" baseline-shift="sub">tex,motor</tspan></text>

    <rect x="770" y="785" width="50" height="28" rx="4" fill="#EDE9FE" stroke="#8B5CF6" stroke-width="1.5"/>
    <text x="795" y="802" font-family="system-ui, -apple-system, sans-serif" font-size="10" font-weight="600" fill="#7C3AED" text-anchor="middle">A</text>

    <rect x="826" y="785" width="50" height="28" rx="4" fill="#EFF6FF" stroke="#3B82F6" stroke-width="1.5"/>
    <text x="851" y="802" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="500" fill="#2563EB" text-anchor="middle">z<tspan font-size="6" baseline-shift="sub">n</tspan></text>

    <rect x="882" y="785" width="50" height="28" rx="4" fill="#F9FAFB" stroke="#9CA3AF" stroke-width="1.5"/>
    <text x="907" y="802" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="500" fill="#6B7280" text-anchor="middle">z<tspan font-size="6" baseline-shift="sub">tex</tspan></text>

    <path d="M770 818 L770 824 L876 824 L876 818" fill="none" stroke="#2563EB" stroke-width="1.2"/>
    <text x="823" y="836" font-family="system-ui, -apple-system, sans-serif" font-size="7" fill="#2563EB" text-anchor="middle" font-weight="500">control-relevant</text>
    <line x1="878" y1="785" x2="878" y2="813" stroke="#EF4444" stroke-width="1.8" stroke-dasharray="4,2"/>
    <text x="910" y="836" font-family="system-ui, -apple-system, sans-serif" font-size="7" fill="#EF4444" text-anchor="middle" font-weight="500">firewall</text>
  </g>

  <!-- ==================== DECODER ==================== -->
  <g id="decoder" transform="translate(40, 180)">
    <rect x="160" y="540" width="150" height="90" rx="8" ry="8" fill="url(#decoderGradient)" stroke="#22C55E" stroke-width="2"/>

    <!-- Header -->
    <rect x="160" y="540" width="150" height="26" rx="8" ry="8" fill="#22C55E"/>
    <rect x="160" y="558" width="150" height="10" fill="#22C55E"/>
    <text x="235" y="558" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="700" fill="white" text-anchor="middle">VISUAL DECODER</text>

    <!-- Content -->
    <text x="235" y="585" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#166534" text-anchor="middle">Input: z<tspan font-size="6" baseline-shift="sub">geo</tspan> = z<tspan font-size="6" baseline-shift="sub">q</tspan> + z<tspan font-size="6" baseline-shift="sub">n</tspan></text>

    <text x="235" y="605" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#15803D" text-anchor="middle" font-style="italic">Output: reconstructed x</text>

    <text x="235" y="622" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#4B5563" text-anchor="middle">z<tspan font-size="6" baseline-shift="sub">tex</tspan> for recon only</text>
  </g>

  <!-- ==================== WORLD MODEL ==================== -->
  <g id="world-model" transform="translate(220, 90)">
    <rect x="540" y="130" width="200" height="130" rx="8" ry="8" fill="url(#worldGradient)" stroke="#8B5CF6" stroke-width="2.5"/>

    <!-- Header -->
    <rect x="540" y="130" width="200" height="28" rx="8" ry="8" fill="#8B5CF6"/>
    <rect x="540" y="150" width="200" height="10" fill="#8B5CF6"/>
    <text x="640" y="150" font-family="system-ui, -apple-system, sans-serif" font-size="11" font-weight="700" fill="white" text-anchor="middle">WORLD MODEL</text>

    <!-- Content -->
    <text x="640" y="180" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#7C3AED" text-anchor="middle" font-weight="500">Predicts:</text>
    <text x="640" y="198" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#6D28D9" text-anchor="middle" font-style="italic">P(K<tspan font-size="7" baseline-shift="sub">t+1</tspan>, z<tspan font-size="7" baseline-shift="sub">n,t+1</tspan> |</text>
    <text x="640" y="216" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#6D28D9" text-anchor="middle" font-style="italic">K<tspan font-size="7" baseline-shift="sub">t</tspan>, z<tspan font-size="7" baseline-shift="sub">n,t</tspan>, a<tspan font-size="7" baseline-shift="sub">t</tspan>)</text>

    <text x="640" y="240" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280" text-anchor="middle">Latent dynamics on (K, z<tspan font-size="6" baseline-shift="sub">n</tspan>)</text>
    <text x="640" y="252" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#9CA3AF" text-anchor="middle" font-style="italic">Planning &amp; counterfactual</text>
  </g>

  <!-- ==================== CRITIC ==================== -->
  <g id="critic" transform="translate(220, 120)">
    <rect x="540" y="290" width="200" height="140" rx="8" ry="8" fill="url(#criticGradient)" stroke="#F59E0B" stroke-width="2.5"/>

    <!-- Header -->
    <rect x="540" y="290" width="200" height="28" rx="8" ry="8" fill="#F59E0B"/>
    <rect x="540" y="310" width="200" height="10" fill="#F59E0B"/>
    <text x="640" y="310" font-family="system-ui, -apple-system, sans-serif" font-size="11" font-weight="700" fill="white" text-anchor="middle">CRITIC</text>

    <!-- Subtitle -->
    <text x="640" y="335" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#92400E" text-anchor="middle" font-weight="500">Helmholtz Solver</text>

    <!-- Content -->
    <text x="640" y="358" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#D97706" text-anchor="middle" font-style="italic">V(z) via screened</text>
    <text x="640" y="373" font-family="system-ui, -apple-system, sans-serif" font-size="10" fill="#D97706" text-anchor="middle" font-style="italic">Poisson equation</text>

    <!-- Reward input indicator -->
    <g transform="translate(560, 388)">
      <rect x="0" y="0" width="55" height="22" rx="3" fill="#FEF3C7" stroke="#FCD34D" stroke-width="1"/>
      <text x="27.5" y="15" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#92400E" text-anchor="middle">r<tspan font-size="6" baseline-shift="sub">t</tspan> input</text>
    </g>

    <!-- Output indicator -->
    <g transform="translate(625, 388)">
      <rect x="0" y="0" width="95" height="22" rx="3" fill="#FEF3C7" stroke="#FCD34D" stroke-width="1"/>
      <text x="47" y="15" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#92400E" text-anchor="middle">Output: V, nabla V</text>
    </g>
    <text x="672" y="422" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#9CA3AF" text-anchor="middle" font-style="italic">value gradients for policy</text>
  </g>

  <!-- ==================== POLICY ==================== -->
  <g id="policy" transform="translate(220, 150)">
    <rect x="540" y="460" width="200" height="130" rx="8" ry="8" fill="url(#policyGradient)" stroke="#8B5CF6" stroke-width="2.5"/>

    <!-- Header -->
    <rect x="540" y="460" width="200" height="28" rx="8" ry="8" fill="#8B5CF6"/>
    <rect x="540" y="480" width="200" height="10" fill="#8B5CF6"/>
    <text x="640" y="480" font-family="system-ui, -apple-system, sans-serif" font-size="11" font-weight="700" fill="white" text-anchor="middle">POLICY</text>

    <!-- Subtitle -->
    <text x="640" y="505" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#7C3AED" text-anchor="middle" font-weight="500">Controller</text>

    <!-- Inputs -->
    <text x="640" y="525" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6B7280" text-anchor="middle">Input: K, z<tspan font-size="6" baseline-shift="sub">n</tspan>, V(z), nabla V</text>

    <!-- Output -->
    <text x="640" y="545" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#6D28D9" text-anchor="middle">Output: a<tspan font-size="6" baseline-shift="sub">t</tspan></text>

    <!-- Properties -->
    <text x="640" y="565" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#6B7280" text-anchor="middle" font-style="italic">Entropy-regularized control</text>
    <text x="640" y="578" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#6B7280" text-anchor="middle" font-style="italic">Natural gradient via G</text>
  </g>

  <!-- ==================== ACTION DECODER + PROPRIO ENCODER ==================== -->
  <g id="action-decoder">
    <rect x="790" y="850" width="140" height="50" rx="6" ry="6" fill="#DCFCE7" stroke="#22C55E" stroke-width="2"/>
    <text x="860" y="870" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="700" fill="#166534" text-anchor="middle">ACTION DECODER</text>
    <text x="860" y="885" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#16A34A" text-anchor="middle" font-style="italic">D<tspan font-size="6" baseline-shift="sub">A</tspan> (Action Atlas)</text>
  </g>

  <g id="proprio-encoder">
    <rect x="610" y="850" width="150" height="50" rx="6" ry="6" fill="#EFF6FF" stroke="#2563EB" stroke-width="2"/>
    <text x="685" y="870" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="700" fill="#1D4ED8" text-anchor="middle">PROPRIO ENCODER</text>
    <text x="685" y="885" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#3B82F6" text-anchor="middle" font-style="italic">E<tspan font-size="6" baseline-shift="sub">A</tspan> (inverse model)</text>
  </g>

  <!-- ==================== LATENT SPACES PANEL ==================== -->
  <g id="latent-spaces-panel">
    <rect x="980" y="200" width="300" height="210" rx="8" ry="8" fill="#F9FAFB" stroke="#E5E7EB" stroke-width="1.5"/>
    <text x="1130" y="220" font-family="system-ui, -apple-system, sans-serif" font-size="10" font-weight="600" fill="#374151" text-anchor="middle">LATENT SPACES</text>

    <g transform="translate(1000, 235)">
      <rect x="0" y="0" width="260" height="24" rx="4" fill="#ECFDF5" stroke="#10B981" stroke-width="1"/>
      <text x="130" y="16" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#065F46" text-anchor="middle">Physical/Data X (observations)</text>
    </g>
    <g transform="translate(1000, 265)">
      <rect x="0" y="0" width="260" height="24" rx="4" fill="#F3E8FF" stroke="#8B5CF6" stroke-width="1"/>
      <text x="130" y="16" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#6D28D9" text-anchor="middle">Visual Latent Z: (K, z<tspan font-size="6" baseline-shift="sub">n</tspan>, z<tspan font-size="6" baseline-shift="sub">tex</tspan>)</text>
    </g>
    <g transform="translate(1000, 295)">
      <rect x="0" y="0" width="260" height="24" rx="4" fill="#EDE9FE" stroke="#8B5CF6" stroke-width="1"/>
      <text x="130" y="16" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#5B21B6" text-anchor="middle">Motor Latent: (A, z<tspan font-size="6" baseline-shift="sub">n,motor</tspan>, z<tspan font-size="6" baseline-shift="sub">tex,motor</tspan>)</text>
    </g>
    <g transform="translate(1000, 325)">
      <rect x="0" y="0" width="260" height="24" rx="4" fill="#FEF3C7" stroke="#F59E0B" stroke-width="1"/>
      <text x="130" y="16" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#92400E" text-anchor="middle">Context Space C (boundary conditions)</text>
    </g>
    <g transform="translate(1000, 355)">
      <rect x="0" y="0" width="260" height="24" rx="4" fill="#F3F4F6" stroke="#9CA3AF" stroke-width="1"/>
      <text x="130" y="16" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#4B5563" text-anchor="middle">Parameter Manifold Theta (weights)</text>
    </g>
  </g>

  <!-- ==================== ENCODERS / DECODERS PANEL ==================== -->
  <g id="encoders-decoders-panel">
    <rect x="980" y="420" width="300" height="230" rx="8" ry="8" fill="#F9FAFB" stroke="#E5E7EB" stroke-width="1.5"/>
    <text x="1130" y="440" font-family="system-ui, -apple-system, sans-serif" font-size="10" font-weight="600" fill="#374151" text-anchor="middle">ENCODERS / DECODERS</text>

    <g transform="translate(1000, 455)">
      <rect x="0" y="0" width="260" height="36" rx="4" fill="#EFF6FF" stroke="#2563EB" stroke-width="1.5"/>
      <text x="130" y="14" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="600" fill="#1D4ED8" text-anchor="middle">Visual Encoder (E<tspan font-size="6" baseline-shift="sub">phi</tspan>)</text>
      <text x="130" y="28" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#3B82F6" text-anchor="middle" font-style="italic">Attentive Atlas (detailed left)</text>
    </g>
    <g transform="translate(1000, 500)">
      <rect x="0" y="0" width="260" height="36" rx="4" fill="#DCFCE7" stroke="#22C55E" stroke-width="1.5"/>
      <text x="130" y="14" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="600" fill="#166534" text-anchor="middle">Visual Decoder</text>
      <text x="130" y="28" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#16A34A" text-anchor="middle" font-style="italic">Topological (Inverse Atlas)</text>
    </g>
    <g transform="translate(1000, 545)">
      <rect x="0" y="0" width="260" height="36" rx="4" fill="#DCFCE7" stroke="#22C55E" stroke-width="1.5"/>
      <text x="130" y="14" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="600" fill="#166534" text-anchor="middle">Action Decoder (D<tspan font-size="6" baseline-shift="sub">A</tspan>)</text>
      <text x="130" y="28" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#16A34A" text-anchor="middle" font-style="italic">Action Atlas / Neumann BC</text>
    </g>
    <g transform="translate(1000, 590)">
      <rect x="0" y="0" width="260" height="36" rx="4" fill="#EFF6FF" stroke="#2563EB" stroke-width="1.5"/>
      <text x="130" y="14" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="600" fill="#1D4ED8" text-anchor="middle">Proprioception Encoder (E<tspan font-size="6" baseline-shift="sub">A</tspan>)</text>
      <text x="130" y="28" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#3B82F6" text-anchor="middle" font-style="italic">Inverse Model</text>
    </g>
  </g>

  <!-- ==================== DATA FLOW ARROWS ==================== -->

  <!-- Observation flow: Environment -> Encoder (Blue) -->
  <g id="flow-observation">
    <path d="M130 380 L200 380" fill="none" stroke="#3B82F6" stroke-width="2" marker-end="url(#arrow-observation)"/>
    <text x="165" y="372" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#3B82F6" text-anchor="middle">x</text>
    <text x="172" y="375" font-family="system-ui, -apple-system, sans-serif" font-size="6" fill="#3B82F6">t</text>
  </g>

  <!-- Encoder to Visual Latent (Green) -->
  <g id="flow-encoder-to-hub">
    <path d="M370 480 L370 500 L550 500 L550 510" fill="none" stroke="#10B981" stroke-width="2" marker-end="url(#arrow-latent)"/>
  </g>

  <!-- Latent to World Model (Green) -->
  <g id="flow-latent-to-world">
    <path d="M750 560 L770 560 L770 300 L760 300" fill="none" stroke="#10B981" stroke-width="1.5" marker-end="url(#arrow-latent)"/>
    <text x="690" y="495" font-family="system-ui, -apple-system, sans-serif" font-size="7" fill="#10B981">K, z<tspan font-size="5" baseline-shift="sub">n</tspan></text>
  </g>

  <!-- Latent to Critic (Green) -->
  <g id="flow-latent-to-critic">
    <path d="M750 530 L760 530" fill="none" stroke="#10B981" stroke-width="1.5" marker-end="url(#arrow-latent)"/>
  </g>

  <!-- Latent to Policy (Green) -->
  <g id="flow-latent-to-policy">
    <path d="M750 610 L760 610" fill="none" stroke="#10B981" stroke-width="1.5" marker-end="url(#arrow-latent)"/>
  </g>

  <!-- Latent to Decoder (Green) -->
  <g id="flow-latent-to-decoder">
    <path d="M550 630 L550 690 L275 690 L275 720" fill="none" stroke="#10B981" stroke-width="1.5" marker-end="url(#arrow-latent)"/>
    <text x="500" y="682" font-family="system-ui, -apple-system, sans-serif" font-size="7" fill="#10B981">z<tspan font-size="5" baseline-shift="sub">geo</tspan></text>
  </g>

  <!-- z_tex to Decoder (Gray dashed) -->
  <g id="flow-ztex-to-decoder">
    <path d="M708 580 L708 760 L350 760" fill="none" stroke="#9CA3AF" stroke-width="1.5" stroke-dasharray="4,3" marker-end="url(#arrow-monitor)"/>
    <text x="640" y="752" font-family="system-ui, -apple-system, sans-serif" font-size="7" fill="#9CA3AF">z<tspan font-size="5" baseline-shift="sub">tex</tspan></text>
  </g>

  <!-- World Model to Policy (Green) -->
  <g id="flow-world-to-policy">
    <path d="M860 350 L975 350 L975 675 L960 675" fill="none" stroke="#10B981" stroke-width="1.5" marker-end="url(#arrow-latent)"/>
    <text x="910" y="342" font-family="system-ui, -apple-system, sans-serif" font-size="7" fill="#10B981">predictions</text>
  </g>

  <!-- Critic to Policy (Amber) -->
  <g id="flow-critic-to-policy">
    <path d="M860 550 L860 610" fill="none" stroke="#F59E0B" stroke-width="2" marker-end="url(#arrow-reward)"/>
    <text x="872" y="585" font-family="system-ui, -apple-system, sans-serif" font-size="7" fill="#F59E0B">V, nabla V</text>
  </g>

  <!-- Environment reward to Critic (Amber) -->
  <g id="flow-reward">
    <path d="M130 424 L160 424 L160 820 L740 820 L740 500 L760 500" fill="none" stroke="#F59E0B" stroke-width="2" marker-end="url(#arrow-reward)"/>
    <text x="450" y="812" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#F59E0B">r</text>
    <text x="457" y="815" font-family="system-ui, -apple-system, sans-serif" font-size="6" fill="#F59E0B">t</text>
  </g>

  <!-- Policy to Action Decoder (Purple) -->
  <g id="flow-policy-to-action-decoder">
    <path d="M860 740 L860 750" fill="none" stroke="#8B5CF6" stroke-width="2" marker-end="url(#arrow-action)"/>
  </g>

  <!-- Motor Latent to Action Decoder (Purple) -->
  <g id="flow-motor-to-action-decoder">
    <path d="M860 840 L860 850" fill="none" stroke="#8B5CF6" stroke-width="2" marker-end="url(#arrow-action)"/>
  </g>

  <!-- Policy to Environment (Purple) -->
  <g id="flow-action">
    <path d="M860 900 L860 930 L150 930 L150 504 L130 504" fill="none" stroke="#8B5CF6" stroke-width="2" marker-end="url(#arrow-action)"/>
    <text x="500" y="942" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#8B5CF6">a</text>
    <text x="507" y="945" font-family="system-ui, -apple-system, sans-serif" font-size="6" fill="#8B5CF6">t</text>
  </g>

  <!-- Action feedback to Proprio Encoder (Blue) -->
  <g id="flow-action-to-proprio">
    <path d="M790 875 L760 875" fill="none" stroke="#3B82F6" stroke-width="1.5" marker-end="url(#arrow-observation)"/>
  </g>

  <!-- Proprio Encoder to Motor Latent (Green) -->
  <g id="flow-proprio-to-latent">
    <path d="M760 875 L760 800" fill="none" stroke="#10B981" stroke-width="1.5" marker-end="url(#arrow-latent)"/>
  </g>

  <!-- Memory connections (dashed amber) -->
  <g id="flow-memory">
    <!-- From visual latent to memory -->
    <path d="M650 510 L720 510 L720 185" fill="none" stroke="#F59E0B" stroke-width="1" stroke-dasharray="4,3" marker-end="url(#arrow-monitor)"/>

    <!-- From memory to world model -->
    <path d="M860 185 L860 220" fill="none" stroke="#F59E0B" stroke-width="1" stroke-dasharray="4,3" marker-end="url(#arrow-monitor)"/>

    <!-- From memory to policy -->
    <path d="M965 185 L965 700 L960 700" fill="none" stroke="#F59E0B" stroke-width="1" stroke-dasharray="4,3" marker-end="url(#arrow-monitor)"/>
  </g>

  <!-- Governor monitoring (gray dashed) -->
  <g id="flow-governor">
    <path d="M1220 100 L1220 120" fill="none" stroke="#6B7280" stroke-width="1" stroke-dasharray="3,2"/>
    <path d="M1220 100 L1120 100 L1120 120" fill="none" stroke="#6B7280" stroke-width="1" stroke-dasharray="3,2"/>
    <path d="M1220 100 L1020 100 L1020 120" fill="none" stroke="#6B7280" stroke-width="1" stroke-dasharray="3,2"/>
  </g>

  <!-- ==================== LEGEND ==================== -->
  <g id="legend" transform="translate(1060, 670)">
    <rect x="0" y="0" width="190" height="155" rx="6" ry="6" fill="#FAFAFA" stroke="#E5E7EB" stroke-width="1.5"/>
    <text x="95" y="18" font-family="system-ui, -apple-system, sans-serif" font-size="10" font-weight="600" fill="#374151" text-anchor="middle">SIGNAL TYPES</text>

    <!-- Observation/Perception (Blue) -->
    <line x1="15" y1="38" x2="50" y2="38" stroke="#3B82F6" stroke-width="2" marker-end="url(#arrow-observation)"/>
    <text x="60" y="42" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#374151">Observation flow</text>

    <!-- Latent State (Green) -->
    <line x1="15" y1="58" x2="50" y2="58" stroke="#10B981" stroke-width="2" marker-end="url(#arrow-latent)"/>
    <text x="60" y="62" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#374151">Latent state flow</text>

    <!-- Reward/Value (Amber) -->
    <line x1="15" y1="78" x2="50" y2="78" stroke="#F59E0B" stroke-width="2" marker-end="url(#arrow-reward)"/>
    <text x="60" y="82" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#374151">Reward / value flow</text>

    <!-- Action/Control (Purple) -->
    <line x1="15" y1="98" x2="50" y2="98" stroke="#8B5CF6" stroke-width="2" marker-end="url(#arrow-action)"/>
    <text x="60" y="102" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#374151">Action / control flow</text>

    <!-- Monitoring (Gray dashed) -->
    <line x1="15" y1="118" x2="50" y2="118" stroke="#6B7280" stroke-width="1.5" stroke-dasharray="4,3"/>
    <text x="60" y="122" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#374151">Monitor / memory</text>

    <!-- Firewall -->
    <line x1="15" y1="138" x2="50" y2="138" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2"/>
    <text x="60" y="142" font-family="system-ui, -apple-system, sans-serif" font-size="9" fill="#374151">Firewall (z<tspan font-size="6" baseline-shift="sub">tex</tspan> separation)</text>
  </g>

  <!-- ==================== ANNOTATION: Agent Tuple ==================== -->
  <g id="agent-tuple" transform="translate(1060, 840)">
    <rect x="0" y="0" width="190" height="40" rx="4" ry="4" fill="#F9FAFB" stroke="#D1D5DB" stroke-width="1"/>
    <text x="95" y="17" font-family="system-ui, -apple-system, sans-serif" font-size="9" font-weight="600" fill="#374151" text-anchor="middle">Agent Tuple A:</text>
    <text x="95" y="32" font-family="system-ui, -apple-system, sans-serif" font-size="8" fill="#6B7280" text-anchor="middle" font-style="italic">(Shutter, World, Critic, Policy)</text>
  </g>

</svg>
