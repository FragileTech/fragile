{
  "chapter_index": 7,
  "section_id": "## 7. Fourth Derivative of the Z-Score",
  "directive_count": 2,
  "hints": [
    {
      "directive_type": "lemma",
      "label": "lem-zscore-fourth-derivative",
      "title": "Fourth Derivative of Z-Score",
      "start_line": 733,
      "end_line": 744,
      "header_lines": [
        734
      ],
      "content_start": 736,
      "content_end": 743,
      "content": "736: :label: lem-zscore-fourth-derivative\n737: \n738: The Z-score $Z_\\rho[f_k, d, x_i] = \\frac{d(x_i) - \\mu_\\rho[f_k, d, x_i]}{\\sigma'_{\\text{reg}}(\\sigma^2_\\rho[f_k, d, x_i])}$ satisfies:\n739: \n740: $$\n741: \\|\\nabla^4_{x_i} Z_\\rho\\| \\le K_{Z,4}(\\rho) = O(\\rho^{-3})\n742: \n743: $$",
      "metadata": {
        "label": "lem-zscore-fourth-derivative"
      },
      "section": "## 7. Fourth Derivative of the Z-Score",
      "references": [],
      "raw_directive": "733: ## 7. Fourth Derivative of the Z-Score\n734: \n735: :::{prf:lemma} Fourth Derivative of Z-Score\n736: :label: lem-zscore-fourth-derivative\n737: \n738: The Z-score $Z_\\rho[f_k, d, x_i] = \\frac{d(x_i) - \\mu_\\rho[f_k, d, x_i]}{\\sigma'_{\\text{reg}}(\\sigma^2_\\rho[f_k, d, x_i])}$ satisfies:\n739: \n740: $$\n741: \\|\\nabla^4_{x_i} Z_\\rho\\| \\le K_{Z,4}(\\rho) = O(\\rho^{-3})\n742: \n743: $$\n744: "
    },
    {
      "directive_type": "proof",
      "label": "proof-lem-zscore-fourth-derivative",
      "title": null,
      "start_line": 746,
      "end_line": 855,
      "header_lines": [
        747
      ],
      "content_start": 749,
      "content_end": 854,
      "content": "749: :label: proof-lem-zscore-fourth-derivative\n750: \n751: **Step 1: Set up quotient.** Write $Z_\\rho = N/D$ where:\n752: - $N = d(x_i) - \\mu_\\rho$ (numerator)\n753: - $D = \\sigma'_{\\text{reg}}(\\sigma^2_\\rho)$ (denominator)\n754: \n755: **Step 2: Apply Leibniz product rule to $Z_\\rho = N \\cdot D^{-1}$.** Rather than expanding the full quotient rule, we use the systematic approach of treating the quotient as a product:\n756: \n757: $$\n758: \\nabla^4 Z_\\rho = \\nabla^4(N \\cdot D^{-1}) = \\sum_{\\ell=0}^{4} \\binom{4}{\\ell} \\nabla^\\ell N \\cdot \\nabla^{4-\\ell}(D^{-1})\n759: \n760: $$\n761: \n762: This gives **5 terms** corresponding to $\\ell = 0, 1, 2, 3, 4$.\n763: \n764: **Step 2a: Compute derivatives of $D^{-1}$ using Fa\u00e0 di Bruno.** For $h(x) = D(x)^{-1}$, apply the chain rule with $g(y) = y^{-1}$:\n765: \n766: $$\n767: \\begin{align}\n768: \\nabla(D^{-1}) &= g'(D) \\cdot \\nabla D = -D^{-2} \\nabla D \\\\\n769: \\nabla^2(D^{-1}) &= g''(D) \\cdot (\\nabla D)^2 + g'(D) \\cdot \\nabla^2 D = 2D^{-3}(\\nabla D)^2 - D^{-2} \\nabla^2 D \\\\\n770: \\nabla^3(D^{-1}) &= g'''(D) \\cdot (\\nabla D)^3 + 3g''(D) \\cdot (\\nabla D)(\\nabla^2 D) + g'(D) \\cdot \\nabla^3 D \\\\\n771: &= -6D^{-4}(\\nabla D)^3 + 6D^{-3}(\\nabla D)(\\nabla^2 D) - D^{-2} \\nabla^3 D \\\\\n772: \\nabla^4(D^{-1}) &= g^{(4)}(D) \\cdot (\\nabla D)^4 + 6g'''(D) \\cdot (\\nabla D)^2(\\nabla^2 D) + 3g''(D) \\cdot (\\nabla^2 D)^2 \\\\\n773: &\\quad + 4g''(D) \\cdot (\\nabla D)(\\nabla^3 D) + g'(D) \\cdot \\nabla^4 D \\\\\n774: &= 24D^{-5}(\\nabla D)^4 - 36D^{-4}(\\nabla D)^2(\\nabla^2 D) + 6D^{-3}(\\nabla^2 D)^2 \\\\\n775: &\\quad + 8D^{-3}(\\nabla D)(\\nabla^3 D) - D^{-2} \\nabla^4 D\n776: \\end{align}\n777: \n778: $$\n779: \n780: where we used $g'(y) = -y^{-2}$, $g''(y) = 2y^{-3}$, $g'''(y) = -6y^{-4}$, $g^{(4)}(y) = 24y^{-5}$.\n781: \n782: **Step 2b: Expand the Leibniz sum.** Substituting the five terms:\n783: \n784: $$\n785: \\begin{align}\n786: \\nabla^4 Z_\\rho = \\,&\\binom{4}{0} N \\cdot \\nabla^4(D^{-1}) + \\binom{4}{1} (\\nabla N) \\cdot \\nabla^3(D^{-1}) + \\binom{4}{2} (\\nabla^2 N) \\cdot \\nabla^2(D^{-1}) \\\\\n787: &+ \\binom{4}{3} (\\nabla^3 N) \\cdot \\nabla(D^{-1}) + \\binom{4}{4} (\\nabla^4 N) \\cdot D^{-1}\n788: \\end{align}\n789: \n790: $$\n791: \n792: Each term can be bounded directly using the bounds on $N$ and $D$ derivatives established in Steps 3-4 below. The full expansion into elementary terms (12 total) is not needed for the bound\u2014we work with the 5 Leibniz terms directly.\n793: \n794: **Step 3: Bound numerator derivatives.** For $m = 0, 1, 2, 3, 4$:\n795: \n796: $$\n797: \\|\\nabla^m N\\| = \\|\\nabla^m(d(x_i) - \\mu_\\rho)\\| \\le \\|\\nabla^m d(x_i)\\| + \\|\\nabla^m \\mu_\\rho\\| \\le d^{(m)}_{\\max} + C_{\\mu,\\nabla^m}(\\rho)\n798: \n799: $$\n800: \n801: From Lemma {prf:ref}`lem-mean-fourth-derivative`, the centered moment structure gives the **corrected scaling**: $C_{\\mu,\\nabla^m}(\\rho) = O(\\rho^{-(m-1)})$ for $m \\ge 1$ (i.e., $C_{\\mu,\\nabla^1} = O(1)$, $C_{\\mu,\\nabla^2} = O(\\rho^{-1})$, $C_{\\mu,\\nabla^3} = O(\\rho^{-2})$, $C_{\\mu,\\nabla^4} = O(\\rho^{-3})$).\n802: \n803: **Step 4: Bound denominator derivatives.** From Lemma {prf:ref}`lem-reg-fourth-chain` and Lemma {prf:ref}`lem-variance-fourth-derivative`, using $C_{V,\\nabla^m}(\\rho) = O(\\rho^{-(m-1)})$:\n804: \n805: $$\n806: \\begin{align}\n807: D &\\ge \\sigma'_{\\min} > 0 \\\\\n808: \\|\\nabla D\\| &\\le L_{\\sigma'_{\\text{reg}}} \\cdot C_{V,\\nabla^1}(\\rho) = \\frac{1}{2\\sigma'_{\\min}} C_{V,\\nabla^1}(\\rho) = O(1) \\\\\n809: \\|\\nabla^2 D\\| &\\le \\text{(bound from chain rule)} = O(\\rho^{-1}) \\\\\n810: \\|\\nabla^3 D\\| &\\le O(\\rho^{-2}) \\\\\n811: \\|\\nabla^4 D\\| &\\le O(\\rho^{-3})\n812: \\end{align}\n813: \n814: $$\n815: \n816: Note the **corrected scaling**: each derivative of $D$ is one order better than the naive $O(\\rho^{-m})$ due to variance having $C_{V,\\nabla^m} = O(\\rho^{-(m-1)})$.\n817: \n818: **Step 5: Bound each of the 5 Leibniz terms.** Using the bounds from Steps 3-4:\n819: \n820: **Term 1** ($\\ell = 4$): $\\|\\nabla^4 N \\cdot D^{-1}\\| \\le \\frac{1}{\\sigma'_{\\min}} (d^{(4)}_{\\max} + C_{\\mu,\\nabla^4}(\\rho)) = O(\\rho^{-3})$\n821: \n822: **Term 2** ($\\ell = 3$): $\\|4 (\\nabla^3 N) \\cdot \\nabla(D^{-1})\\|$\n823:    - $\\|\\nabla(D^{-1})\\| \\le D^{-2} \\|\\nabla D\\| + D^{-2} \\|\\nabla D\\| = O(1/\\sigma'^2_{\\min})$ (using $\\|\\nabla D\\| = O(1)$)\n824:    - Bound: $4 (d^{(3)}_{\\max} + C_{\\mu,\\nabla^3}(\\rho)) \\cdot O(1) = O(\\rho^{-2})$\n825: \n826: **Term 3** ($\\ell = 2$): $\\|6 (\\nabla^2 N) \\cdot \\nabla^2(D^{-1})\\|$\n827:    - $\\|\\nabla^2(D^{-1})\\| \\le 2D^{-3}(\\|\\nabla D\\|)^2 + D^{-2}\\|\\nabla^2 D\\| = O(1) + O(\\rho^{-1}) = O(\\rho^{-1})$\n828:    - Bound: $6 (d^{(2)}_{\\max} + C_{\\mu,\\nabla^2}(\\rho)) \\cdot O(\\rho^{-1}) = O(\\rho^{-2})$\n829: \n830: **Term 4** ($\\ell = 1$): $\\|4 (\\nabla N) \\cdot \\nabla^3(D^{-1})\\|$\n831:    - $\\|\\nabla^3(D^{-1})\\|$ has terms involving $D^{-4}(\\nabla D)^3$, $D^{-3}(\\nabla D)(\\nabla^2 D)$, $D^{-2}\\nabla^3 D$\n832:    - Dominant scaling: $O(\\rho^{-2})$ (from $D^{-2}\\nabla^3 D$ term)\n833:    - Bound: $4 (d'_{\\max} + C_{\\mu,\\nabla^1}(\\rho)) \\cdot O(\\rho^{-2}) = O(\\rho^{-2})$\n834: \n835: **Term 5** ($\\ell = 0$): $\\|N \\cdot \\nabla^4(D^{-1})\\|$\n836:    - $\\|\\nabla^4(D^{-1})\\|$ has terms involving up to $D^{-5}(\\nabla D)^4$ and $D^{-2}\\nabla^4 D$\n837:    - Dominant scaling: $O(\\rho^{-3})$ (from $D^{-2}\\nabla^4 D$ term)\n838:    - $|N| \\le |d(x_i)| + |\\mu_\\rho| \\le 2d_{\\max}$ (bounded measurement range)\n839:    - Bound: $2d_{\\max} \\cdot O(\\rho^{-3}) = O(\\rho^{-3})$\n840: \n841: **Step 6: Determine dominant scaling.** Using the corrected scaling $C_{\\mu,\\nabla^m}(\\rho) = O(\\rho^{-(m-1)})$ for $m \\ge 1$, the five terms scale as:\n842: \n843: 1. Term 1: $O(\\rho^{-3})$ (from $C_{\\mu,\\nabla^4}$)\n844: 2. Term 2: $O(\\rho^{-2})$\n845: 3. Term 3: $O(\\rho^{-2})$\n846: 4. Term 4: $O(\\rho^{-2})$\n847: 5. Term 5: $O(\\rho^{-3})$\n848: \n849: The **dominant scaling** is $O(\\rho^{-3})$ from Terms 1 and 5. Therefore:\n850: \n851: $$\n852: \\boxed{K_{Z,4}(\\rho) = O(\\rho^{-3})}\n853: \n854: $$",
      "metadata": {
        "label": "proof-lem-zscore-fourth-derivative"
      },
      "section": "## 7. Fourth Derivative of the Z-Score",
      "references": [
        "lem-mean-fourth-derivative",
        "lem-reg-fourth-chain",
        "lem-variance-fourth-derivative"
      ],
      "raw_directive": "746: :::\n747: \n748: :::{prf:proof}\n749: :label: proof-lem-zscore-fourth-derivative\n750: \n751: **Step 1: Set up quotient.** Write $Z_\\rho = N/D$ where:\n752: - $N = d(x_i) - \\mu_\\rho$ (numerator)\n753: - $D = \\sigma'_{\\text{reg}}(\\sigma^2_\\rho)$ (denominator)\n754: \n755: **Step 2: Apply Leibniz product rule to $Z_\\rho = N \\cdot D^{-1}$.** Rather than expanding the full quotient rule, we use the systematic approach of treating the quotient as a product:\n756: \n757: $$\n758: \\nabla^4 Z_\\rho = \\nabla^4(N \\cdot D^{-1}) = \\sum_{\\ell=0}^{4} \\binom{4}{\\ell} \\nabla^\\ell N \\cdot \\nabla^{4-\\ell}(D^{-1})\n759: \n760: $$\n761: \n762: This gives **5 terms** corresponding to $\\ell = 0, 1, 2, 3, 4$.\n763: \n764: **Step 2a: Compute derivatives of $D^{-1}$ using Fa\u00e0 di Bruno.** For $h(x) = D(x)^{-1}$, apply the chain rule with $g(y) = y^{-1}$:\n765: \n766: $$\n767: \\begin{align}\n768: \\nabla(D^{-1}) &= g'(D) \\cdot \\nabla D = -D^{-2} \\nabla D \\\\\n769: \\nabla^2(D^{-1}) &= g''(D) \\cdot (\\nabla D)^2 + g'(D) \\cdot \\nabla^2 D = 2D^{-3}(\\nabla D)^2 - D^{-2} \\nabla^2 D \\\\\n770: \\nabla^3(D^{-1}) &= g'''(D) \\cdot (\\nabla D)^3 + 3g''(D) \\cdot (\\nabla D)(\\nabla^2 D) + g'(D) \\cdot \\nabla^3 D \\\\\n771: &= -6D^{-4}(\\nabla D)^3 + 6D^{-3}(\\nabla D)(\\nabla^2 D) - D^{-2} \\nabla^3 D \\\\\n772: \\nabla^4(D^{-1}) &= g^{(4)}(D) \\cdot (\\nabla D)^4 + 6g'''(D) \\cdot (\\nabla D)^2(\\nabla^2 D) + 3g''(D) \\cdot (\\nabla^2 D)^2 \\\\\n773: &\\quad + 4g''(D) \\cdot (\\nabla D)(\\nabla^3 D) + g'(D) \\cdot \\nabla^4 D \\\\\n774: &= 24D^{-5}(\\nabla D)^4 - 36D^{-4}(\\nabla D)^2(\\nabla^2 D) + 6D^{-3}(\\nabla^2 D)^2 \\\\\n775: &\\quad + 8D^{-3}(\\nabla D)(\\nabla^3 D) - D^{-2} \\nabla^4 D\n776: \\end{align}\n777: \n778: $$\n779: \n780: where we used $g'(y) = -y^{-2}$, $g''(y) = 2y^{-3}$, $g'''(y) = -6y^{-4}$, $g^{(4)}(y) = 24y^{-5}$.\n781: \n782: **Step 2b: Expand the Leibniz sum.** Substituting the five terms:\n783: \n784: $$\n785: \\begin{align}\n786: \\nabla^4 Z_\\rho = \\,&\\binom{4}{0} N \\cdot \\nabla^4(D^{-1}) + \\binom{4}{1} (\\nabla N) \\cdot \\nabla^3(D^{-1}) + \\binom{4}{2} (\\nabla^2 N) \\cdot \\nabla^2(D^{-1}) \\\\\n787: &+ \\binom{4}{3} (\\nabla^3 N) \\cdot \\nabla(D^{-1}) + \\binom{4}{4} (\\nabla^4 N) \\cdot D^{-1}\n788: \\end{align}\n789: \n790: $$\n791: \n792: Each term can be bounded directly using the bounds on $N$ and $D$ derivatives established in Steps 3-4 below. The full expansion into elementary terms (12 total) is not needed for the bound\u2014we work with the 5 Leibniz terms directly.\n793: \n794: **Step 3: Bound numerator derivatives.** For $m = 0, 1, 2, 3, 4$:\n795: \n796: $$\n797: \\|\\nabla^m N\\| = \\|\\nabla^m(d(x_i) - \\mu_\\rho)\\| \\le \\|\\nabla^m d(x_i)\\| + \\|\\nabla^m \\mu_\\rho\\| \\le d^{(m)}_{\\max} + C_{\\mu,\\nabla^m}(\\rho)\n798: \n799: $$\n800: \n801: From Lemma {prf:ref}`lem-mean-fourth-derivative`, the centered moment structure gives the **corrected scaling**: $C_{\\mu,\\nabla^m}(\\rho) = O(\\rho^{-(m-1)})$ for $m \\ge 1$ (i.e., $C_{\\mu,\\nabla^1} = O(1)$, $C_{\\mu,\\nabla^2} = O(\\rho^{-1})$, $C_{\\mu,\\nabla^3} = O(\\rho^{-2})$, $C_{\\mu,\\nabla^4} = O(\\rho^{-3})$).\n802: \n803: **Step 4: Bound denominator derivatives.** From Lemma {prf:ref}`lem-reg-fourth-chain` and Lemma {prf:ref}`lem-variance-fourth-derivative`, using $C_{V,\\nabla^m}(\\rho) = O(\\rho^{-(m-1)})$:\n804: \n805: $$\n806: \\begin{align}\n807: D &\\ge \\sigma'_{\\min} > 0 \\\\\n808: \\|\\nabla D\\| &\\le L_{\\sigma'_{\\text{reg}}} \\cdot C_{V,\\nabla^1}(\\rho) = \\frac{1}{2\\sigma'_{\\min}} C_{V,\\nabla^1}(\\rho) = O(1) \\\\\n809: \\|\\nabla^2 D\\| &\\le \\text{(bound from chain rule)} = O(\\rho^{-1}) \\\\\n810: \\|\\nabla^3 D\\| &\\le O(\\rho^{-2}) \\\\\n811: \\|\\nabla^4 D\\| &\\le O(\\rho^{-3})\n812: \\end{align}\n813: \n814: $$\n815: \n816: Note the **corrected scaling**: each derivative of $D$ is one order better than the naive $O(\\rho^{-m})$ due to variance having $C_{V,\\nabla^m} = O(\\rho^{-(m-1)})$.\n817: \n818: **Step 5: Bound each of the 5 Leibniz terms.** Using the bounds from Steps 3-4:\n819: \n820: **Term 1** ($\\ell = 4$): $\\|\\nabla^4 N \\cdot D^{-1}\\| \\le \\frac{1}{\\sigma'_{\\min}} (d^{(4)}_{\\max} + C_{\\mu,\\nabla^4}(\\rho)) = O(\\rho^{-3})$\n821: \n822: **Term 2** ($\\ell = 3$): $\\|4 (\\nabla^3 N) \\cdot \\nabla(D^{-1})\\|$\n823:    - $\\|\\nabla(D^{-1})\\| \\le D^{-2} \\|\\nabla D\\| + D^{-2} \\|\\nabla D\\| = O(1/\\sigma'^2_{\\min})$ (using $\\|\\nabla D\\| = O(1)$)\n824:    - Bound: $4 (d^{(3)}_{\\max} + C_{\\mu,\\nabla^3}(\\rho)) \\cdot O(1) = O(\\rho^{-2})$\n825: \n826: **Term 3** ($\\ell = 2$): $\\|6 (\\nabla^2 N) \\cdot \\nabla^2(D^{-1})\\|$\n827:    - $\\|\\nabla^2(D^{-1})\\| \\le 2D^{-3}(\\|\\nabla D\\|)^2 + D^{-2}\\|\\nabla^2 D\\| = O(1) + O(\\rho^{-1}) = O(\\rho^{-1})$\n828:    - Bound: $6 (d^{(2)}_{\\max} + C_{\\mu,\\nabla^2}(\\rho)) \\cdot O(\\rho^{-1}) = O(\\rho^{-2})$\n829: \n830: **Term 4** ($\\ell = 1$): $\\|4 (\\nabla N) \\cdot \\nabla^3(D^{-1})\\|$\n831:    - $\\|\\nabla^3(D^{-1})\\|$ has terms involving $D^{-4}(\\nabla D)^3$, $D^{-3}(\\nabla D)(\\nabla^2 D)$, $D^{-2}\\nabla^3 D$\n832:    - Dominant scaling: $O(\\rho^{-2})$ (from $D^{-2}\\nabla^3 D$ term)\n833:    - Bound: $4 (d'_{\\max} + C_{\\mu,\\nabla^1}(\\rho)) \\cdot O(\\rho^{-2}) = O(\\rho^{-2})$\n834: \n835: **Term 5** ($\\ell = 0$): $\\|N \\cdot \\nabla^4(D^{-1})\\|$\n836:    - $\\|\\nabla^4(D^{-1})\\|$ has terms involving up to $D^{-5}(\\nabla D)^4$ and $D^{-2}\\nabla^4 D$\n837:    - Dominant scaling: $O(\\rho^{-3})$ (from $D^{-2}\\nabla^4 D$ term)\n838:    - $|N| \\le |d(x_i)| + |\\mu_\\rho| \\le 2d_{\\max}$ (bounded measurement range)\n839:    - Bound: $2d_{\\max} \\cdot O(\\rho^{-3}) = O(\\rho^{-3})$\n840: \n841: **Step 6: Determine dominant scaling.** Using the corrected scaling $C_{\\mu,\\nabla^m}(\\rho) = O(\\rho^{-(m-1)})$ for $m \\ge 1$, the five terms scale as:\n842: \n843: 1. Term 1: $O(\\rho^{-3})$ (from $C_{\\mu,\\nabla^4}$)\n844: 2. Term 2: $O(\\rho^{-2})$\n845: 3. Term 3: $O(\\rho^{-2})$\n846: 4. Term 4: $O(\\rho^{-2})$\n847: 5. Term 5: $O(\\rho^{-3})$\n848: \n849: The **dominant scaling** is $O(\\rho^{-3})$ from Terms 1 and 5. Therefore:\n850: \n851: $$\n852: \\boxed{K_{Z,4}(\\rho) = O(\\rho^{-3})}\n853: \n854: $$\n855: "
    }
  ],
  "validation": {
    "ok": true,
    "errors": []
  }
}