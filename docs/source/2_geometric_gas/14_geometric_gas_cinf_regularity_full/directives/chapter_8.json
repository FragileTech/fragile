{
  "chapter_index": 8,
  "section_id": "## 5.5 Companion-Dependent Measurements with Softmax Coupling",
  "directive_count": 6,
  "hints": [
    {
      "directive_type": "lemma",
      "label": "lem-companion-measurement-derivatives-full",
      "title": "Derivatives of Companion-Dependent Measurements",
      "start_line": 1806,
      "end_line": 1826,
      "header_lines": [
        1807
      ],
      "content_start": 1809,
      "content_end": 1825,
      "content": "1809: :label: lem-companion-measurement-derivatives-full\n1810: \n1811: For any walker $i \\in \\mathcal{A}$ (taking derivatives with respect to $x_i$), the companion-dependent measurement for walker $j \\neq i$ satisfies:\n1812: \n1813: $$\n1814: \\|\\nabla^n_{x_i} d_j\\| \\leq C_{d_j,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n})\n1815: \n1816: $$\n1817: \n1818: where $C_{d_j,n} = \\mathcal{O}(n!)$ (Gevrey-1) is **k-uniform** (independent of the number of alive walkers).\n1819: \n1820: **For typical parameters** where $\\varepsilon_d \\ll \\varepsilon_c$ and $n \\geq 2$, this simplifies to:\n1821: \n1822: $$\n1823: \\|\\nabla^n_{x_i} d_j\\| \\leq C_{d_j,n} \\cdot \\varepsilon_d^{1-n}\n1824: \n1825: $$",
      "metadata": {
        "label": "lem-companion-measurement-derivatives-full"
      },
      "section": "## 5.5 Companion-Dependent Measurements with Softmax Coupling",
      "references": [],
      "raw_directive": "1806: ### 5.5.2 High-Order Derivatives via Fa\u00e0 di Bruno Formula\n1807: \n1808: :::{prf:lemma} Derivatives of Companion-Dependent Measurements\n1809: :label: lem-companion-measurement-derivatives-full\n1810: \n1811: For any walker $i \\in \\mathcal{A}$ (taking derivatives with respect to $x_i$), the companion-dependent measurement for walker $j \\neq i$ satisfies:\n1812: \n1813: $$\n1814: \\|\\nabla^n_{x_i} d_j\\| \\leq C_{d_j,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n})\n1815: \n1816: $$\n1817: \n1818: where $C_{d_j,n} = \\mathcal{O}(n!)$ (Gevrey-1) is **k-uniform** (independent of the number of alive walkers).\n1819: \n1820: **For typical parameters** where $\\varepsilon_d \\ll \\varepsilon_c$ and $n \\geq 2$, this simplifies to:\n1821: \n1822: $$\n1823: \\|\\nabla^n_{x_i} d_j\\| \\leq C_{d_j,n} \\cdot \\varepsilon_d^{1-n}\n1824: \n1825: $$\n1826: "
    },
    {
      "directive_type": "proof",
      "label": "proof-lem-companion-measurement-derivatives-full",
      "title": null,
      "start_line": 1828,
      "end_line": 1849,
      "header_lines": [
        1829
      ],
      "content_start": 1832,
      "content_end": 1848,
      "content": "1832: \n1833: :::{note}\n1834: **Derivative Structure Preview**: The companion-dependent measurement has the structure:\n1835: \n1836: $$\n1837: d_j = \\frac{N_j}{Z_j} = \\frac{\\sum_{\\ell} d_{\\text{alg}}(j,\\ell) \\cdot e^{-d_{\\text{alg}}^2(j,\\ell)/(2\\varepsilon_c^2)}}{\\sum_{\\ell} e^{-d_{\\text{alg}}^2(j,\\ell)/(2\\varepsilon_c^2)}}\n1838: \n1839: $$\n1840: \n1841: This is a **quotient of weighted sums**, leading to high complexity. The n-th derivative involves:\n1842: \n1843: 1. **Leibniz rule** for products: $d_{\\text{alg}} \\cdot \\exp(\\cdots)$\n1844: 2. **Fa\u00e0 di Bruno** for exponential: $\\exp(-d_{\\text{alg}}^2/(2\\varepsilon_c^2))$\n1845: 3. **Quotient rule** for $N_j / Z_j$ (introduces additional partitions)\n1846: 4. **Sum over companions**: Each term has exponential decay, ensuring k-uniformity\n1847: \n1848: **Key challenge**: Tracking which scale dominates\u2014$\\varepsilon_d^{1-n}$ (from $d_{\\text{alg}}$ derivatives) vs $\\varepsilon_c^{-n}$ (from exponential kernel derivatives).",
      "metadata": {
        "label": "proof-lem-companion-measurement-derivatives-full"
      },
      "section": "## 5.5 Companion-Dependent Measurements with Softmax Coupling",
      "references": [],
      "raw_directive": "1828: :::\n1829: \n1830: :::{prf:proof}\n1831: :label: proof-lem-companion-measurement-derivatives-full\n1832: \n1833: :::{note}\n1834: **Derivative Structure Preview**: The companion-dependent measurement has the structure:\n1835: \n1836: $$\n1837: d_j = \\frac{N_j}{Z_j} = \\frac{\\sum_{\\ell} d_{\\text{alg}}(j,\\ell) \\cdot e^{-d_{\\text{alg}}^2(j,\\ell)/(2\\varepsilon_c^2)}}{\\sum_{\\ell} e^{-d_{\\text{alg}}^2(j,\\ell)/(2\\varepsilon_c^2)}}\n1838: \n1839: $$\n1840: \n1841: This is a **quotient of weighted sums**, leading to high complexity. The n-th derivative involves:\n1842: \n1843: 1. **Leibniz rule** for products: $d_{\\text{alg}} \\cdot \\exp(\\cdots)$\n1844: 2. **Fa\u00e0 di Bruno** for exponential: $\\exp(-d_{\\text{alg}}^2/(2\\varepsilon_c^2))$\n1845: 3. **Quotient rule** for $N_j / Z_j$ (introduces additional partitions)\n1846: 4. **Sum over companions**: Each term has exponential decay, ensuring k-uniformity\n1847: \n1848: **Key challenge**: Tracking which scale dominates\u2014$\\varepsilon_d^{1-n}$ (from $d_{\\text{alg}}$ derivatives) vs $\\varepsilon_c^{-n}$ (from exponential kernel derivatives).\n1849: "
    },
    {
      "directive_type": "lemma",
      "label": "lem-softmax-jacobian-reduction",
      "title": "Softmax Jacobian Reduction for $j \\neq i$",
      "start_line": 1978,
      "end_line": 1996,
      "header_lines": [
        1979
      ],
      "content_start": 1981,
      "content_end": 1995,
      "content": "1981: :label: lem-softmax-jacobian-reduction\n1982: \n1983: Let $K_\\ell := \\exp(-d_{\\text{alg}}^2(j,\\ell)/(2\\varepsilon_c^2))$, $Z := \\sum_m K_m$, and $P_\\ell := K_\\ell / Z$ be the softmax probabilities. For $j \\neq i$, only $K_i$ depends on $x_i$. Then:\n1984: \n1985: $$\n1986: \\nabla_{x_i} P_\\ell = P_\\ell (\\delta_{\\ell i} - P_i) \\nabla_{x_i} \\log K_i\n1987: \n1988: $$\n1989: \n1990: and the first derivative of $d_j$ decomposes as:\n1991: \n1992: $$\n1993: \\nabla_{x_i} d_j = P_i \\nabla_{x_i} d_{\\text{alg}}(j,i) + P_i (d_{\\text{alg}}(j,i) - d_j) \\nabla_{x_i} \\log K_i\n1994: \n1995: $$",
      "metadata": {
        "label": "lem-softmax-jacobian-reduction"
      },
      "section": "## 5.5 Companion-Dependent Measurements with Softmax Coupling",
      "references": [],
      "raw_directive": "1978: Before applying the quotient rule, we provide an alternative derivation using the probability parametrization that makes the k-uniformity mechanism explicit. This addresses potential concerns about whether $\\ell$-summations could introduce $\\mathcal{O}(k_{\\text{eff}}^{(\\varepsilon_c)}) = \\mathcal{O}((\\log k)^d)$ factors.\n1979: \n1980: :::{prf:lemma} Softmax Jacobian Reduction for $j \\neq i$\n1981: :label: lem-softmax-jacobian-reduction\n1982: \n1983: Let $K_\\ell := \\exp(-d_{\\text{alg}}^2(j,\\ell)/(2\\varepsilon_c^2))$, $Z := \\sum_m K_m$, and $P_\\ell := K_\\ell / Z$ be the softmax probabilities. For $j \\neq i$, only $K_i$ depends on $x_i$. Then:\n1984: \n1985: $$\n1986: \\nabla_{x_i} P_\\ell = P_\\ell (\\delta_{\\ell i} - P_i) \\nabla_{x_i} \\log K_i\n1987: \n1988: $$\n1989: \n1990: and the first derivative of $d_j$ decomposes as:\n1991: \n1992: $$\n1993: \\nabla_{x_i} d_j = P_i \\nabla_{x_i} d_{\\text{alg}}(j,i) + P_i (d_{\\text{alg}}(j,i) - d_j) \\nabla_{x_i} \\log K_i\n1994: \n1995: $$\n1996: "
    },
    {
      "directive_type": "proof",
      "label": "unlabeled-proof-216",
      "title": null,
      "start_line": 1998,
      "end_line": 2105,
      "header_lines": [],
      "content_start": 2000,
      "content_end": 2104,
      "content": "2000: :::{prf:proof}\n2001: \n2002: **Step (a): Softmax-Jacobian identity.**\n2003: \n2004: Since only $K_i$ depends on $x_i$, we have $\\nabla_{x_i} Z = \\nabla_{x_i} K_i$. By the quotient rule:\n2005: \n2006: $$\n2007: \\nabla_{x_i} P_\\ell = \\frac{\\delta_{\\ell i} \\nabla_{x_i} K_i \\cdot Z - K_\\ell \\nabla_{x_i} Z}{Z^2}\n2008: = \\frac{\\delta_{\\ell i} \\nabla_{x_i} K_i \\cdot Z - K_\\ell \\nabla_{x_i} K_i}{Z^2}\n2009: \n2010: $$\n2011: \n2012: Factoring out $\\nabla_{x_i} K_i$:\n2013: \n2014: $$\n2015: \\nabla_{x_i} P_\\ell = \\frac{(\\delta_{\\ell i} Z - K_\\ell)}{Z^2} \\nabla_{x_i} K_i\n2016: = \\frac{K_\\ell}{Z} \\left(\\delta_{\\ell i} \\frac{Z}{K_\\ell} - 1\\right) \\frac{\\nabla_{x_i} K_i}{K_i} \\cdot K_i\n2017: \n2018: $$\n2019: \n2020: Since $P_\\ell = K_\\ell / Z$, $Z/K_i = 1/P_i$ when $\\ell = i$, and $\\nabla_{x_i} \\log K_i = \\nabla_{x_i} K_i / K_i$:\n2021: \n2022: $$\n2023: \\nabla_{x_i} P_\\ell = P_\\ell \\left(\\delta_{\\ell i} - P_i\\right) \\nabla_{x_i} \\log K_i\n2024: \n2025: $$\n2026: \n2027: where we used $\\delta_{\\ell i} Z - K_\\ell = \\delta_{\\ell i} K_i (Z/K_i) - K_\\ell = K_\\ell(\\delta_{\\ell i}/P_i - 1)$ for $\\ell = i$, and $\\delta_{\\ell i} Z - K_\\ell = -K_\\ell$ for $\\ell \\neq i$.\n2028: \n2029: **Step (b): Telescoping in the probability term.**\n2030: \n2031: Recall $d_j = \\sum_\\ell P_\\ell d_{\\text{alg}}(j,\\ell)$. By the product rule:\n2032: \n2033: $$\n2034: \\nabla_{x_i} d_j = \\sum_{\\ell} P_\\ell \\nabla_{x_i} d_{\\text{alg}}(j,\\ell) + \\sum_{\\ell} d_{\\text{alg}}(j,\\ell) \\nabla_{x_i} P_\\ell\n2035: \n2036: $$\n2037: \n2038: For the first term, **derivative locality** of $d_{\\text{alg}}$ (see {prf:ref}`lem-dalg-derivative-bounds-full`) gives $\\nabla_{x_i} d_{\\text{alg}}(j,\\ell) = 0$ for $\\ell \\neq i$, so:\n2039: \n2040: $$\n2041: \\sum_{\\ell} P_\\ell \\nabla_{x_i} d_{\\text{alg}}(j,\\ell) = P_i \\nabla_{x_i} d_{\\text{alg}}(j,i)\n2042: \n2043: $$\n2044: \n2045: For the second term, substituting the softmax-Jacobian identity:\n2046: \n2047: $$\n2048: \\sum_{\\ell} d_{\\text{alg}}(j,\\ell) \\nabla_{x_i} P_\\ell\n2049: = \\sum_{\\ell} d_{\\text{alg}}(j,\\ell) P_\\ell (\\delta_{\\ell i} - P_i) \\nabla_{x_i} \\log K_i\n2050: \n2051: $$\n2052: \n2053: Expanding the $\\delta_{\\ell i}$ term:\n2054: \n2055: $$\n2056: = \\left[\\sum_{\\ell} d_{\\text{alg}}(j,\\ell) P_\\ell \\delta_{\\ell i} - P_i \\sum_{\\ell} d_{\\text{alg}}(j,\\ell) P_\\ell\\right] \\nabla_{x_i} \\log K_i\n2057: \n2058: $$\n2059: \n2060: The first sum collapses to $d_{\\text{alg}}(j,i) P_i$, and the second sum is $d_j$ by definition:\n2061: \n2062: $$\n2063: = \\left[d_{\\text{alg}}(j,i) P_i - P_i d_j\\right] \\nabla_{x_i} \\log K_i\n2064: = P_i (d_{\\text{alg}}(j,i) - d_j) \\nabla_{x_i} \\log K_i\n2065: \n2066: $$\n2067: \n2068: Combining both terms:\n2069: \n2070: $$\n2071: \\nabla_{x_i} d_j = P_i \\nabla_{x_i} d_{\\text{alg}}(j,i) + P_i (d_{\\text{alg}}(j,i) - d_j) \\nabla_{x_i} \\log K_i\n2072: \n2073: $$\n2074: \n2075: **Step (c): k-uniformity and extension to higher-order derivatives.**\n2076: \n2077: **For the first derivative:** Both terms involve only $(j,i)$-dependent quantities:\n2078: - $P_i = K_i / Z$ depends on $Z = \\sum_m K_m$, but the derivative $\\nabla_{x_i} d_j$ has **no explicit $\\ell$-sum**\n2079: - All factors scale as $\\mathcal{O}(1)$ or $\\mathcal{O}(\\varepsilon_c^{-1})$ (from $\\nabla \\log K_i$)\n2080: \n2081: **For higher-order derivatives ($n \\geq 2$):** The k-uniform structure is preserved by the following argument:\n2082: \n2083: 1. **Inductive structure**: Each higher-order derivative $\\nabla^n_{x_i} d_j$ is obtained by differentiating $\\nabla^{n-1}_{x_i} d_j$, which by induction has the form:\n2084:    $$\n2085:    \\nabla^{n-1}_{x_i} d_j = \\sum_{\\text{terms}} P_i^{k_1} (\\nabla^{k_2} d_{ji}) (\\nabla^{k_3} \\log K_i) (\\nabla^{k_4} d_j)\n2086:    $$\n2087:    where all derivatives are with respect to $x_i$ and depend only on the pair $(j,i)$.\n2088: \n2089: 2. **Derivative closure**: Applying $\\nabla_{x_i}$ to any such term produces new terms of the same form:\n2090:    - $\\nabla_{x_i} P_i = P_i(1 - P_i) \\nabla_{x_i} \\log K_i$ (softmax-Jacobian identity for $\\ell=i$)\n2091:    - $\\nabla_{x_i} d_{ji}$ increases the derivative order but remains $(j,i)$-dependent\n2092:    - $\\nabla_{x_i} \\log K_i$ increases the derivative order but remains $(j,i)$-dependent\n2093:    - $\\nabla_{x_i} d_j$ can be expanded using the formula from Step (b), maintaining the same structure\n2094: \n2095: 3. **No $\\ell$-summation introduced**: Since only $K_i$ depends on $x_i$ (locality), no derivative operation reintroduces a summation over $\\ell \\neq i$. Each term remains a function of $(j,i)$ only.\n2096: \n2097: 4. **Gevrey-1 growth**: The Leibniz rule, quotient rule, and Fa\u00e0 di Bruno formula (detailed in Step 3 below) produce combinatorial factors bounded by $\\mathcal{O}(n!)$, yielding Gevrey-1 growth.\n2098: \n2099: Therefore, for all $n \\geq 1$:\n2100: $$\n2101: \\|\\nabla^n_{x_i} d_j\\| \\leq C_n \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n})\n2102: $$\n2103: where $C_n = \\mathcal{O}(n!)$ is **k-uniform** (independent of the number of walkers).\n2104: ",
      "metadata": {},
      "section": "## 5.5 Companion-Dependent Measurements with Softmax Coupling",
      "references": [
        "lem-dalg-derivative-bounds-full"
      ],
      "raw_directive": "1998: :::\n1999: \n2000: :::{prf:proof}\n2001: \n2002: **Step (a): Softmax-Jacobian identity.**\n2003: \n2004: Since only $K_i$ depends on $x_i$, we have $\\nabla_{x_i} Z = \\nabla_{x_i} K_i$. By the quotient rule:\n2005: \n2006: $$\n2007: \\nabla_{x_i} P_\\ell = \\frac{\\delta_{\\ell i} \\nabla_{x_i} K_i \\cdot Z - K_\\ell \\nabla_{x_i} Z}{Z^2}\n2008: = \\frac{\\delta_{\\ell i} \\nabla_{x_i} K_i \\cdot Z - K_\\ell \\nabla_{x_i} K_i}{Z^2}\n2009: \n2010: $$\n2011: \n2012: Factoring out $\\nabla_{x_i} K_i$:\n2013: \n2014: $$\n2015: \\nabla_{x_i} P_\\ell = \\frac{(\\delta_{\\ell i} Z - K_\\ell)}{Z^2} \\nabla_{x_i} K_i\n2016: = \\frac{K_\\ell}{Z} \\left(\\delta_{\\ell i} \\frac{Z}{K_\\ell} - 1\\right) \\frac{\\nabla_{x_i} K_i}{K_i} \\cdot K_i\n2017: \n2018: $$\n2019: \n2020: Since $P_\\ell = K_\\ell / Z$, $Z/K_i = 1/P_i$ when $\\ell = i$, and $\\nabla_{x_i} \\log K_i = \\nabla_{x_i} K_i / K_i$:\n2021: \n2022: $$\n2023: \\nabla_{x_i} P_\\ell = P_\\ell \\left(\\delta_{\\ell i} - P_i\\right) \\nabla_{x_i} \\log K_i\n2024: \n2025: $$\n2026: \n2027: where we used $\\delta_{\\ell i} Z - K_\\ell = \\delta_{\\ell i} K_i (Z/K_i) - K_\\ell = K_\\ell(\\delta_{\\ell i}/P_i - 1)$ for $\\ell = i$, and $\\delta_{\\ell i} Z - K_\\ell = -K_\\ell$ for $\\ell \\neq i$.\n2028: \n2029: **Step (b): Telescoping in the probability term.**\n2030: \n2031: Recall $d_j = \\sum_\\ell P_\\ell d_{\\text{alg}}(j,\\ell)$. By the product rule:\n2032: \n2033: $$\n2034: \\nabla_{x_i} d_j = \\sum_{\\ell} P_\\ell \\nabla_{x_i} d_{\\text{alg}}(j,\\ell) + \\sum_{\\ell} d_{\\text{alg}}(j,\\ell) \\nabla_{x_i} P_\\ell\n2035: \n2036: $$\n2037: \n2038: For the first term, **derivative locality** of $d_{\\text{alg}}$ (see {prf:ref}`lem-dalg-derivative-bounds-full`) gives $\\nabla_{x_i} d_{\\text{alg}}(j,\\ell) = 0$ for $\\ell \\neq i$, so:\n2039: \n2040: $$\n2041: \\sum_{\\ell} P_\\ell \\nabla_{x_i} d_{\\text{alg}}(j,\\ell) = P_i \\nabla_{x_i} d_{\\text{alg}}(j,i)\n2042: \n2043: $$\n2044: \n2045: For the second term, substituting the softmax-Jacobian identity:\n2046: \n2047: $$\n2048: \\sum_{\\ell} d_{\\text{alg}}(j,\\ell) \\nabla_{x_i} P_\\ell\n2049: = \\sum_{\\ell} d_{\\text{alg}}(j,\\ell) P_\\ell (\\delta_{\\ell i} - P_i) \\nabla_{x_i} \\log K_i\n2050: \n2051: $$\n2052: \n2053: Expanding the $\\delta_{\\ell i}$ term:\n2054: \n2055: $$\n2056: = \\left[\\sum_{\\ell} d_{\\text{alg}}(j,\\ell) P_\\ell \\delta_{\\ell i} - P_i \\sum_{\\ell} d_{\\text{alg}}(j,\\ell) P_\\ell\\right] \\nabla_{x_i} \\log K_i\n2057: \n2058: $$\n2059: \n2060: The first sum collapses to $d_{\\text{alg}}(j,i) P_i$, and the second sum is $d_j$ by definition:\n2061: \n2062: $$\n2063: = \\left[d_{\\text{alg}}(j,i) P_i - P_i d_j\\right] \\nabla_{x_i} \\log K_i\n2064: = P_i (d_{\\text{alg}}(j,i) - d_j) \\nabla_{x_i} \\log K_i\n2065: \n2066: $$\n2067: \n2068: Combining both terms:\n2069: \n2070: $$\n2071: \\nabla_{x_i} d_j = P_i \\nabla_{x_i} d_{\\text{alg}}(j,i) + P_i (d_{\\text{alg}}(j,i) - d_j) \\nabla_{x_i} \\log K_i\n2072: \n2073: $$\n2074: \n2075: **Step (c): k-uniformity and extension to higher-order derivatives.**\n2076: \n2077: **For the first derivative:** Both terms involve only $(j,i)$-dependent quantities:\n2078: - $P_i = K_i / Z$ depends on $Z = \\sum_m K_m$, but the derivative $\\nabla_{x_i} d_j$ has **no explicit $\\ell$-sum**\n2079: - All factors scale as $\\mathcal{O}(1)$ or $\\mathcal{O}(\\varepsilon_c^{-1})$ (from $\\nabla \\log K_i$)\n2080: \n2081: **For higher-order derivatives ($n \\geq 2$):** The k-uniform structure is preserved by the following argument:\n2082: \n2083: 1. **Inductive structure**: Each higher-order derivative $\\nabla^n_{x_i} d_j$ is obtained by differentiating $\\nabla^{n-1}_{x_i} d_j$, which by induction has the form:\n2084:    $$\n2085:    \\nabla^{n-1}_{x_i} d_j = \\sum_{\\text{terms}} P_i^{k_1} (\\nabla^{k_2} d_{ji}) (\\nabla^{k_3} \\log K_i) (\\nabla^{k_4} d_j)\n2086:    $$\n2087:    where all derivatives are with respect to $x_i$ and depend only on the pair $(j,i)$.\n2088: \n2089: 2. **Derivative closure**: Applying $\\nabla_{x_i}$ to any such term produces new terms of the same form:\n2090:    - $\\nabla_{x_i} P_i = P_i(1 - P_i) \\nabla_{x_i} \\log K_i$ (softmax-Jacobian identity for $\\ell=i$)\n2091:    - $\\nabla_{x_i} d_{ji}$ increases the derivative order but remains $(j,i)$-dependent\n2092:    - $\\nabla_{x_i} \\log K_i$ increases the derivative order but remains $(j,i)$-dependent\n2093:    - $\\nabla_{x_i} d_j$ can be expanded using the formula from Step (b), maintaining the same structure\n2094: \n2095: 3. **No $\\ell$-summation introduced**: Since only $K_i$ depends on $x_i$ (locality), no derivative operation reintroduces a summation over $\\ell \\neq i$. Each term remains a function of $(j,i)$ only.\n2096: \n2097: 4. **Gevrey-1 growth**: The Leibniz rule, quotient rule, and Fa\u00e0 di Bruno formula (detailed in Step 3 below) produce combinatorial factors bounded by $\\mathcal{O}(n!)$, yielding Gevrey-1 growth.\n2098: \n2099: Therefore, for all $n \\geq 1$:\n2100: $$\n2101: \\|\\nabla^n_{x_i} d_j\\| \\leq C_n \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n})\n2102: $$\n2103: where $C_n = \\mathcal{O}(n!)$ is **k-uniform** (independent of the number of walkers).\n2104: \n2105: **Rigorous justification**: This inductive argument is formalized through the Fa\u00e0 di Bruno/quotient-rule analysis in Step 3 below, which tracks all derivative contributions through the composition structure $d_j = N_j / Z_j$."
    },
    {
      "directive_type": "lemma",
      "label": "lem-self-measurement-derivatives-full",
      "title": "Derivatives of Self-Measurement (j=i case)",
      "start_line": 2215,
      "end_line": 2235,
      "header_lines": [
        2216
      ],
      "content_start": 2218,
      "content_end": 2234,
      "content": "2218: :label: lem-self-measurement-derivatives-full\n2219: \n2220: For walker $i \\in \\mathcal{A}$, the **self-measurement** $d_i = d_{\\text{alg}}(i, c(i))$ where $c(i)$ is selected via softmax satisfies:\n2221: \n2222: $$\n2223: \\|\\nabla^n_{x_i} d_i\\| \\leq C_{d_i,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n})\n2224: \n2225: $$\n2226: \n2227: where $C_{d_i,n} = \\mathcal{O}(n!)$ (Gevrey-1) is **k-uniform** (independent of the number of alive walkers).\n2228: \n2229: **For typical parameters** where $\\varepsilon_d \\ll \\varepsilon_c$ and $n \\geq 2$:\n2230: \n2231: $$\n2232: \\|\\nabla^n_{x_i} d_i\\| \\leq C_{d_i,n} \\cdot \\varepsilon_d^{1-n}\n2233: \n2234: $$",
      "metadata": {
        "label": "lem-self-measurement-derivatives-full"
      },
      "section": "## 5.5 Companion-Dependent Measurements with Softmax Coupling",
      "references": [],
      "raw_directive": "2215: :::\n2216: \n2217: :::{prf:lemma} Derivatives of Self-Measurement (j=i case)\n2218: :label: lem-self-measurement-derivatives-full\n2219: \n2220: For walker $i \\in \\mathcal{A}$, the **self-measurement** $d_i = d_{\\text{alg}}(i, c(i))$ where $c(i)$ is selected via softmax satisfies:\n2221: \n2222: $$\n2223: \\|\\nabla^n_{x_i} d_i\\| \\leq C_{d_i,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n})\n2224: \n2225: $$\n2226: \n2227: where $C_{d_i,n} = \\mathcal{O}(n!)$ (Gevrey-1) is **k-uniform** (independent of the number of alive walkers).\n2228: \n2229: **For typical parameters** where $\\varepsilon_d \\ll \\varepsilon_c$ and $n \\geq 2$:\n2230: \n2231: $$\n2232: \\|\\nabla^n_{x_i} d_i\\| \\leq C_{d_i,n} \\cdot \\varepsilon_d^{1-n}\n2233: \n2234: $$\n2235: "
    },
    {
      "directive_type": "proof",
      "label": "proof-lem-self-measurement-derivatives-full",
      "title": null,
      "start_line": 2237,
      "end_line": 2334,
      "header_lines": [
        2238
      ],
      "content_start": 2240,
      "content_end": 2333,
      "content": "2240: :label: proof-lem-self-measurement-derivatives-full\n2241: \n2242: The self-measurement is:\n2243: \n2244: $$\n2245: d_i = \\frac{N_i}{Z_i}, \\quad N_i := \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} d_{\\text{alg}}(i,\\ell) \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right), \\quad Z_i := \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2246: \n2247: $$\n2248: \n2249: **Step 1: Derivatives of numerator $N_i$.**\n2250: \n2251: For $\\ell \\neq i$, the $\\ell$-th term in $N_i$ is:\n2252: \n2253: $$\n2254: f_\\ell := d_{\\text{alg}}(i,\\ell) \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2255: \n2256: $$\n2257: \n2258: By the Leibniz rule (as in \u00a75.5.2 for j\u2260i case), the $n$-th derivative satisfies:\n2259: \n2260: $$\n2261: \\|\\nabla^n_{x_i} f_\\ell\\| \\leq C_{f,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n}) \\cdot \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2262: \n2263: $$\n2264: \n2265: where $C_{f,n} = \\mathcal{O}(n!)$ (Gevrey-1).\n2266: \n2267: **Summing over $\\ell$**:\n2268: \n2269: $$\n2270: \\|\\nabla^n_{x_i} N_i\\| \\leq \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\|\\nabla^n_{x_i} f_\\ell\\| \\leq C_{f,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n}) \\cdot \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2271: \n2272: $$\n2273: \n2274: **Step 2: Apply sum-to-integral bound.**\n2275: \n2276: By Lemma {prf:ref}`lem-sum-to-integral-bound-full` with $f \\equiv 1$:\n2277: \n2278: $$\n2279: \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right) \\leq \\rho_{\\max} \\cdot (2\\pi\\varepsilon_c^2)^d \\cdot C_{\\lambda}\n2280: \n2281: $$\n2282: \n2283: This bound is **k-uniform**: it depends only on $(\\rho_{\\max}, \\varepsilon_c, d)$, **not on $k$**.\n2284: \n2285: Therefore:\n2286: \n2287: $$\n2288: \\|\\nabla^n_{x_i} N_i\\| \\leq C_{f,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n}) \\cdot \\rho_{\\max} (2\\pi\\varepsilon_c^2)^d C_{\\lambda}\n2289: \n2290: $$\n2291: \n2292: **Step 3: Derivatives of partition function $Z_i$.**\n2293: \n2294: Similarly, for the exponential terms in $Z_i$:\n2295: \n2296: $$\n2297: \\|\\nabla^n_{x_i} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\\| \\leq C_{K,n} \\varepsilon_c^{-n} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2298: \n2299: $$\n2300: \n2301: Summing and applying the sum-to-integral bound:\n2302: \n2303: $$\n2304: \\|\\nabla^n_{x_i} Z_i\\| \\leq C_{K,n} \\varepsilon_c^{-n} \\cdot \\rho_{\\max} (2\\pi\\varepsilon_c^2)^d C_{\\lambda}\n2305: \n2306: $$\n2307: \n2308: which is **k-uniform**.\n2309: \n2310: **Step 4: Quotient rule for $d_i = N_i / Z_i$.**\n2311: \n2312: By the generalized quotient rule (Fa\u00e0 di Bruno formula), the derivatives of $d_i$ involve products of $\\nabla^k N_i$ and $\\nabla^\\ell Z_i$ with $k + \\ell \\leq n$, divided by powers of $Z_i$.\n2313: \n2314: **Lower bound for $Z_i$**: By Lemma {prf:ref}`lem-companion-availability-enforcement`:\n2315: \n2316: $$\n2317: Z_i \\geq \\exp\\left(-\\frac{D_{\\max}^2}{2\\varepsilon_c^2}\\right) =: Z_{\\min} > 0\n2318: \n2319: $$\n2320: \n2321: Combining the bounds from Steps 2-3 and applying the quotient rule:\n2322: \n2323: $$\n2324: \\|\\nabla^n_{x_i} d_i\\| \\leq C_{d_i,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n})\n2325: \n2326: $$\n2327: \n2328: where $C_{d_i,n} = \\mathcal{O}(n!)$ arises from:\n2329: - Fa\u00e0 di Bruno combinatorics: $\\mathcal{O}(n!)$\n2330: - Factorial growth from $C_{f,n}, C_{K,n}$: each $\\mathcal{O}(n!)$\n2331: - **k-uniform factors**: $\\rho_{\\max} (2\\pi\\varepsilon_c^2)^d C_{\\lambda} / Z_{\\min}$ (no $k$-dependence)\n2332: \n2333: **Conclusion**: The constant $C_{d_i,n}$ is **k-uniform** because the sum over companions is controlled by the sum-to-integral bound (Lemma {prf:ref}`lem-sum-to-integral-bound-full`), which replaces the naive $\\mathcal{O}(k)$ factor with $\\mathcal{O}(\\rho_{\\max} \\varepsilon_c^{2d})$ (independent of $k$).",
      "metadata": {
        "label": "proof-lem-self-measurement-derivatives-full"
      },
      "section": "## 5.5 Companion-Dependent Measurements with Softmax Coupling",
      "references": [
        "lem-sum-to-integral-bound-full",
        "lem-companion-availability-enforcement"
      ],
      "raw_directive": "2237: :::\n2238: \n2239: :::{prf:proof}\n2240: :label: proof-lem-self-measurement-derivatives-full\n2241: \n2242: The self-measurement is:\n2243: \n2244: $$\n2245: d_i = \\frac{N_i}{Z_i}, \\quad N_i := \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} d_{\\text{alg}}(i,\\ell) \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right), \\quad Z_i := \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2246: \n2247: $$\n2248: \n2249: **Step 1: Derivatives of numerator $N_i$.**\n2250: \n2251: For $\\ell \\neq i$, the $\\ell$-th term in $N_i$ is:\n2252: \n2253: $$\n2254: f_\\ell := d_{\\text{alg}}(i,\\ell) \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2255: \n2256: $$\n2257: \n2258: By the Leibniz rule (as in \u00a75.5.2 for j\u2260i case), the $n$-th derivative satisfies:\n2259: \n2260: $$\n2261: \\|\\nabla^n_{x_i} f_\\ell\\| \\leq C_{f,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n}) \\cdot \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2262: \n2263: $$\n2264: \n2265: where $C_{f,n} = \\mathcal{O}(n!)$ (Gevrey-1).\n2266: \n2267: **Summing over $\\ell$**:\n2268: \n2269: $$\n2270: \\|\\nabla^n_{x_i} N_i\\| \\leq \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\|\\nabla^n_{x_i} f_\\ell\\| \\leq C_{f,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n}) \\cdot \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2271: \n2272: $$\n2273: \n2274: **Step 2: Apply sum-to-integral bound.**\n2275: \n2276: By Lemma {prf:ref}`lem-sum-to-integral-bound-full` with $f \\equiv 1$:\n2277: \n2278: $$\n2279: \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right) \\leq \\rho_{\\max} \\cdot (2\\pi\\varepsilon_c^2)^d \\cdot C_{\\lambda}\n2280: \n2281: $$\n2282: \n2283: This bound is **k-uniform**: it depends only on $(\\rho_{\\max}, \\varepsilon_c, d)$, **not on $k$**.\n2284: \n2285: Therefore:\n2286: \n2287: $$\n2288: \\|\\nabla^n_{x_i} N_i\\| \\leq C_{f,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n}) \\cdot \\rho_{\\max} (2\\pi\\varepsilon_c^2)^d C_{\\lambda}\n2289: \n2290: $$\n2291: \n2292: **Step 3: Derivatives of partition function $Z_i$.**\n2293: \n2294: Similarly, for the exponential terms in $Z_i$:\n2295: \n2296: $$\n2297: \\|\\nabla^n_{x_i} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\\| \\leq C_{K,n} \\varepsilon_c^{-n} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2298: \n2299: $$\n2300: \n2301: Summing and applying the sum-to-integral bound:\n2302: \n2303: $$\n2304: \\|\\nabla^n_{x_i} Z_i\\| \\leq C_{K,n} \\varepsilon_c^{-n} \\cdot \\rho_{\\max} (2\\pi\\varepsilon_c^2)^d C_{\\lambda}\n2305: \n2306: $$\n2307: \n2308: which is **k-uniform**.\n2309: \n2310: **Step 4: Quotient rule for $d_i = N_i / Z_i$.**\n2311: \n2312: By the generalized quotient rule (Fa\u00e0 di Bruno formula), the derivatives of $d_i$ involve products of $\\nabla^k N_i$ and $\\nabla^\\ell Z_i$ with $k + \\ell \\leq n$, divided by powers of $Z_i$.\n2313: \n2314: **Lower bound for $Z_i$**: By Lemma {prf:ref}`lem-companion-availability-enforcement`:\n2315: \n2316: $$\n2317: Z_i \\geq \\exp\\left(-\\frac{D_{\\max}^2}{2\\varepsilon_c^2}\\right) =: Z_{\\min} > 0\n2318: \n2319: $$\n2320: \n2321: Combining the bounds from Steps 2-3 and applying the quotient rule:\n2322: \n2323: $$\n2324: \\|\\nabla^n_{x_i} d_i\\| \\leq C_{d_i,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n})\n2325: \n2326: $$\n2327: \n2328: where $C_{d_i,n} = \\mathcal{O}(n!)$ arises from:\n2329: - Fa\u00e0 di Bruno combinatorics: $\\mathcal{O}(n!)$\n2330: - Factorial growth from $C_{f,n}, C_{K,n}$: each $\\mathcal{O}(n!)$\n2331: - **k-uniform factors**: $\\rho_{\\max} (2\\pi\\varepsilon_c^2)^d C_{\\lambda} / Z_{\\min}$ (no $k$-dependence)\n2332: \n2333: **Conclusion**: The constant $C_{d_i,n}$ is **k-uniform** because the sum over companions is controlled by the sum-to-integral bound (Lemma {prf:ref}`lem-sum-to-integral-bound-full`), which replaces the naive $\\mathcal{O}(k)$ factor with $\\mathcal{O}(\\rho_{\\max} \\varepsilon_c^{2d})$ (independent of $k$).\n2334: "
    }
  ],
  "validation": {
    "ok": true,
    "errors": []
  }
}