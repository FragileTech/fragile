{
  "chapter_index": 9,
  "section_id": "## 5.6 Diversity Pairing Mechanism Analysis",
  "directive_count": 6,
  "hints": [
    {
      "directive_type": "definition",
      "label": "def-diversity-pairing-cinf",
      "title": "Sequential Stochastic Greedy Pairing (From 03_cloning.md)",
      "start_line": 2360,
      "end_line": 2377,
      "header_lines": [
        2361
      ],
      "content_start": 2363,
      "content_end": 2376,
      "content": "2363: :label: def-diversity-pairing-cinf\n2364: \n2365: From Definition 5.1.2 in `docs/source/1_euclidean_gas/03_cloning.md`:\n2366: \n2367: **Inputs**: Alive walkers $\\mathcal{A}_t = \\{w_1, \\ldots, w_k\\}$, interaction range $\\varepsilon_d > 0$\n2368: \n2369: **Operation** (Algorithm 5.1):\n2370: 1. Initialize unpaired set $U \\leftarrow \\mathcal{A}_t$, empty companion map $c$\n2371: 2. While $|U| > 1$:\n2372:    - Select walker $i$ from $U$, remove from $U$\n2373:    - For each $j \\in U$, compute weight: $w_{ij} := \\exp\\left(-\\frac{d_{\\text{alg}}(i, j)^2}{2\\varepsilon_d^2}\\right)$\n2374:    - Sample companion $c_i$ from softmax distribution: $P(j) = w_{ij} / \\sum_{\\ell \\in U} w_{i\\ell}$\n2375:    - Remove $c_i$ from $U$\n2376:    - Set bidirectional pairing: $c(i) \\leftarrow c_i$ and $c(c_i) \\leftarrow i$",
      "metadata": {
        "label": "def-diversity-pairing-cinf"
      },
      "section": "## 5.6 Diversity Pairing Mechanism Analysis",
      "references": [],
      "raw_directive": "2360: ### 5.6.1 Diversity Pairing Definition\n2361: \n2362: :::{prf:definition} Sequential Stochastic Greedy Pairing (From 03_cloning.md)\n2363: :label: def-diversity-pairing-cinf\n2364: \n2365: From Definition 5.1.2 in `docs/source/1_euclidean_gas/03_cloning.md`:\n2366: \n2367: **Inputs**: Alive walkers $\\mathcal{A}_t = \\{w_1, \\ldots, w_k\\}$, interaction range $\\varepsilon_d > 0$\n2368: \n2369: **Operation** (Algorithm 5.1):\n2370: 1. Initialize unpaired set $U \\leftarrow \\mathcal{A}_t$, empty companion map $c$\n2371: 2. While $|U| > 1$:\n2372:    - Select walker $i$ from $U$, remove from $U$\n2373:    - For each $j \\in U$, compute weight: $w_{ij} := \\exp\\left(-\\frac{d_{\\text{alg}}(i, j)^2}{2\\varepsilon_d^2}\\right)$\n2374:    - Sample companion $c_i$ from softmax distribution: $P(j) = w_{ij} / \\sum_{\\ell \\in U} w_{i\\ell}$\n2375:    - Remove $c_i$ from $U$\n2376:    - Set bidirectional pairing: $c(i) \\leftarrow c_i$ and $c(c_i) \\leftarrow i$\n2377: "
    },
    {
      "directive_type": "definition",
      "label": "def-idealized-pairing-cinf",
      "title": "Idealized Spatially-Aware Pairing (From 03_cloning.md)",
      "start_line": 2379,
      "end_line": 2399,
      "header_lines": [
        2380
      ],
      "content_start": 2382,
      "content_end": 2398,
      "content": "2382: :label: def-idealized-pairing-cinf\n2383: \n2384: From Definition 5.1.1 in `03_cloning.md`:\n2385: \n2386: The idealized model assigns probability to each perfect matching $M \\in \\mathcal{M}_k$ via:\n2387: \n2388: $$\n2389: P_{\\text{ideal}}(M | S) = \\frac{W(M)}{\\sum_{M' \\in \\mathcal{M}_k} W(M')}\n2390: \n2391: $$\n2392: \n2393: where the matching quality is:\n2394: \n2395: $$\n2396: W(M) := \\prod_{(i,j) \\in M} \\exp\\left(-\\frac{d_{\\text{alg}}(i, j)^2}{2\\varepsilon_d^2}\\right)\n2397: \n2398: $$",
      "metadata": {
        "label": "def-idealized-pairing-cinf"
      },
      "section": "## 5.6 Diversity Pairing Mechanism Analysis",
      "references": [],
      "raw_directive": "2379: :::\n2380: \n2381: :::{prf:definition} Idealized Spatially-Aware Pairing (From 03_cloning.md)\n2382: :label: def-idealized-pairing-cinf\n2383: \n2384: From Definition 5.1.1 in `03_cloning.md`:\n2385: \n2386: The idealized model assigns probability to each perfect matching $M \\in \\mathcal{M}_k$ via:\n2387: \n2388: $$\n2389: P_{\\text{ideal}}(M | S) = \\frac{W(M)}{\\sum_{M' \\in \\mathcal{M}_k} W(M')}\n2390: \n2391: $$\n2392: \n2393: where the matching quality is:\n2394: \n2395: $$\n2396: W(M) := \\prod_{(i,j) \\in M} \\exp\\left(-\\frac{d_{\\text{alg}}(i, j)^2}{2\\varepsilon_d^2}\\right)\n2397: \n2398: $$\n2399: "
    },
    {
      "directive_type": "theorem",
      "label": "thm-diversity-pairing-measurement-regularity",
      "title": "C^\u221e Regularity with K-Uniform Bounds (Diversity Pairing)",
      "start_line": 2423,
      "end_line": 2434,
      "header_lines": [
        2424
      ],
      "content_start": 2426,
      "content_end": 2433,
      "content": "2426: :label: thm-diversity-pairing-measurement-regularity\n2427: \n2428: Using the diversity pairing mechanism (either idealized or sequential greedy), the expected measurement satisfies:\n2429: \n2430: $$\n2431: \\|\\nabla^m \\bar{d}_i\\|_{\\infty} \\leq C_m(\\varepsilon_d, d, \\rho_{\\max}) \\cdot m! \\cdot \\varepsilon_d^{-2m}\n2432: \n2433: $$",
      "metadata": {
        "label": "thm-diversity-pairing-measurement-regularity"
      },
      "section": "## 5.6 Diversity Pairing Mechanism Analysis",
      "references": [],
      "raw_directive": "2423: ### 5.6.3 C^\u221e Regularity of Diversity Pairing Measurements\n2424: \n2425: :::{prf:theorem} C^\u221e Regularity with K-Uniform Bounds (Diversity Pairing)\n2426: :label: thm-diversity-pairing-measurement-regularity\n2427: \n2428: Using the diversity pairing mechanism (either idealized or sequential greedy), the expected measurement satisfies:\n2429: \n2430: $$\n2431: \\|\\nabla^m \\bar{d}_i\\|_{\\infty} \\leq C_m(\\varepsilon_d, d, \\rho_{\\max}) \\cdot m! \\cdot \\varepsilon_d^{-2m}\n2432: \n2433: $$\n2434: "
    },
    {
      "directive_type": "proof",
      "label": "proof-thm-diversity-pairing-measurement-regularity",
      "title": null,
      "start_line": 2436,
      "end_line": 2620,
      "header_lines": [
        2437
      ],
      "content_start": 2439,
      "content_end": 2619,
      "content": "2439: :label: proof-thm-diversity-pairing-measurement-regularity\n2440: \n2441: **Step 1: Expected measurement structure**\n2442: \n2443: $$\n2444: \\bar{d}_i = \\mathbb{E}[d_{\\text{alg}}(i, M(i))] = \\frac{\\sum_{M \\in \\mathcal{M}_k} W(M) \\cdot d_{\\text{alg}}(i, M(i))}{\\sum_{M' \\in \\mathcal{M}_k} W(M')}\n2445: \n2446: $$\n2447: \n2448: where:\n2449: - $W(M) = \\prod_{(j,\\ell) \\in M} \\exp(-d_{\\text{alg}}^2(j,\\ell)/(2\\varepsilon_d^2))$ (matching weight)\n2450: - $\\mathcal{M}_k$ = set of all perfect matchings of k walkers\n2451: \n2452: **Step 2: Exponential concentration of matching weights**\n2453: \n2454: **Key observation**: For walker $i$, matching weights are exponentially concentrated near matchings where $i$ is paired with a nearby companion.\n2455: \n2456: For any matching $M$ where $i$ is paired with walker $\\ell$ at distance $d_{\\text{alg}}(i,\\ell) = R$:\n2457: \n2458: $$\n2459: W(M) \\leq \\exp\\left(-\\frac{R^2}{2\\varepsilon_d^2}\\right) \\cdot W_{\\text{rest}}(M)\n2460: \n2461: $$\n2462: \n2463: where $W_{\\text{rest}}(M)$ is the product over other pairs (independent of the $(i,\\ell)$ pair).\n2464: \n2465: **Step 3: Permutation invariance reduces the matching sum to a marginal distribution**\n2466: \n2467: **Key Observation (Permutation Invariance)**: The fitness potential $V_{\\text{fit}}(x_i, v_i)$ must be invariant under relabeling of walkers $j \\neq i$ (fundamental symmetry of exchangeable particle systems). This means the expected measurement:\n2468: \n2469: $$\n2470: \\bar{d}_i = \\mathbb{E}_{M \\sim P_{\\text{ideal}}}[d_{\\text{alg}}(i, M(i))]\n2471: \n2472: $$\n2473: \n2474: depends only on walker $i$'s state $(x_i, v_i)$ and the **empirical distribution** of other walkers $\\{(x_j, v_j)\\}_{j \\neq i}$, not their labels.\n2475: \n2476: **Marginal Distribution Reformulation**: Instead of summing over all $(k-1)!! = O((k/e)^{k/2})$ matchings (combinatorial explosion), we compute the **marginal probability** that walker $i$ is paired with walker $\\ell$:\n2477: \n2478: $$\n2479: p_{i \\to \\ell} := \\mathbb{P}_{M \\sim P_{\\text{ideal}}}(M(i) = \\ell) = \\frac{\\sum_{M: M(i) = \\ell} W(M)}{\\sum_{M \\in \\mathcal{M}_k} W(M)}\n2480: \n2481: $$\n2482: \n2483: Then the expected measurement becomes:\n2484: \n2485: $$\n2486: \\bar{d}_i = \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} p_{i \\to \\ell} \\cdot d_{\\text{alg}}(i, \\ell)\n2487: \n2488: $$\n2489: \n2490: **This is a sum over $k-1$ terms, not $(k-1)!!$ matchings!** The combinatorial explosion is eliminated by permutation symmetry.\n2491: \n2492: **Computing the marginal probability**: For a fixed pair $(i, \\ell)$, the numerator sums over all matchings where $i$ is paired with $\\ell$:\n2493: \n2494: $$\n2495: \\sum_{M: M(i) = \\ell} W(M) = \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_d^2}\\right) \\cdot Z_{\\text{rest}}(i, \\ell)\n2496: \n2497: $$\n2498: \n2499: where $Z_{\\text{rest}}(i, \\ell) = \\sum_{M' \\in \\mathcal{M}_{k-2}} W(M')$ is the partition function over matchings of the remaining $k-2$ walkers (excluding $i$ and $\\ell$).\n2500: \n2501: **Key insight - Direct regularity without approximation**: While one might expect $Z_{\\text{rest}}(i,\\ell)$ to be approximately constant (independent of $\\ell$), this is NOT generally true in clustered geometries. **However**, we can prove C^\u221e regularity with k-uniform bounds **without** assuming this approximation.\n2502: \n2503: **Direct observation**: The critical fact is that $Z_{\\text{rest}}(i,\\ell)$ is **independent of $x_i$** (it depends only on walkers $\\mathcal{A} \\setminus \\{i,\\ell\\}$). Therefore:\n2504: \n2505: $$\n2506: \\nabla_{x_i} Z_{\\text{rest}}(i,\\ell) = 0\n2507: \n2508: $$\n2509: \n2510: because derivatives of d_alg(j,j') with respect to x_i are zero when $i \\notin \\{j,j'\\}$ (locality of distance derivatives).\n2511: \n2512: **Consequence**: The marginal probability has simplified derivative structure:\n2513: \n2514: $$\n2515: p_{i \\to \\ell} = \\frac{\\exp(-d_{\\text{alg}}^2(i,\\ell)/(2\\varepsilon_d^2)) \\cdot Z_{\\text{rest}}(i,\\ell)}{\\sum_{\\ell'} \\exp(-d_{\\text{alg}}^2(i,\\ell')/(2\\varepsilon_d^2)) \\cdot Z_{\\text{rest}}(i,\\ell')}\n2516: \n2517: $$\n2518: \n2519: When taking derivatives $\\nabla_{x_i}$, the $Z_{\\text{rest}}$ terms factor out of the quotient rule because $\\nabla_{x_i} Z_{\\text{rest}} = 0$!\n2520: \n2521: **Result**: The expected measurement has analytical structure\n2522: \n2523: $$\n2524: \\bar{d}_i = \\sum_{\\ell \\neq i} p_{i \\to \\ell} \\cdot d_{\\text{alg}}(i,\\ell)\n2525: \n2526: $$\n2527: \n2528: where the marginal $p_{i \\to \\ell}$ is a **quotient with bounded, k-independent ratios** $Z_{\\text{rest}}(i,\\ell) / Z_{\\text{rest}}(i,\\ell')$ (both are partition functions over k-2 walkers with exponential weights, differing only by which walker is excluded).\n2529: \n2530: **No combinatorial explosion**: Permutation symmetry reduces (k-1)!! matchings to a sum over k-1 terms with well-behaved coefficients!\n2531: \n2532: **Step 4: Derivative analysis via locality**\n2533: \n2534: **Key**: When taking derivatives $\\nabla_{x_i}$ of $p_{i \\to \\ell}$:\n2535: \n2536: $$\n2537: \\nabla_{x_i} p_{i \\to \\ell} = \\nabla_{x_i} \\left[\\frac{\\exp(-d^2(i,\\ell)/(2\\varepsilon_d^2)) \\cdot Z_{\\text{rest}}(i,\\ell)}{\\sum_{\\ell'} (\\cdots)}\\right]\n2538: \n2539: $$\n2540: \n2541: Since $\\nabla_{x_i} Z_{\\text{rest}}(i,\\ell) = 0$ (locality), the $Z_{\\text{rest}}$ terms are **constants** for the derivative calculation. The quotient simplifies to:\n2542: \n2543: $$\n2544: \\nabla_{x_i} p_{i \\to \\ell} \\propto \\nabla_{x_i} \\left[\\frac{\\exp(-d^2(i,\\ell)/(2\\varepsilon_d^2))}{\\sum_{\\ell'} \\exp(-d^2(i,\\ell')/(2\\varepsilon_d^2)) \\cdot (Z_{\\text{rest}}(i,\\ell')/Z_{\\text{rest}}(i,\\ell))}\\right]\n2545: \n2546: $$\n2547: \n2548: **Bound via quotient rule**: Even though $Z_{\\text{rest}}$ ratios may vary by O(1) factors (e.g., in clustered geometries), they are:\n2549: 1. **Bounded**: By exponential weights, all ratios \u2264 exp(const \u00b7 (R_eff)\u00b2/\u03b5_d\u00b2) < \u221e\n2550: 2. **k-uniform**: Number of $\\ell$ contributing is k_eff = O(\u03c1_max \u03b5_d^{2d}), independent of k\n2551: 3. **Smooth**: Each Z_rest is a sum of smooth exponentials\n2552: \n2553: The derivatives follow from standard quotient rule + Fa\u00e0 di Bruno:\n2554: 1. **Gaussian kernel derivatives**: $\\|\\nabla^m K_{\\varepsilon_d}(i,\\ell)\\| \\leq C_m \\cdot \\varepsilon_d^{-2m} \\cdot K_{\\varepsilon_d}(i,\\ell)$\n2555: 2. **Exponential concentration**: Only $k_{\\text{eff}} = O(\\rho_{\\max} \\varepsilon_d^{2d})$ nearby walkers contribute significantly\n2556: 3. **Quotient rule**: Generalized Leibniz rule with k-uniform bounds\n2557: \n2558: By uniform density bound (Assumption {prf:ref}`assump-uniform-density-full`):\n2559: \n2560: $$\n2561: k_{\\text{eff}}(i) = |\\{\\ell : d_{\\text{alg}}(i,\\ell) \\leq R_{\\text{eff}}\\}| \\leq \\rho_{\\max} \\cdot C_{\\text{vol}} \\cdot R_{\\text{eff}}^{2d} = O(\\rho_{\\max} \\varepsilon_d^{2d})\n2562: \n2563: $$\n2564: \n2565: where $R_{\\text{eff}} = O(\\varepsilon_d)$ is the effective interaction radius (exponential concentration of softmax).\n2566: \n2567: **Step 5: Derivative bound via quotient rule**\n2568: \n2569: Taking derivatives of $\\bar{d}_i = f_i / Z_i$:\n2570: \n2571: $$\n2572: \\nabla^m \\bar{d}_i = \\sum_{\\text{partitions of } m} C_{j_1,\\ldots,j_p} \\cdot \\frac{(\\nabla^{j_1} f_i) \\cdot (\\nabla^{j_2} Z_i) \\cdots (\\nabla^{j_p} Z_i)}{Z_i^{p+1}}\n2573: \n2574: $$\n2575: \n2576: Each derivative of $f_i$ and $Z_i$ involves sums over $k-1$ walkers:\n2577: \n2578: $$\n2579: \\nabla^j f_i = \\sum_{\\ell \\neq i} \\nabla^j [K_{\\varepsilon_d}(i,\\ell) \\cdot d_{\\text{alg}}(i,\\ell)]\n2580: \n2581: $$\n2582: \n2583: By the product rule and Fa\u00e0 di Bruno formula:\n2584: \n2585: $$\n2586: \\nabla^j [K_{\\varepsilon_d} \\cdot d_{\\text{alg}}] = \\sum_{\\alpha + \\beta = j} C_{\\alpha,\\beta} \\cdot (\\nabla^\\alpha K_{\\varepsilon_d}) \\cdot (\\nabla^\\beta d_{\\text{alg}})\n2587: \n2588: $$\n2589: \n2590: **Bounds on each term**:\n2591: - $\\|\\nabla^\\alpha K_{\\varepsilon_d}(i,\\ell)\\| \\leq C_\\alpha \\cdot \\varepsilon_d^{-2\\alpha} \\cdot K_{\\varepsilon_d}(i,\\ell)$ (Gaussian)\n2592: - $\\|\\nabla^\\beta d_{\\text{alg}}(i,\\ell)\\| \\leq C_\\beta \\cdot \\varepsilon_d^{1-\\beta}$ (regularized distance)\n2593: \n2594: **Exponential concentration**: Only walkers with $d_{\\text{alg}}(i,\\ell) \\leq R_{\\text{eff}} = O(\\varepsilon_d)$ contribute significantly (softmax tail bound). The effective number is:\n2595: \n2596: $$\n2597: k_{\\text{eff}} = O(\\rho_{\\max} \\cdot \\text{Vol}(B_{R_{\\text{eff}}})) = O(\\rho_{\\max} \\varepsilon_d^{2d})\n2598: \n2599: $$\n2600: \n2601: which is **k-uniform** (independent of total swarm size).\n2602: \n2603: **Step 6: Assemble the Gevrey-1 bound**\n2604: \n2605: Summing over $k_{\\text{eff}}$ effective walkers and applying quotient rule:\n2606: \n2607: $$\n2608: \\|\\nabla^m \\bar{d}_i\\| \\leq \\sum_{\\text{partitions}} \\frac{k_{\\text{eff}} \\cdot C_{j_1} \\varepsilon_d^{-2j_1} \\cdot (k_{\\text{eff}} \\cdot C_{j_2} \\varepsilon_d^{-2j_2})^{p-1}}{Z_{\\min}^p}\n2609: \n2610: $$\n2611: \n2612: Since $k_{\\text{eff}} = O(\\rho_{\\max} \\varepsilon_d^{2d})$ and $Z_{\\min} = \\Omega(k_{\\text{eff}})$, the $k_{\\text{eff}}$ factors cancel:\n2613: \n2614: $$\n2615: \\|\\nabla^m \\bar{d}_i\\| \\leq C_m(\\varepsilon_d, d, \\rho_{\\max}) \\cdot m! \\cdot \\varepsilon_d^{-2m}\n2616: \n2617: $$\n2618: \n2619: where $C_m = O(m!)$ (Gevrey-1) and is **k-uniform**.",
      "metadata": {
        "label": "proof-thm-diversity-pairing-measurement-regularity"
      },
      "section": "## 5.6 Diversity Pairing Mechanism Analysis",
      "references": [
        "assump-uniform-density-full"
      ],
      "raw_directive": "2436: :::\n2437: \n2438: :::{prf:proof}\n2439: :label: proof-thm-diversity-pairing-measurement-regularity\n2440: \n2441: **Step 1: Expected measurement structure**\n2442: \n2443: $$\n2444: \\bar{d}_i = \\mathbb{E}[d_{\\text{alg}}(i, M(i))] = \\frac{\\sum_{M \\in \\mathcal{M}_k} W(M) \\cdot d_{\\text{alg}}(i, M(i))}{\\sum_{M' \\in \\mathcal{M}_k} W(M')}\n2445: \n2446: $$\n2447: \n2448: where:\n2449: - $W(M) = \\prod_{(j,\\ell) \\in M} \\exp(-d_{\\text{alg}}^2(j,\\ell)/(2\\varepsilon_d^2))$ (matching weight)\n2450: - $\\mathcal{M}_k$ = set of all perfect matchings of k walkers\n2451: \n2452: **Step 2: Exponential concentration of matching weights**\n2453: \n2454: **Key observation**: For walker $i$, matching weights are exponentially concentrated near matchings where $i$ is paired with a nearby companion.\n2455: \n2456: For any matching $M$ where $i$ is paired with walker $\\ell$ at distance $d_{\\text{alg}}(i,\\ell) = R$:\n2457: \n2458: $$\n2459: W(M) \\leq \\exp\\left(-\\frac{R^2}{2\\varepsilon_d^2}\\right) \\cdot W_{\\text{rest}}(M)\n2460: \n2461: $$\n2462: \n2463: where $W_{\\text{rest}}(M)$ is the product over other pairs (independent of the $(i,\\ell)$ pair).\n2464: \n2465: **Step 3: Permutation invariance reduces the matching sum to a marginal distribution**\n2466: \n2467: **Key Observation (Permutation Invariance)**: The fitness potential $V_{\\text{fit}}(x_i, v_i)$ must be invariant under relabeling of walkers $j \\neq i$ (fundamental symmetry of exchangeable particle systems). This means the expected measurement:\n2468: \n2469: $$\n2470: \\bar{d}_i = \\mathbb{E}_{M \\sim P_{\\text{ideal}}}[d_{\\text{alg}}(i, M(i))]\n2471: \n2472: $$\n2473: \n2474: depends only on walker $i$'s state $(x_i, v_i)$ and the **empirical distribution** of other walkers $\\{(x_j, v_j)\\}_{j \\neq i}$, not their labels.\n2475: \n2476: **Marginal Distribution Reformulation**: Instead of summing over all $(k-1)!! = O((k/e)^{k/2})$ matchings (combinatorial explosion), we compute the **marginal probability** that walker $i$ is paired with walker $\\ell$:\n2477: \n2478: $$\n2479: p_{i \\to \\ell} := \\mathbb{P}_{M \\sim P_{\\text{ideal}}}(M(i) = \\ell) = \\frac{\\sum_{M: M(i) = \\ell} W(M)}{\\sum_{M \\in \\mathcal{M}_k} W(M)}\n2480: \n2481: $$\n2482: \n2483: Then the expected measurement becomes:\n2484: \n2485: $$\n2486: \\bar{d}_i = \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} p_{i \\to \\ell} \\cdot d_{\\text{alg}}(i, \\ell)\n2487: \n2488: $$\n2489: \n2490: **This is a sum over $k-1$ terms, not $(k-1)!!$ matchings!** The combinatorial explosion is eliminated by permutation symmetry.\n2491: \n2492: **Computing the marginal probability**: For a fixed pair $(i, \\ell)$, the numerator sums over all matchings where $i$ is paired with $\\ell$:\n2493: \n2494: $$\n2495: \\sum_{M: M(i) = \\ell} W(M) = \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_d^2}\\right) \\cdot Z_{\\text{rest}}(i, \\ell)\n2496: \n2497: $$\n2498: \n2499: where $Z_{\\text{rest}}(i, \\ell) = \\sum_{M' \\in \\mathcal{M}_{k-2}} W(M')$ is the partition function over matchings of the remaining $k-2$ walkers (excluding $i$ and $\\ell$).\n2500: \n2501: **Key insight - Direct regularity without approximation**: While one might expect $Z_{\\text{rest}}(i,\\ell)$ to be approximately constant (independent of $\\ell$), this is NOT generally true in clustered geometries. **However**, we can prove C^\u221e regularity with k-uniform bounds **without** assuming this approximation.\n2502: \n2503: **Direct observation**: The critical fact is that $Z_{\\text{rest}}(i,\\ell)$ is **independent of $x_i$** (it depends only on walkers $\\mathcal{A} \\setminus \\{i,\\ell\\}$). Therefore:\n2504: \n2505: $$\n2506: \\nabla_{x_i} Z_{\\text{rest}}(i,\\ell) = 0\n2507: \n2508: $$\n2509: \n2510: because derivatives of d_alg(j,j') with respect to x_i are zero when $i \\notin \\{j,j'\\}$ (locality of distance derivatives).\n2511: \n2512: **Consequence**: The marginal probability has simplified derivative structure:\n2513: \n2514: $$\n2515: p_{i \\to \\ell} = \\frac{\\exp(-d_{\\text{alg}}^2(i,\\ell)/(2\\varepsilon_d^2)) \\cdot Z_{\\text{rest}}(i,\\ell)}{\\sum_{\\ell'} \\exp(-d_{\\text{alg}}^2(i,\\ell')/(2\\varepsilon_d^2)) \\cdot Z_{\\text{rest}}(i,\\ell')}\n2516: \n2517: $$\n2518: \n2519: When taking derivatives $\\nabla_{x_i}$, the $Z_{\\text{rest}}$ terms factor out of the quotient rule because $\\nabla_{x_i} Z_{\\text{rest}} = 0$!\n2520: \n2521: **Result**: The expected measurement has analytical structure\n2522: \n2523: $$\n2524: \\bar{d}_i = \\sum_{\\ell \\neq i} p_{i \\to \\ell} \\cdot d_{\\text{alg}}(i,\\ell)\n2525: \n2526: $$\n2527: \n2528: where the marginal $p_{i \\to \\ell}$ is a **quotient with bounded, k-independent ratios** $Z_{\\text{rest}}(i,\\ell) / Z_{\\text{rest}}(i,\\ell')$ (both are partition functions over k-2 walkers with exponential weights, differing only by which walker is excluded).\n2529: \n2530: **No combinatorial explosion**: Permutation symmetry reduces (k-1)!! matchings to a sum over k-1 terms with well-behaved coefficients!\n2531: \n2532: **Step 4: Derivative analysis via locality**\n2533: \n2534: **Key**: When taking derivatives $\\nabla_{x_i}$ of $p_{i \\to \\ell}$:\n2535: \n2536: $$\n2537: \\nabla_{x_i} p_{i \\to \\ell} = \\nabla_{x_i} \\left[\\frac{\\exp(-d^2(i,\\ell)/(2\\varepsilon_d^2)) \\cdot Z_{\\text{rest}}(i,\\ell)}{\\sum_{\\ell'} (\\cdots)}\\right]\n2538: \n2539: $$\n2540: \n2541: Since $\\nabla_{x_i} Z_{\\text{rest}}(i,\\ell) = 0$ (locality), the $Z_{\\text{rest}}$ terms are **constants** for the derivative calculation. The quotient simplifies to:\n2542: \n2543: $$\n2544: \\nabla_{x_i} p_{i \\to \\ell} \\propto \\nabla_{x_i} \\left[\\frac{\\exp(-d^2(i,\\ell)/(2\\varepsilon_d^2))}{\\sum_{\\ell'} \\exp(-d^2(i,\\ell')/(2\\varepsilon_d^2)) \\cdot (Z_{\\text{rest}}(i,\\ell')/Z_{\\text{rest}}(i,\\ell))}\\right]\n2545: \n2546: $$\n2547: \n2548: **Bound via quotient rule**: Even though $Z_{\\text{rest}}$ ratios may vary by O(1) factors (e.g., in clustered geometries), they are:\n2549: 1. **Bounded**: By exponential weights, all ratios \u2264 exp(const \u00b7 (R_eff)\u00b2/\u03b5_d\u00b2) < \u221e\n2550: 2. **k-uniform**: Number of $\\ell$ contributing is k_eff = O(\u03c1_max \u03b5_d^{2d}), independent of k\n2551: 3. **Smooth**: Each Z_rest is a sum of smooth exponentials\n2552: \n2553: The derivatives follow from standard quotient rule + Fa\u00e0 di Bruno:\n2554: 1. **Gaussian kernel derivatives**: $\\|\\nabla^m K_{\\varepsilon_d}(i,\\ell)\\| \\leq C_m \\cdot \\varepsilon_d^{-2m} \\cdot K_{\\varepsilon_d}(i,\\ell)$\n2555: 2. **Exponential concentration**: Only $k_{\\text{eff}} = O(\\rho_{\\max} \\varepsilon_d^{2d})$ nearby walkers contribute significantly\n2556: 3. **Quotient rule**: Generalized Leibniz rule with k-uniform bounds\n2557: \n2558: By uniform density bound (Assumption {prf:ref}`assump-uniform-density-full`):\n2559: \n2560: $$\n2561: k_{\\text{eff}}(i) = |\\{\\ell : d_{\\text{alg}}(i,\\ell) \\leq R_{\\text{eff}}\\}| \\leq \\rho_{\\max} \\cdot C_{\\text{vol}} \\cdot R_{\\text{eff}}^{2d} = O(\\rho_{\\max} \\varepsilon_d^{2d})\n2562: \n2563: $$\n2564: \n2565: where $R_{\\text{eff}} = O(\\varepsilon_d)$ is the effective interaction radius (exponential concentration of softmax).\n2566: \n2567: **Step 5: Derivative bound via quotient rule**\n2568: \n2569: Taking derivatives of $\\bar{d}_i = f_i / Z_i$:\n2570: \n2571: $$\n2572: \\nabla^m \\bar{d}_i = \\sum_{\\text{partitions of } m} C_{j_1,\\ldots,j_p} \\cdot \\frac{(\\nabla^{j_1} f_i) \\cdot (\\nabla^{j_2} Z_i) \\cdots (\\nabla^{j_p} Z_i)}{Z_i^{p+1}}\n2573: \n2574: $$\n2575: \n2576: Each derivative of $f_i$ and $Z_i$ involves sums over $k-1$ walkers:\n2577: \n2578: $$\n2579: \\nabla^j f_i = \\sum_{\\ell \\neq i} \\nabla^j [K_{\\varepsilon_d}(i,\\ell) \\cdot d_{\\text{alg}}(i,\\ell)]\n2580: \n2581: $$\n2582: \n2583: By the product rule and Fa\u00e0 di Bruno formula:\n2584: \n2585: $$\n2586: \\nabla^j [K_{\\varepsilon_d} \\cdot d_{\\text{alg}}] = \\sum_{\\alpha + \\beta = j} C_{\\alpha,\\beta} \\cdot (\\nabla^\\alpha K_{\\varepsilon_d}) \\cdot (\\nabla^\\beta d_{\\text{alg}})\n2587: \n2588: $$\n2589: \n2590: **Bounds on each term**:\n2591: - $\\|\\nabla^\\alpha K_{\\varepsilon_d}(i,\\ell)\\| \\leq C_\\alpha \\cdot \\varepsilon_d^{-2\\alpha} \\cdot K_{\\varepsilon_d}(i,\\ell)$ (Gaussian)\n2592: - $\\|\\nabla^\\beta d_{\\text{alg}}(i,\\ell)\\| \\leq C_\\beta \\cdot \\varepsilon_d^{1-\\beta}$ (regularized distance)\n2593: \n2594: **Exponential concentration**: Only walkers with $d_{\\text{alg}}(i,\\ell) \\leq R_{\\text{eff}} = O(\\varepsilon_d)$ contribute significantly (softmax tail bound). The effective number is:\n2595: \n2596: $$\n2597: k_{\\text{eff}} = O(\\rho_{\\max} \\cdot \\text{Vol}(B_{R_{\\text{eff}}})) = O(\\rho_{\\max} \\varepsilon_d^{2d})\n2598: \n2599: $$\n2600: \n2601: which is **k-uniform** (independent of total swarm size).\n2602: \n2603: **Step 6: Assemble the Gevrey-1 bound**\n2604: \n2605: Summing over $k_{\\text{eff}}$ effective walkers and applying quotient rule:\n2606: \n2607: $$\n2608: \\|\\nabla^m \\bar{d}_i\\| \\leq \\sum_{\\text{partitions}} \\frac{k_{\\text{eff}} \\cdot C_{j_1} \\varepsilon_d^{-2j_1} \\cdot (k_{\\text{eff}} \\cdot C_{j_2} \\varepsilon_d^{-2j_2})^{p-1}}{Z_{\\min}^p}\n2609: \n2610: $$\n2611: \n2612: Since $k_{\\text{eff}} = O(\\rho_{\\max} \\varepsilon_d^{2d})$ and $Z_{\\min} = \\Omega(k_{\\text{eff}})$, the $k_{\\text{eff}}$ factors cancel:\n2613: \n2614: $$\n2615: \\|\\nabla^m \\bar{d}_i\\| \\leq C_m(\\varepsilon_d, d, \\rho_{\\max}) \\cdot m! \\cdot \\varepsilon_d^{-2m}\n2616: \n2617: $$\n2618: \n2619: where $C_m = O(m!)$ (Gevrey-1) and is **k-uniform**.\n2620: "
    },
    {
      "directive_type": "lemma",
      "label": "lem-greedy-ideal-equivalence",
      "title": "Statistical Equivalence Preserves C^\u221e Regularity",
      "start_line": 2655,
      "end_line": 2666,
      "header_lines": [
        2656
      ],
      "content_start": 2658,
      "content_end": 2665,
      "content": "2658: :label: lem-greedy-ideal-equivalence\n2659: \n2660: The Sequential Stochastic Greedy Pairing and the Idealized Spatially-Aware Pairing produce statistically equivalent measurements:\n2661: \n2662: $$\n2663: \\mathbb{E}_{\\text{greedy}}[d_i | S] = \\mathbb{E}_{\\text{ideal}}[d_i | S] + O(k^{-\\beta})\n2664: \n2665: $$",
      "metadata": {
        "label": "lem-greedy-ideal-equivalence"
      },
      "section": "## 5.6 Diversity Pairing Mechanism Analysis",
      "references": [
        "thm-diversity-pairing-measurement-regularity"
      ],
      "raw_directive": "2655: ### 5.6.4 Transfer from Idealized to Greedy Pairing\n2656: \n2657: :::{prf:lemma} Statistical Equivalence Preserves C^\u221e Regularity\n2658: :label: lem-greedy-ideal-equivalence\n2659: \n2660: The Sequential Stochastic Greedy Pairing and the Idealized Spatially-Aware Pairing produce statistically equivalent measurements:\n2661: \n2662: $$\n2663: \\mathbb{E}_{\\text{greedy}}[d_i | S] = \\mathbb{E}_{\\text{ideal}}[d_i | S] + O(k^{-\\beta})\n2664: \n2665: $$\n2666: "
    },
    {
      "directive_type": "proof",
      "label": "proof-lem-greedy-ideal-equivalence",
      "title": null,
      "start_line": 2668,
      "end_line": 2750,
      "header_lines": [
        2669
      ],
      "content_start": 2671,
      "content_end": 2749,
      "content": "2671: :label: proof-lem-greedy-ideal-equivalence\n2672: \n2673: The proof consists of two main parts:\n2674: \n2675: **Part I: Statistical Equivalence** - Prove $\\mathbb{E}_{\\text{greedy}}[d_i | S] = \\mathbb{E}_{\\text{ideal}}[d_i | S] + O(k^{-\\beta})$ using exponential locality.\n2676: \n2677: **Part II: Regularity Transfer** - Show that both expectations have identical analytical structure as rational functions of smooth exponential weights.\n2678: \n2679: **Part I: Statistical Equivalence via Exponential Locality**\n2680: \n2681: Define the truncation radius $R_k := \\varepsilon_d \\sqrt{2(\\beta + d) \\log k}$ for some $\\beta > 0$ to be determined.\n2682: \n2683: *Lemma A (Exponential Tail Bound)*: For the total weight contribution from walkers outside $B(i,R_k)$:\n2684: \n2685: $$\n2686: \\sum_{j \\notin B(i,R_k)} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,j)}{2\\varepsilon_d^2}\\right) \\leq C_{\\text{tail}}(\\rho_{\\max}, \\varepsilon_d, d) \\exp\\left(-\\frac{R_k^2}{2\\varepsilon_d^2}\\right) \\leq C_{\\text{tail}} \\cdot k^{-(\\beta + d)}\n2687: \n2688: $$\n2689: \n2690: **Proof**: Partition the exterior into shells and use the uniform density bound $|\\mathcal{S}(i, r, dr)| \\leq \\rho_{\\max} \\cdot \\text{vol}(S^{d-1}) \\cdot r^{d-1} \\, dr$. The total exterior weight is:\n2691: \n2692: $$\n2693: W_{\\text{exterior}}(R_k) \\leq \\int_{R_k}^{\\infty} \\rho_{\\max} \\cdot \\text{vol}(S^{d-1}) \\cdot r^{d-1} \\cdot \\exp\\left(-\\frac{r^2}{2\\varepsilon_d^2}\\right) \\, dr\n2694: \n2695: $$\n2696: \n2697: Substituting $u = r^2/(2\\varepsilon_d^2)$ and applying the incomplete gamma function tail bound:\n2698: \n2699: $$\n2700: \\int_{R_k^2/(2\\varepsilon_d^2)}^{\\infty} u^{(d-2)/2} e^{-u} \\, du \\leq \\Gamma(d/2) \\cdot \\exp\\left(-\\frac{R_k^2}{2\\varepsilon_d^2}\\right)\n2701: \n2702: $$\n2703: \n2704: For $R_k = \\varepsilon_d \\sqrt{2(\\beta + d) \\log k}$, this yields $W_{\\text{exterior}}(R_k) \\leq C_{\\text{tail}} \\cdot k^{-(\\beta + d)}$. \u220e\n2705: \n2706: *Lemma B (Coupling on Good Event)*: Define the good event:\n2707: \n2708: $$\n2709: G_R := \\{\\text{No walker outside } B(i, R_k) \\text{ is paired with any walker in } B(i, R_k) \\text{ before walker } i \\text{ is paired}\\}\n2710: \n2711: $$\n2712: \n2713: On the event $G_R$, the greedy and ideal marginals coincide on the local neighborhood $B(i, R_k)$, with exponentially small correction from external walkers.\n2714: \n2715: **Proof**: By Lemma A, external walkers contribute weight $O(k^{-(\\beta + d)})$. The probability of the bad event $\\bar{G}_R$ (external pre-emption) is bounded by:\n2716: \n2717: $$\n2718: P(\\bar{G}_R) \\leq k \\cdot W_{\\text{exterior}}(R_k) \\leq C_{\\text{tail}} \\cdot k^{1-(\\beta + d)}\n2719: \n2720: $$\n2721: \n2722: For $\\beta > 1 - d$, this vanishes as $k \\to \\infty$. Conditioning on $G_R$, the greedy and localized ideal mechanisms select from the same effective neighborhood with the same exponential weights, yielding:\n2723: \n2724: $$\n2725: |\\mathbb{E}_{\\text{greedy}}[d_i | S] - \\mathbb{E}_{\\text{ideal}}[d_i | S]| \\leq C \\cdot k^{-\\beta}\n2726: \n2727: $$\n2728: \n2729: for some constant $C$ depending on $(\\varepsilon_d, d, \\rho_{\\max}, d_{\\max})$ but independent of $k$. \u220e\n2730: \n2731: **Part II: Regularity Transfer**\n2732: \n2733: Both $\\mathbb{E}_{\\text{greedy}}$ and $\\mathbb{E}_{\\text{ideal}}$ are rational functions of exponential weights:\n2734: \n2735: $$\n2736: \\mathbb{E}_{\\bullet}[d_i | S] = \\frac{\\sum_{\\text{matchings } M} \\left(\\prod_{(j,j') \\in M} \\exp(-d^2/(2\\varepsilon_d^2))\\right) \\cdot f_i(M)}{\\sum_{\\text{matchings } M'} \\prod_{(j,j') \\in M'} \\exp(-d^2/(2\\varepsilon_d^2))}\n2737: \n2738: $$\n2739: \n2740: where $f_i(M)$ is a measurement value associated with the matching $M$.\n2741: \n2742: **Key observations**:\n2743: 1. Both expressions involve the **same exponential kernel** $\\exp(-d^2/(2\\varepsilon_d^2))$, which is C^\u221e in walker positions\n2744: 2. Derivatives are computed via Fa\u00e0 di Bruno's formula and quotient rule\n2745: 3. The sequential (greedy) vs. global (ideal) structure affects only the **combinatorial structure** (which matchings are summed), not the **analytical structure** (form of derivatives)\n2746: 4. Since both are rational functions of the same smooth weights, they have **identical regularity** (C^\u221e with Gevrey-1 bounds)\n2747: \n2748: *Lemma 5.1.2 from 03_cloning.md* establishes that the greedy algorithm preserves the geometric signal structure, meaning the dominant contributions to both sums come from geometrically similar matchings.\n2749: ",
      "metadata": {
        "label": "proof-lem-greedy-ideal-equivalence"
      },
      "section": "## 5.6 Diversity Pairing Mechanism Analysis",
      "references": [
        "thm-diversity-pairing-measurement-regularity"
      ],
      "raw_directive": "2668: :::\n2669: \n2670: :::{prf:proof}\n2671: :label: proof-lem-greedy-ideal-equivalence\n2672: \n2673: The proof consists of two main parts:\n2674: \n2675: **Part I: Statistical Equivalence** - Prove $\\mathbb{E}_{\\text{greedy}}[d_i | S] = \\mathbb{E}_{\\text{ideal}}[d_i | S] + O(k^{-\\beta})$ using exponential locality.\n2676: \n2677: **Part II: Regularity Transfer** - Show that both expectations have identical analytical structure as rational functions of smooth exponential weights.\n2678: \n2679: **Part I: Statistical Equivalence via Exponential Locality**\n2680: \n2681: Define the truncation radius $R_k := \\varepsilon_d \\sqrt{2(\\beta + d) \\log k}$ for some $\\beta > 0$ to be determined.\n2682: \n2683: *Lemma A (Exponential Tail Bound)*: For the total weight contribution from walkers outside $B(i,R_k)$:\n2684: \n2685: $$\n2686: \\sum_{j \\notin B(i,R_k)} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,j)}{2\\varepsilon_d^2}\\right) \\leq C_{\\text{tail}}(\\rho_{\\max}, \\varepsilon_d, d) \\exp\\left(-\\frac{R_k^2}{2\\varepsilon_d^2}\\right) \\leq C_{\\text{tail}} \\cdot k^{-(\\beta + d)}\n2687: \n2688: $$\n2689: \n2690: **Proof**: Partition the exterior into shells and use the uniform density bound $|\\mathcal{S}(i, r, dr)| \\leq \\rho_{\\max} \\cdot \\text{vol}(S^{d-1}) \\cdot r^{d-1} \\, dr$. The total exterior weight is:\n2691: \n2692: $$\n2693: W_{\\text{exterior}}(R_k) \\leq \\int_{R_k}^{\\infty} \\rho_{\\max} \\cdot \\text{vol}(S^{d-1}) \\cdot r^{d-1} \\cdot \\exp\\left(-\\frac{r^2}{2\\varepsilon_d^2}\\right) \\, dr\n2694: \n2695: $$\n2696: \n2697: Substituting $u = r^2/(2\\varepsilon_d^2)$ and applying the incomplete gamma function tail bound:\n2698: \n2699: $$\n2700: \\int_{R_k^2/(2\\varepsilon_d^2)}^{\\infty} u^{(d-2)/2} e^{-u} \\, du \\leq \\Gamma(d/2) \\cdot \\exp\\left(-\\frac{R_k^2}{2\\varepsilon_d^2}\\right)\n2701: \n2702: $$\n2703: \n2704: For $R_k = \\varepsilon_d \\sqrt{2(\\beta + d) \\log k}$, this yields $W_{\\text{exterior}}(R_k) \\leq C_{\\text{tail}} \\cdot k^{-(\\beta + d)}$. \u220e\n2705: \n2706: *Lemma B (Coupling on Good Event)*: Define the good event:\n2707: \n2708: $$\n2709: G_R := \\{\\text{No walker outside } B(i, R_k) \\text{ is paired with any walker in } B(i, R_k) \\text{ before walker } i \\text{ is paired}\\}\n2710: \n2711: $$\n2712: \n2713: On the event $G_R$, the greedy and ideal marginals coincide on the local neighborhood $B(i, R_k)$, with exponentially small correction from external walkers.\n2714: \n2715: **Proof**: By Lemma A, external walkers contribute weight $O(k^{-(\\beta + d)})$. The probability of the bad event $\\bar{G}_R$ (external pre-emption) is bounded by:\n2716: \n2717: $$\n2718: P(\\bar{G}_R) \\leq k \\cdot W_{\\text{exterior}}(R_k) \\leq C_{\\text{tail}} \\cdot k^{1-(\\beta + d)}\n2719: \n2720: $$\n2721: \n2722: For $\\beta > 1 - d$, this vanishes as $k \\to \\infty$. Conditioning on $G_R$, the greedy and localized ideal mechanisms select from the same effective neighborhood with the same exponential weights, yielding:\n2723: \n2724: $$\n2725: |\\mathbb{E}_{\\text{greedy}}[d_i | S] - \\mathbb{E}_{\\text{ideal}}[d_i | S]| \\leq C \\cdot k^{-\\beta}\n2726: \n2727: $$\n2728: \n2729: for some constant $C$ depending on $(\\varepsilon_d, d, \\rho_{\\max}, d_{\\max})$ but independent of $k$. \u220e\n2730: \n2731: **Part II: Regularity Transfer**\n2732: \n2733: Both $\\mathbb{E}_{\\text{greedy}}$ and $\\mathbb{E}_{\\text{ideal}}$ are rational functions of exponential weights:\n2734: \n2735: $$\n2736: \\mathbb{E}_{\\bullet}[d_i | S] = \\frac{\\sum_{\\text{matchings } M} \\left(\\prod_{(j,j') \\in M} \\exp(-d^2/(2\\varepsilon_d^2))\\right) \\cdot f_i(M)}{\\sum_{\\text{matchings } M'} \\prod_{(j,j') \\in M'} \\exp(-d^2/(2\\varepsilon_d^2))}\n2737: \n2738: $$\n2739: \n2740: where $f_i(M)$ is a measurement value associated with the matching $M$.\n2741: \n2742: **Key observations**:\n2743: 1. Both expressions involve the **same exponential kernel** $\\exp(-d^2/(2\\varepsilon_d^2))$, which is C^\u221e in walker positions\n2744: 2. Derivatives are computed via Fa\u00e0 di Bruno's formula and quotient rule\n2745: 3. The sequential (greedy) vs. global (ideal) structure affects only the **combinatorial structure** (which matchings are summed), not the **analytical structure** (form of derivatives)\n2746: 4. Since both are rational functions of the same smooth weights, they have **identical regularity** (C^\u221e with Gevrey-1 bounds)\n2747: \n2748: *Lemma 5.1.2 from 03_cloning.md* establishes that the greedy algorithm preserves the geometric signal structure, meaning the dominant contributions to both sums come from geometrically similar matchings.\n2749: \n2750: **Conclusion**: The C^\u221e regularity of $\\mathbb{E}_{\\text{ideal}}$ established in Theorem {prf:ref}`thm-diversity-pairing-measurement-regularity` (with k-uniform Gevrey-1 bounds $\\|\\nabla^m \\bar{d}_i\\| \\leq C_m \\cdot m! \\cdot \\varepsilon_d^{-2m}$) transfers identically to $\\mathbb{E}_{\\text{greedy}}$. The $O(k^{-\\beta})$ statistical difference is negligible for derivative bounds, which depend only on the analytical structure and the parameters $(\\varepsilon_d, d, \\rho_{\\max})$. \u220e"
    }
  ],
  "validation": {
    "ok": true,
    "errors": []
  }
}