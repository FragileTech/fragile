{
  "chapter_index": 8,
  "section_id": "## 5.5 Companion-Dependent Measurements with Softmax Coupling",
  "directive_count": 4,
  "hints": [
    {
      "directive_type": "lemma",
      "label": "lem-companion-measurement-derivatives-full",
      "title": "Derivatives of Companion-Dependent Measurements",
      "start_line": 1771,
      "end_line": 1791,
      "header_lines": [
        1772
      ],
      "content_start": 1774,
      "content_end": 1790,
      "content": "1774: :label: lem-companion-measurement-derivatives-full\n1775: \n1776: For any walker $i \\in \\mathcal{A}$ (taking derivatives with respect to $x_i$), the companion-dependent measurement for walker $j \\neq i$ satisfies:\n1777: \n1778: $$\n1779: \\|\\nabla^n_{x_i} d_j\\| \\leq C_{d_j,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n})\n1780: \n1781: $$\n1782: \n1783: where $C_{d_j,n} = \\mathcal{O}(n!)$ (Gevrey-1) is **k-uniform** (independent of the number of alive walkers).\n1784: \n1785: **For typical parameters** where $\\varepsilon_d \\ll \\varepsilon_c$ and $n \\geq 2$, this simplifies to:\n1786: \n1787: $$\n1788: \\|\\nabla^n_{x_i} d_j\\| \\leq C_{d_j,n} \\cdot \\varepsilon_d^{1-n}\n1789: \n1790: $$",
      "metadata": {
        "label": "lem-companion-measurement-derivatives-full"
      },
      "section": "## 5.5 Companion-Dependent Measurements with Softmax Coupling",
      "references": [],
      "raw_directive": "1771: ### 5.5.2 High-Order Derivatives via Fa\u00e0 di Bruno Formula\n1772: \n1773: :::{prf:lemma} Derivatives of Companion-Dependent Measurements\n1774: :label: lem-companion-measurement-derivatives-full\n1775: \n1776: For any walker $i \\in \\mathcal{A}$ (taking derivatives with respect to $x_i$), the companion-dependent measurement for walker $j \\neq i$ satisfies:\n1777: \n1778: $$\n1779: \\|\\nabla^n_{x_i} d_j\\| \\leq C_{d_j,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n})\n1780: \n1781: $$\n1782: \n1783: where $C_{d_j,n} = \\mathcal{O}(n!)$ (Gevrey-1) is **k-uniform** (independent of the number of alive walkers).\n1784: \n1785: **For typical parameters** where $\\varepsilon_d \\ll \\varepsilon_c$ and $n \\geq 2$, this simplifies to:\n1786: \n1787: $$\n1788: \\|\\nabla^n_{x_i} d_j\\| \\leq C_{d_j,n} \\cdot \\varepsilon_d^{1-n}\n1789: \n1790: $$\n1791: "
    },
    {
      "directive_type": "proof",
      "label": "unlabeled-proof-46",
      "title": null,
      "start_line": 1793,
      "end_line": 1813,
      "header_lines": [],
      "content_start": 1796,
      "content_end": 1812,
      "content": "1796: \n1797: :::{note}\n1798: **Derivative Structure Preview**: The companion-dependent measurement has the structure:\n1799: \n1800: $$\n1801: d_j = \\frac{N_j}{Z_j} = \\frac{\\sum_{\\ell} d_{\\text{alg}}(j,\\ell) \\cdot e^{-d_{\\text{alg}}^2(j,\\ell)/(2\\varepsilon_c^2)}}{\\sum_{\\ell} e^{-d_{\\text{alg}}^2(j,\\ell)/(2\\varepsilon_c^2)}}\n1802: \n1803: $$\n1804: \n1805: This is a **quotient of weighted sums**, leading to high complexity. The n-th derivative involves:\n1806: \n1807: 1. **Leibniz rule** for products: $d_{\\text{alg}} \\cdot \\exp(\\cdots)$\n1808: 2. **Fa\u00e0 di Bruno** for exponential: $\\exp(-d_{\\text{alg}}^2/(2\\varepsilon_c^2))$\n1809: 3. **Quotient rule** for $N_j / Z_j$ (introduces additional partitions)\n1810: 4. **Sum over companions**: Each term has exponential decay, ensuring k-uniformity\n1811: \n1812: **Key challenge**: Tracking which scale dominates\u2014$\\varepsilon_d^{1-n}$ (from $d_{\\text{alg}}$ derivatives) vs $\\varepsilon_c^{-n}$ (from exponential kernel derivatives).",
      "metadata": {},
      "section": "## 5.5 Companion-Dependent Measurements with Softmax Coupling",
      "references": [],
      "raw_directive": "1793: :::\n1794: \n1795: :::{prf:proof}\n1796: \n1797: :::{note}\n1798: **Derivative Structure Preview**: The companion-dependent measurement has the structure:\n1799: \n1800: $$\n1801: d_j = \\frac{N_j}{Z_j} = \\frac{\\sum_{\\ell} d_{\\text{alg}}(j,\\ell) \\cdot e^{-d_{\\text{alg}}^2(j,\\ell)/(2\\varepsilon_c^2)}}{\\sum_{\\ell} e^{-d_{\\text{alg}}^2(j,\\ell)/(2\\varepsilon_c^2)}}\n1802: \n1803: $$\n1804: \n1805: This is a **quotient of weighted sums**, leading to high complexity. The n-th derivative involves:\n1806: \n1807: 1. **Leibniz rule** for products: $d_{\\text{alg}} \\cdot \\exp(\\cdots)$\n1808: 2. **Fa\u00e0 di Bruno** for exponential: $\\exp(-d_{\\text{alg}}^2/(2\\varepsilon_c^2))$\n1809: 3. **Quotient rule** for $N_j / Z_j$ (introduces additional partitions)\n1810: 4. **Sum over companions**: Each term has exponential decay, ensuring k-uniformity\n1811: \n1812: **Key challenge**: Tracking which scale dominates\u2014$\\varepsilon_d^{1-n}$ (from $d_{\\text{alg}}$ derivatives) vs $\\varepsilon_c^{-n}$ (from exponential kernel derivatives).\n1813: "
    },
    {
      "directive_type": "lemma",
      "label": "lem-self-measurement-derivatives-full",
      "title": "Derivatives of Self-Measurement (j=i case)",
      "start_line": 2040,
      "end_line": 2060,
      "header_lines": [
        2041
      ],
      "content_start": 2043,
      "content_end": 2059,
      "content": "2043: :label: lem-self-measurement-derivatives-full\n2044: \n2045: For walker $i \\in \\mathcal{A}$, the **self-measurement** $d_i = d_{\\text{alg}}(i, c(i))$ where $c(i)$ is selected via softmax satisfies:\n2046: \n2047: $$\n2048: \\|\\nabla^n_{x_i} d_i\\| \\leq C_{d_i,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n})\n2049: \n2050: $$\n2051: \n2052: where $C_{d_i,n} = \\mathcal{O}(n!)$ (Gevrey-1) is **k-uniform** (independent of the number of alive walkers).\n2053: \n2054: **For typical parameters** where $\\varepsilon_d \\ll \\varepsilon_c$ and $n \\geq 2$:\n2055: \n2056: $$\n2057: \\|\\nabla^n_{x_i} d_i\\| \\leq C_{d_i,n} \\cdot \\varepsilon_d^{1-n}\n2058: \n2059: $$",
      "metadata": {
        "label": "lem-self-measurement-derivatives-full"
      },
      "section": "## 5.5 Companion-Dependent Measurements with Softmax Coupling",
      "references": [],
      "raw_directive": "2040: :::\n2041: \n2042: :::{prf:lemma} Derivatives of Self-Measurement (j=i case)\n2043: :label: lem-self-measurement-derivatives-full\n2044: \n2045: For walker $i \\in \\mathcal{A}$, the **self-measurement** $d_i = d_{\\text{alg}}(i, c(i))$ where $c(i)$ is selected via softmax satisfies:\n2046: \n2047: $$\n2048: \\|\\nabla^n_{x_i} d_i\\| \\leq C_{d_i,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n})\n2049: \n2050: $$\n2051: \n2052: where $C_{d_i,n} = \\mathcal{O}(n!)$ (Gevrey-1) is **k-uniform** (independent of the number of alive walkers).\n2053: \n2054: **For typical parameters** where $\\varepsilon_d \\ll \\varepsilon_c$ and $n \\geq 2$:\n2055: \n2056: $$\n2057: \\|\\nabla^n_{x_i} d_i\\| \\leq C_{d_i,n} \\cdot \\varepsilon_d^{1-n}\n2058: \n2059: $$\n2060: "
    },
    {
      "directive_type": "proof",
      "label": "unlabeled-proof-315",
      "title": null,
      "start_line": 2062,
      "end_line": 2157,
      "header_lines": [],
      "content_start": 2063,
      "content_end": 2156,
      "content": "2063: \n2064: :::{prf:proof}\n2065: The self-measurement is:\n2066: \n2067: $$\n2068: d_i = \\frac{N_i}{Z_i}, \\quad N_i := \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} d_{\\text{alg}}(i,\\ell) \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right), \\quad Z_i := \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2069: \n2070: $$\n2071: \n2072: **Step 1: Derivatives of numerator $N_i$.**\n2073: \n2074: For $\\ell \\neq i$, the $\\ell$-th term in $N_i$ is:\n2075: \n2076: $$\n2077: f_\\ell := d_{\\text{alg}}(i,\\ell) \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2078: \n2079: $$\n2080: \n2081: By the Leibniz rule (as in \u00a75.5.2 for j\u2260i case), the $n$-th derivative satisfies:\n2082: \n2083: $$\n2084: \\|\\nabla^n_{x_i} f_\\ell\\| \\leq C_{f,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n}) \\cdot \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2085: \n2086: $$\n2087: \n2088: where $C_{f,n} = \\mathcal{O}(n!)$ (Gevrey-1).\n2089: \n2090: **Summing over $\\ell$**:\n2091: \n2092: $$\n2093: \\|\\nabla^n_{x_i} N_i\\| \\leq \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\|\\nabla^n_{x_i} f_\\ell\\| \\leq C_{f,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n}) \\cdot \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2094: \n2095: $$\n2096: \n2097: **Step 2: Apply sum-to-integral bound.**\n2098: \n2099: By Lemma {prf:ref}`lem-sum-to-integral-bound-full` with $f \\equiv 1$:\n2100: \n2101: $$\n2102: \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right) \\leq \\rho_{\\max} \\cdot (2\\pi\\varepsilon_c^2)^d \\cdot C_{\\lambda}\n2103: \n2104: $$\n2105: \n2106: This bound is **k-uniform**: it depends only on $(\\rho_{\\max}, \\varepsilon_c, d)$, **not on $k$**.\n2107: \n2108: Therefore:\n2109: \n2110: $$\n2111: \\|\\nabla^n_{x_i} N_i\\| \\leq C_{f,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n}) \\cdot \\rho_{\\max} (2\\pi\\varepsilon_c^2)^d C_{\\lambda}\n2112: \n2113: $$\n2114: \n2115: **Step 3: Derivatives of partition function $Z_i$.**\n2116: \n2117: Similarly, for the exponential terms in $Z_i$:\n2118: \n2119: $$\n2120: \\|\\nabla^n_{x_i} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\\| \\leq C_{K,n} \\varepsilon_c^{-n} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2121: \n2122: $$\n2123: \n2124: Summing and applying the sum-to-integral bound:\n2125: \n2126: $$\n2127: \\|\\nabla^n_{x_i} Z_i\\| \\leq C_{K,n} \\varepsilon_c^{-n} \\cdot \\rho_{\\max} (2\\pi\\varepsilon_c^2)^d C_{\\lambda}\n2128: \n2129: $$\n2130: \n2131: which is **k-uniform**.\n2132: \n2133: **Step 4: Quotient rule for $d_i = N_i / Z_i$.**\n2134: \n2135: By the generalized quotient rule (Fa\u00e0 di Bruno formula), the derivatives of $d_i$ involve products of $\\nabla^k N_i$ and $\\nabla^\\ell Z_i$ with $k + \\ell \\leq n$, divided by powers of $Z_i$.\n2136: \n2137: **Lower bound for $Z_i$**: By Lemma {prf:ref}`lem-companion-availability-enforcement`:\n2138: \n2139: $$\n2140: Z_i \\geq \\exp\\left(-\\frac{D_{\\max}^2}{2\\varepsilon_c^2}\\right) =: Z_{\\min} > 0\n2141: \n2142: $$\n2143: \n2144: Combining the bounds from Steps 2-3 and applying the quotient rule:\n2145: \n2146: $$\n2147: \\|\\nabla^n_{x_i} d_i\\| \\leq C_{d_i,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n})\n2148: \n2149: $$\n2150: \n2151: where $C_{d_i,n} = \\mathcal{O}(n!)$ arises from:\n2152: - Fa\u00e0 di Bruno combinatorics: $\\mathcal{O}(n!)$\n2153: - Factorial growth from $C_{f,n}, C_{K,n}$: each $\\mathcal{O}(n!)$\n2154: - **k-uniform factors**: $\\rho_{\\max} (2\\pi\\varepsilon_c^2)^d C_{\\lambda} / Z_{\\min}$ (no $k$-dependence)\n2155: \n2156: **Conclusion**: The constant $C_{d_i,n}$ is **k-uniform** because the sum over companions is controlled by the sum-to-integral bound (Lemma {prf:ref}`lem-sum-to-integral-bound-full`), which replaces the naive $\\mathcal{O}(k)$ factor with $\\mathcal{O}(\\rho_{\\max} \\varepsilon_c^{2d})$ (independent of $k$).",
      "metadata": {},
      "section": "## 5.5 Companion-Dependent Measurements with Softmax Coupling",
      "references": [
        "lem-sum-to-integral-bound-full",
        "lem-companion-availability-enforcement"
      ],
      "raw_directive": "2062: :::\n2063: \n2064: :::{prf:proof}\n2065: The self-measurement is:\n2066: \n2067: $$\n2068: d_i = \\frac{N_i}{Z_i}, \\quad N_i := \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} d_{\\text{alg}}(i,\\ell) \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right), \\quad Z_i := \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2069: \n2070: $$\n2071: \n2072: **Step 1: Derivatives of numerator $N_i$.**\n2073: \n2074: For $\\ell \\neq i$, the $\\ell$-th term in $N_i$ is:\n2075: \n2076: $$\n2077: f_\\ell := d_{\\text{alg}}(i,\\ell) \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2078: \n2079: $$\n2080: \n2081: By the Leibniz rule (as in \u00a75.5.2 for j\u2260i case), the $n$-th derivative satisfies:\n2082: \n2083: $$\n2084: \\|\\nabla^n_{x_i} f_\\ell\\| \\leq C_{f,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n}) \\cdot \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2085: \n2086: $$\n2087: \n2088: where $C_{f,n} = \\mathcal{O}(n!)$ (Gevrey-1).\n2089: \n2090: **Summing over $\\ell$**:\n2091: \n2092: $$\n2093: \\|\\nabla^n_{x_i} N_i\\| \\leq \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\|\\nabla^n_{x_i} f_\\ell\\| \\leq C_{f,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n}) \\cdot \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2094: \n2095: $$\n2096: \n2097: **Step 2: Apply sum-to-integral bound.**\n2098: \n2099: By Lemma {prf:ref}`lem-sum-to-integral-bound-full` with $f \\equiv 1$:\n2100: \n2101: $$\n2102: \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{i\\}} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right) \\leq \\rho_{\\max} \\cdot (2\\pi\\varepsilon_c^2)^d \\cdot C_{\\lambda}\n2103: \n2104: $$\n2105: \n2106: This bound is **k-uniform**: it depends only on $(\\rho_{\\max}, \\varepsilon_c, d)$, **not on $k$**.\n2107: \n2108: Therefore:\n2109: \n2110: $$\n2111: \\|\\nabla^n_{x_i} N_i\\| \\leq C_{f,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n}) \\cdot \\rho_{\\max} (2\\pi\\varepsilon_c^2)^d C_{\\lambda}\n2112: \n2113: $$\n2114: \n2115: **Step 3: Derivatives of partition function $Z_i$.**\n2116: \n2117: Similarly, for the exponential terms in $Z_i$:\n2118: \n2119: $$\n2120: \\|\\nabla^n_{x_i} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\\| \\leq C_{K,n} \\varepsilon_c^{-n} \\exp\\left(-\\frac{d_{\\text{alg}}^2(i,\\ell)}{2\\varepsilon_c^2}\\right)\n2121: \n2122: $$\n2123: \n2124: Summing and applying the sum-to-integral bound:\n2125: \n2126: $$\n2127: \\|\\nabla^n_{x_i} Z_i\\| \\leq C_{K,n} \\varepsilon_c^{-n} \\cdot \\rho_{\\max} (2\\pi\\varepsilon_c^2)^d C_{\\lambda}\n2128: \n2129: $$\n2130: \n2131: which is **k-uniform**.\n2132: \n2133: **Step 4: Quotient rule for $d_i = N_i / Z_i$.**\n2134: \n2135: By the generalized quotient rule (Fa\u00e0 di Bruno formula), the derivatives of $d_i$ involve products of $\\nabla^k N_i$ and $\\nabla^\\ell Z_i$ with $k + \\ell \\leq n$, divided by powers of $Z_i$.\n2136: \n2137: **Lower bound for $Z_i$**: By Lemma {prf:ref}`lem-companion-availability-enforcement`:\n2138: \n2139: $$\n2140: Z_i \\geq \\exp\\left(-\\frac{D_{\\max}^2}{2\\varepsilon_c^2}\\right) =: Z_{\\min} > 0\n2141: \n2142: $$\n2143: \n2144: Combining the bounds from Steps 2-3 and applying the quotient rule:\n2145: \n2146: $$\n2147: \\|\\nabla^n_{x_i} d_i\\| \\leq C_{d_i,n} \\cdot \\max(\\varepsilon_d^{1-n}, \\varepsilon_d \\varepsilon_c^{-n})\n2148: \n2149: $$\n2150: \n2151: where $C_{d_i,n} = \\mathcal{O}(n!)$ arises from:\n2152: - Fa\u00e0 di Bruno combinatorics: $\\mathcal{O}(n!)$\n2153: - Factorial growth from $C_{f,n}, C_{K,n}$: each $\\mathcal{O}(n!)$\n2154: - **k-uniform factors**: $\\rho_{\\max} (2\\pi\\varepsilon_c^2)^d C_{\\lambda} / Z_{\\min}$ (no $k$-dependence)\n2155: \n2156: **Conclusion**: The constant $C_{d_i,n}$ is **k-uniform** because the sum over companions is controlled by the sum-to-integral bound (Lemma {prf:ref}`lem-sum-to-integral-bound-full`), which replaces the naive $\\mathcal{O}(k)$ factor with $\\mathcal{O}(\\rho_{\\max} \\varepsilon_c^{2d})$ (independent of $k$).\n2157: "
    }
  ],
  "validation": {
    "ok": true,
    "errors": []
  }
}