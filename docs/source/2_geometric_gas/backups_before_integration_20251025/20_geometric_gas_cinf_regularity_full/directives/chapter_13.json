{
  "chapter_index": 13,
  "section_id": "## 7. Companion-Dependent Measurements: Handling N-Body Coupling",
  "directive_count": 4,
  "hints": [
    {
      "directive_type": "lemma",
      "label": "lem-derivatives-companion-distance-full",
      "title": "Derivatives of Companion-Dependent Distance",
      "start_line": 3311,
      "end_line": 3323,
      "header_lines": [
        3312
      ],
      "content_start": 3314,
      "content_end": 3322,
      "content": "3314: :label: lem-derivatives-companion-distance-full\n3315: \n3316: For measurement $d_j = d_{\\text{alg}}(j, c(j))$ where $c(j)$ is selected via softmax, the derivative with respect to $x_i$ is:\n3317: \n3318: $$\n3319: \\frac{\\partial d_j}{\\partial x_i} = \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{j\\}} \\mathbb{P}(c(j) = \\ell) \\cdot \\frac{\\partial d_{\\text{alg}}(j, \\ell)}{\\partial x_i}\n3320: + \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{j\\}} d_{\\text{alg}}(j, \\ell) \\cdot \\frac{\\partial \\mathbb{P}(c(j) = \\ell)}{\\partial x_i}\n3321: \n3322: $$",
      "metadata": {
        "label": "lem-derivatives-companion-distance-full"
      },
      "section": "## 7. Companion-Dependent Measurements: Handling N-Body Coupling",
      "references": [],
      "raw_directive": "3311: ### 7.1 Derivative Structure of Companion-Dependent Measurements\n3312: \n3313: :::{prf:lemma} Derivatives of Companion-Dependent Distance\n3314: :label: lem-derivatives-companion-distance-full\n3315: \n3316: For measurement $d_j = d_{\\text{alg}}(j, c(j))$ where $c(j)$ is selected via softmax, the derivative with respect to $x_i$ is:\n3317: \n3318: $$\n3319: \\frac{\\partial d_j}{\\partial x_i} = \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{j\\}} \\mathbb{P}(c(j) = \\ell) \\cdot \\frac{\\partial d_{\\text{alg}}(j, \\ell)}{\\partial x_i}\n3320: + \\sum_{\\ell \\in \\mathcal{A} \\setminus \\{j\\}} d_{\\text{alg}}(j, \\ell) \\cdot \\frac{\\partial \\mathbb{P}(c(j) = \\ell)}{\\partial x_i}\n3321: \n3322: $$\n3323: "
    },
    {
      "directive_type": "proof",
      "label": "unlabeled-proof-19",
      "title": null,
      "start_line": 3325,
      "end_line": 3334,
      "header_lines": [],
      "content_start": 3326,
      "content_end": 3333,
      "content": "3326: \n3327: :::{prf:proof}\n3328: Since $d_j = \\sum_\\ell \\mathbb{P}(c(j) = \\ell) \\cdot d_{\\text{alg}}(j, \\ell)$ (expectation over softmax):\n3329: \n3330: $$\n3331: \\frac{\\partial d_j}{\\partial x_i} = \\sum_\\ell \\frac{\\partial}{\\partial x_i} [\\mathbb{P}(c(j) = \\ell) \\cdot d_{\\text{alg}}(j, \\ell)]\n3332: \n3333: $$",
      "metadata": {},
      "section": "## 7. Companion-Dependent Measurements: Handling N-Body Coupling",
      "references": [],
      "raw_directive": "3325: :::\n3326: \n3327: :::{prf:proof}\n3328: Since $d_j = \\sum_\\ell \\mathbb{P}(c(j) = \\ell) \\cdot d_{\\text{alg}}(j, \\ell)$ (expectation over softmax):\n3329: \n3330: $$\n3331: \\frac{\\partial d_j}{\\partial x_i} = \\sum_\\ell \\frac{\\partial}{\\partial x_i} [\\mathbb{P}(c(j) = \\ell) \\cdot d_{\\text{alg}}(j, \\ell)]\n3332: \n3333: $$\n3334: "
    },
    {
      "directive_type": "theorem",
      "label": "thm-cluster-localized-derivative-bounds-full",
      "title": "Cluster-Localized Derivative Bounds",
      "start_line": 3340,
      "end_line": 3353,
      "header_lines": [
        3341
      ],
      "content_start": 3343,
      "content_end": 3352,
      "content": "3343: :label: thm-cluster-localized-derivative-bounds-full\n3344: \n3345: Using the smooth partition $\\{\\psi_m\\}$ from {prf:ref}`def-smooth-phase-space-partition-full`, the derivative $\\partial d_j / \\partial x_i$ satisfies:\n3346: \n3347: $$\n3348: \\left\\|\\frac{\\partial d_j}{\\partial x_i}\\right\\| \\leq \\sum_{m,m'=1}^M \\psi_m(x_i, v_i) \\cdot \\psi_{m'}(x_j, v_j) \\cdot C_{i \\leftrightarrow j}^{(m,m')}\n3349: \n3350: $$\n3351: \n3352: where:",
      "metadata": {
        "label": "thm-cluster-localized-derivative-bounds-full"
      },
      "section": "## 7. Companion-Dependent Measurements: Handling N-Body Coupling",
      "references": [
        "def-smooth-phase-space-partition-full"
      ],
      "raw_directive": "3340: The key to controlling this N-body coupling is the **smooth clustering framework**:\n3341: \n3342: :::{prf:theorem} Cluster-Localized Derivative Bounds\n3343: :label: thm-cluster-localized-derivative-bounds-full\n3344: \n3345: Using the smooth partition $\\{\\psi_m\\}$ from {prf:ref}`def-smooth-phase-space-partition-full`, the derivative $\\partial d_j / \\partial x_i$ satisfies:\n3346: \n3347: $$\n3348: \\left\\|\\frac{\\partial d_j}{\\partial x_i}\\right\\| \\leq \\sum_{m,m'=1}^M \\psi_m(x_i, v_i) \\cdot \\psi_{m'}(x_j, v_j) \\cdot C_{i \\leftrightarrow j}^{(m,m')}\n3349: \n3350: $$\n3351: \n3352: where:\n3353: - **Intra-cluster coupling** ($m = m'$): $C_{i \\leftrightarrow j}^{(m,m)} = \\mathcal{O}(1)$ when $d_{\\text{alg}}(i,j) \\leq 2\\varepsilon_c$"
    },
    {
      "directive_type": "proof",
      "label": "unlabeled-proof-49",
      "title": null,
      "start_line": 3355,
      "end_line": 3444,
      "header_lines": [],
      "content_start": 3356,
      "content_end": 3443,
      "content": "3356: \n3357: :::{prf:proof}\n3358: **Step 1: Partition of unity decomposition.**\n3359: \n3360: Using the smooth partition $\\{\\psi_m\\}_{m=1}^M$ from {prf:ref}`def-smooth-phase-space-partition-full`, we have:\n3361: \n3362: $$\n3363: 1 = \\sum_{m=1}^M \\psi_m(x_i, v_i) \\quad \\text{and} \\quad 1 = \\sum_{m'=1}^M \\psi_{m'}(x_j, v_j)\n3364: \n3365: $$\n3366: \n3367: Therefore, for any function $F(x_i, v_i, x_j, v_j)$:\n3368: \n3369: $$\n3370: F = \\sum_{m,m'=1}^M \\psi_m(x_i, v_i) \\cdot \\psi_{m'}(x_j, v_j) \\cdot F\n3371: \n3372: $$\n3373: \n3374: Applying this to $\\partial d_j / \\partial x_i$:\n3375: \n3376: $$\n3377: \\frac{\\partial d_j}{\\partial x_i} = \\sum_{m,m'=1}^M \\psi_m(x_i, v_i) \\psi_{m'}(x_j, v_j) \\frac{\\partial d_j}{\\partial x_i}\n3378: \n3379: $$\n3380: \n3381: **Step 2: Intra-cluster bound** ($m = m'$).\n3382: \n3383: When walkers $i$ and $j$ both have non-zero membership in the same cluster $m$:\n3384: - Walker $i$ satisfies: $\\psi_m(x_i, v_i) > 0 \\Rightarrow d_{\\text{alg}}(i, \\text{center}_m) \\leq 2\\varepsilon_c$ (support of $\\psi_m$)\n3385: - Walker $j$ satisfies: $\\psi_m(x_j, v_j) > 0 \\Rightarrow d_{\\text{alg}}(j, \\text{center}_m) \\leq 2\\varepsilon_c$\n3386: \n3387: By the triangle inequality:\n3388: \n3389: $$\n3390: d_{\\text{alg}}(i, j) \\leq d_{\\text{alg}}(i, \\text{center}_m) + d_{\\text{alg}}(j, \\text{center}_m) \\leq 4\\varepsilon_c\n3391: \n3392: $$\n3393: \n3394: From Lemma {prf:ref}`lem-companion-measurement-derivatives-full`:\n3395: \n3396: $$\n3397: \\left\\|\\frac{\\partial d_j}{\\partial x_i}\\right\\| \\leq C_{d_j,1} \\cdot \\max(1, \\varepsilon_d \\varepsilon_c^{-1}) = \\mathcal{O}(1)\n3398: \n3399: $$\n3400: \n3401: Therefore: $C_{i \\leftrightarrow j}^{(m,m)} = C_{d_j,1} = \\mathcal{O}(1)$.\n3402: \n3403: **Step 3: Inter-cluster bound** ($m \\neq m'$).\n3404: \n3405: When walkers belong to different clusters ($m \\neq m'$):\n3406: - Walker $i$ in cluster $m$: $d_{\\text{alg}}(i, \\text{center}_m) \\leq 2\\varepsilon_c$\n3407: - Walker $j$ in cluster $m'$: $d_{\\text{alg}}(j, \\text{center}_{m'}) \\leq 2\\varepsilon_c$\n3408: \n3409: By the triangle inequality (lower bound):\n3410: \n3411: $$\n3412: d_{\\text{alg}}(i, j) \\geq D_{\\text{sep}}(m, m') - 4\\varepsilon_c\n3413: \n3414: $$\n3415: \n3416: where $D_{\\text{sep}}(m, m') := d_{\\text{alg}}(\\text{center}_m, \\text{center}_{m'})$ is the cluster separation distance.\n3417: \n3418: The derivative involves the softmax probability (from Lemma {prf:ref}`lem-derivatives-companion-distance-full`). The key term is:\n3419: \n3420: $$\n3421: \\frac{\\partial \\mathbb{P}(c(j) = \\ell)}{\\partial x_i} \\sim \\mathbb{P}(c(j) = \\ell) \\cdot \\nabla_{x_i} \\left[-\\frac{d_{\\text{alg}}^2(j, \\ell)}{2\\varepsilon_c^2}\\right]\n3422: \n3423: $$\n3424: \n3425: For walkers $i, j$ in different clusters, the softmax probability for walker $i$ to be the companion of walker $j$ is exponentially suppressed:\n3426: \n3427: $$\n3428: \\mathbb{P}(c(j) = i) \\leq \\frac{\\exp(-d_{\\text{alg}}^2(i,j)/(2\\varepsilon_c^2))}{\\exp(-R_{\\max}^2/(2\\varepsilon_c^2))} \\leq \\exp\\left(-\\frac{(D_{\\text{sep}} - 4\\varepsilon_c)^2 - R_{\\max}^2}{2\\varepsilon_c^2}\\right)\n3429: \n3430: $$\n3431: \n3432: where we used the partition function lower bound from {prf:ref}`lem-companion-availability-enforcement`.\n3433: \n3434: For well-separated clusters ($D_{\\text{sep}} \\gg \\varepsilon_c$), this gives:\n3435: \n3436: $$\n3437: C_{i \\leftrightarrow j}^{(m,m')} = \\mathcal{O}\\left(\\exp\\left(-\\frac{D_{\\text{sep}}^2(m,m')}{2\\varepsilon_c^2}\\right)\\right)\n3438: \n3439: $$\n3440: \n3441: **Conclusion**: The decomposition splits the derivative into:\n3442: - **Intra-cluster terms** ($m = m'$): $\\mathcal{O}(1)$ contributions from nearby walkers\n3443: - **Inter-cluster terms** ($m \\neq m'$): Exponentially suppressed contributions from distant walkers",
      "metadata": {},
      "section": "## 7. Companion-Dependent Measurements: Handling N-Body Coupling",
      "references": [
        "def-smooth-phase-space-partition-full",
        "lem-companion-measurement-derivatives-full",
        "lem-derivatives-companion-distance-full",
        "lem-companion-availability-enforcement"
      ],
      "raw_directive": "3355: :::\n3356: \n3357: :::{prf:proof}\n3358: **Step 1: Partition of unity decomposition.**\n3359: \n3360: Using the smooth partition $\\{\\psi_m\\}_{m=1}^M$ from {prf:ref}`def-smooth-phase-space-partition-full`, we have:\n3361: \n3362: $$\n3363: 1 = \\sum_{m=1}^M \\psi_m(x_i, v_i) \\quad \\text{and} \\quad 1 = \\sum_{m'=1}^M \\psi_{m'}(x_j, v_j)\n3364: \n3365: $$\n3366: \n3367: Therefore, for any function $F(x_i, v_i, x_j, v_j)$:\n3368: \n3369: $$\n3370: F = \\sum_{m,m'=1}^M \\psi_m(x_i, v_i) \\cdot \\psi_{m'}(x_j, v_j) \\cdot F\n3371: \n3372: $$\n3373: \n3374: Applying this to $\\partial d_j / \\partial x_i$:\n3375: \n3376: $$\n3377: \\frac{\\partial d_j}{\\partial x_i} = \\sum_{m,m'=1}^M \\psi_m(x_i, v_i) \\psi_{m'}(x_j, v_j) \\frac{\\partial d_j}{\\partial x_i}\n3378: \n3379: $$\n3380: \n3381: **Step 2: Intra-cluster bound** ($m = m'$).\n3382: \n3383: When walkers $i$ and $j$ both have non-zero membership in the same cluster $m$:\n3384: - Walker $i$ satisfies: $\\psi_m(x_i, v_i) > 0 \\Rightarrow d_{\\text{alg}}(i, \\text{center}_m) \\leq 2\\varepsilon_c$ (support of $\\psi_m$)\n3385: - Walker $j$ satisfies: $\\psi_m(x_j, v_j) > 0 \\Rightarrow d_{\\text{alg}}(j, \\text{center}_m) \\leq 2\\varepsilon_c$\n3386: \n3387: By the triangle inequality:\n3388: \n3389: $$\n3390: d_{\\text{alg}}(i, j) \\leq d_{\\text{alg}}(i, \\text{center}_m) + d_{\\text{alg}}(j, \\text{center}_m) \\leq 4\\varepsilon_c\n3391: \n3392: $$\n3393: \n3394: From Lemma {prf:ref}`lem-companion-measurement-derivatives-full`:\n3395: \n3396: $$\n3397: \\left\\|\\frac{\\partial d_j}{\\partial x_i}\\right\\| \\leq C_{d_j,1} \\cdot \\max(1, \\varepsilon_d \\varepsilon_c^{-1}) = \\mathcal{O}(1)\n3398: \n3399: $$\n3400: \n3401: Therefore: $C_{i \\leftrightarrow j}^{(m,m)} = C_{d_j,1} = \\mathcal{O}(1)$.\n3402: \n3403: **Step 3: Inter-cluster bound** ($m \\neq m'$).\n3404: \n3405: When walkers belong to different clusters ($m \\neq m'$):\n3406: - Walker $i$ in cluster $m$: $d_{\\text{alg}}(i, \\text{center}_m) \\leq 2\\varepsilon_c$\n3407: - Walker $j$ in cluster $m'$: $d_{\\text{alg}}(j, \\text{center}_{m'}) \\leq 2\\varepsilon_c$\n3408: \n3409: By the triangle inequality (lower bound):\n3410: \n3411: $$\n3412: d_{\\text{alg}}(i, j) \\geq D_{\\text{sep}}(m, m') - 4\\varepsilon_c\n3413: \n3414: $$\n3415: \n3416: where $D_{\\text{sep}}(m, m') := d_{\\text{alg}}(\\text{center}_m, \\text{center}_{m'})$ is the cluster separation distance.\n3417: \n3418: The derivative involves the softmax probability (from Lemma {prf:ref}`lem-derivatives-companion-distance-full`). The key term is:\n3419: \n3420: $$\n3421: \\frac{\\partial \\mathbb{P}(c(j) = \\ell)}{\\partial x_i} \\sim \\mathbb{P}(c(j) = \\ell) \\cdot \\nabla_{x_i} \\left[-\\frac{d_{\\text{alg}}^2(j, \\ell)}{2\\varepsilon_c^2}\\right]\n3422: \n3423: $$\n3424: \n3425: For walkers $i, j$ in different clusters, the softmax probability for walker $i$ to be the companion of walker $j$ is exponentially suppressed:\n3426: \n3427: $$\n3428: \\mathbb{P}(c(j) = i) \\leq \\frac{\\exp(-d_{\\text{alg}}^2(i,j)/(2\\varepsilon_c^2))}{\\exp(-R_{\\max}^2/(2\\varepsilon_c^2))} \\leq \\exp\\left(-\\frac{(D_{\\text{sep}} - 4\\varepsilon_c)^2 - R_{\\max}^2}{2\\varepsilon_c^2}\\right)\n3429: \n3430: $$\n3431: \n3432: where we used the partition function lower bound from {prf:ref}`lem-companion-availability-enforcement`.\n3433: \n3434: For well-separated clusters ($D_{\\text{sep}} \\gg \\varepsilon_c$), this gives:\n3435: \n3436: $$\n3437: C_{i \\leftrightarrow j}^{(m,m')} = \\mathcal{O}\\left(\\exp\\left(-\\frac{D_{\\text{sep}}^2(m,m')}{2\\varepsilon_c^2}\\right)\\right)\n3438: \n3439: $$\n3440: \n3441: **Conclusion**: The decomposition splits the derivative into:\n3442: - **Intra-cluster terms** ($m = m'$): $\\mathcal{O}(1)$ contributions from nearby walkers\n3443: - **Inter-cluster terms** ($m \\neq m'$): Exponentially suppressed contributions from distant walkers\n3444: "
    }
  ],
  "validation": {
    "ok": true,
    "errors": []
  }
}