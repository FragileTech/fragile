{
  "chapter_index": 14,
  "section_id": "## 13. Companion Selection Flux Balance at Stationarity",
  "directive_count": 2,
  "hints": [
    {
      "directive_type": "lemma",
      "label": "lem-companion-flux-balance",
      "title": "Companion Flux Balance at QSD",
      "start_line": 3829,
      "end_line": 3847,
      "header_lines": [
        3830
      ],
      "content_start": 3832,
      "content_end": 3846,
      "content": "3832: :label: lem-companion-flux-balance\n3833: \n3834: At the quasi-stationary distribution (QSD), the companion selection flux satisfies a geometric balance condition. For any walker $i$ in the alive set:\n3835: \n3836: $$\n3837: \\sum_{j \\in \\mathcal{A}, j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) = p_i(S) \\cdot \\sqrt{\\frac{\\det g(x_i)}{\\langle \\det g \\rangle}}\n3838: $$\n3839: \n3840: where:\n3841: - $P_{\\text{comp}}(i|j; S) \\propto 1/d_{\\text{alg}}(j,i)^{2+\\nu}$ is the companion selection probability\n3842: - $p_i(S) = \\mathbb{E}_{c \\sim P_{\\text{comp}}}[\\text{clip}(S_i(c)/p_{\\max})]$ is the cloning probability\n3843: - $g(x_i)$ is the emergent Riemannian metric at position $x_i$\n3844: - $\\langle \\det g \\rangle = \\frac{1}{|\\mathcal{A}|}\\sum_{k \\in \\mathcal{A}} \\sqrt{\\det g(x_k)}$ is the mean metric determinant\n3845: \n3846: **Physical interpretation**: The left side is the **rate at which walker $i$ is selected as a companion** by all other walkers. The right side is the **rate at which walker $i$ selects companions**, weighted by the local geometric volume factor $\\sqrt{\\det g(x_i)}$.",
      "metadata": {
        "label": "lem-companion-flux-balance"
      },
      "section": "## 13. Companion Selection Flux Balance at Stationarity",
      "references": [
        "thm-qsd-spatial-riemannian-volume"
      ],
      "raw_directive": "3829: This section proves a critical result connecting the microscopic companion selection dynamics to the emergent Riemannian geometry at the quasi-stationary distribution (QSD).\n3830: \n3831: :::{prf:lemma} Companion Flux Balance at QSD\n3832: :label: lem-companion-flux-balance\n3833: \n3834: At the quasi-stationary distribution (QSD), the companion selection flux satisfies a geometric balance condition. For any walker $i$ in the alive set:\n3835: \n3836: $$\n3837: \\sum_{j \\in \\mathcal{A}, j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) = p_i(S) \\cdot \\sqrt{\\frac{\\det g(x_i)}{\\langle \\det g \\rangle}}\n3838: $$\n3839: \n3840: where:\n3841: - $P_{\\text{comp}}(i|j; S) \\propto 1/d_{\\text{alg}}(j,i)^{2+\\nu}$ is the companion selection probability\n3842: - $p_i(S) = \\mathbb{E}_{c \\sim P_{\\text{comp}}}[\\text{clip}(S_i(c)/p_{\\max})]$ is the cloning probability\n3843: - $g(x_i)$ is the emergent Riemannian metric at position $x_i$\n3844: - $\\langle \\det g \\rangle = \\frac{1}{|\\mathcal{A}|}\\sum_{k \\in \\mathcal{A}} \\sqrt{\\det g(x_k)}$ is the mean metric determinant\n3845: \n3846: **Physical interpretation**: The left side is the **rate at which walker $i$ is selected as a companion** by all other walkers. The right side is the **rate at which walker $i$ selects companions**, weighted by the local geometric volume factor $\\sqrt{\\det g(x_i)}$.\n3847: "
    },
    {
      "directive_type": "proof",
      "label": "unlabeled-proof-23",
      "title": null,
      "start_line": 3849,
      "end_line": 3976,
      "header_lines": [],
      "content_start": 3850,
      "content_end": 3975,
      "content": "3850: \n3851: :::{prf:proof}\n3852: **Strategy**: We show that at stationarity, the detailed balance condition for the cloning operator implies this flux balance through the Riemannian volume measure.\n3853: \n3854: **Part 1: Stationary Master Equation**\n3855: \n3856: At the QSD, the probability flux into and out of any configuration must balance. For the cloning operator, this reads:\n3857: \n3858: $$\n3859: \\sum_{X'} T_{\\text{clone}}(X \\to X') \\pi_{\\text{QSD}}(X) = \\sum_{X'} T_{\\text{clone}}(X' \\to X) \\pi_{\\text{QSD}}(X')\n3860: $$\n3861: \n3862: Focus on transitions where walker $i$ is replaced. The incoming flux (walker $i$ is created by some $j$ cloning from $k$) equals the outgoing flux (walker $i$ clones and is replaced).\n3863: \n3864: **Part 2: Spatial Marginal and Factorization**\n3865: \n3866: From Theorem {prf:ref}`thm-qsd-spatial-riemannian-volume` in Appendix A.1, the spatial marginal of QSD is:\n3867: \n3868: $$\n3869: \\rho_{\\text{spatial}}(x) \\propto \\sqrt{\\det g(x)} \\exp(-U_{\\text{eff}}(x)/T)\n3870: $$\n3871: \n3872: In the mean-field limit $N \\to \\infty$, the QSD factorizes as:\n3873: \n3874: $$\n3875: \\pi_{\\text{QSD}}(X) \\approx \\prod_{i=1}^N \\rho_1(x_i, v_i)\n3876: $$\n3877: \n3878: where $\\rho_1(x, v) \\propto \\sqrt{\\det g(x)} \\exp(-H_{\\text{eff}}(x,v)/T)$ is the single-particle density.\n3879: \n3880: **Part 3: Explicit Form of Single-Particle Density**\n3881: \n3882: From Part 2, the single-particle density at walker $i$'s state $(x_i, v_i)$ is:\n3883: \n3884: $$\n3885: \\rho_1(x_i, v_i) = C \\cdot \\sqrt{\\det g(x_i)} \\cdot \\exp(-H_{\\text{eff}}(x_i, v_i)/T)\n3886: $$\n3887: \n3888: where $C$ is a normalization constant. The key point: the **geometric factor $\\sqrt{\\det g(x_i)}$ is already present** in the stationary density.\n3889: \n3890: **Part 4: Cloning Flux Computation with Geometric Factors**\n3891: \n3892: The **outgoing flux** from walker $i$ (rate at which walker $i$ is replaced by cloning):\n3893: \n3894: $$\n3895: \\Gamma_{\\text{out}}(i) = p_i(S) \\cdot \\rho_1(x_i, v_i) = p_i(S) \\cdot C \\cdot \\sqrt{\\det g(x_i)} \\cdot e^{-H_{\\text{eff}}(x_i, v_i)/T}\n3896: $$\n3897: \n3898: where $p_i(S) = \\mathbb{E}_{c \\sim P_{\\text{comp}}}[\\text{clip}(S_i(c)/p_{\\max})]$ is the total cloning probability for walker $i$.\n3899: \n3900: The **incoming flux** to position $x_i$ (rate at which other walkers clone to create a new walker near $x_i$):\n3901: \n3902: $$\n3903: \\begin{align}\n3904: \\Gamma_{\\text{in}}(i) &= \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\rho_1(x_j, v_j) \\cdot K_{\\text{clone}}(x_j \\to x_i) \\\\\n3905: &\\approx \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\rho_1(x_j, v_j)\n3906: \\end{align}\n3907: $$\n3908: \n3909: where the second line uses the **local cloning approximation**: $K_{\\text{clone}}(x_j \\to x_i) \\approx \\delta(x_i - x_j)$ in the continuum limit (see justification below).\n3910: \n3911: **Crucially**, $\\rho_1(x_j, v_j)$ includes the factor $\\sqrt{\\det g(x_j)}$ from Part 3:\n3912: \n3913: $$\n3914: \\Gamma_{\\text{in}}(i) \\approx \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot C \\cdot \\sqrt{\\det g(x_j)} \\cdot e^{-H_{\\text{eff}}(x_j, v_j)/T}\n3915: $$\n3916: \n3917: **Justification of local cloning**: The cloning kernel $K_{\\text{clone}}(x_j \\to x_i) \\propto \\exp(-\\|x_i - x_j\\|^2/2\\sigma_{\\text{clone}}^2)$ has width $\\sigma_{\\text{clone}}$ much smaller than the typical distance over which $g(x)$ varies. In the continuum limit $N \\to \\infty$ with inter-particle spacing $O(N^{-1/d})$, the kernel converges weakly to $\\delta(x_i - x_j)$, making cloning effectively local.\n3918: \n3919: **Part 5: Stationarity and Geometric Balance**\n3920: \n3921: At stationarity, $\\Gamma_{\\text{in}}(i) = \\Gamma_{\\text{out}}(i)$. Using the explicit forms from Part 4:\n3922: \n3923: $$\n3924: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot C \\cdot \\sqrt{\\det g(x_j)} \\cdot e^{-H_{\\text{eff}}(x_j, v_j)/T} = p_i(S) \\cdot C \\cdot \\sqrt{\\det g(x_i)} \\cdot e^{-H_{\\text{eff}}(x_i, v_i)/T}\n3925: $$\n3926: \n3927: **Velocity thermalization**: On the timescale of spatial cloning dynamics, velocities rapidly thermalize to the Maxwell-Boltzmann distribution (Lemma {prf:ref}`lem-velocity-marginalization` in Appendix A.2). Therefore, for walkers at the same position $x$, the velocity-dependent factors $e^{-H_{\\text{eff}}/T}$ average out, and we can write:\n3928: \n3929: $$\n3930: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\sqrt{\\det g(x_j)} = p_i(S) \\cdot \\sqrt{\\det g(x_i)}\n3931: $$\n3932: \n3933: **Mean-field approximation**: In the large-$N$ limit, walkers are distributed according to the spatial marginal $\\rho_{\\text{spatial}}(x) \\propto \\sqrt{\\det g(x)} \\exp(-U_{\\text{eff}}(x)/T)$. For a sum over $j$ weighted by $P_{\\text{comp}}(i|j; S)$ (which depends on the swarm distribution), the geometric factors at different positions satisfy:\n3934: \n3935: $$\n3936: \\frac{1}{|\\mathcal{A}|} \\sum_{j \\in \\mathcal{A}} \\sqrt{\\det g(x_j)} \\xrightarrow{N \\to \\infty} \\langle \\det g \\rangle := \\frac{1}{|\\mathcal{A}|} \\sum_{k \\in \\mathcal{A}} \\sqrt{\\det g(x_k)}\n3937: $$\n3938: \n3939: where the convergence holds by the law of large numbers applied to the spatial marginal.\n3940: \n3941: Dividing both sides of the flux balance by $\\sqrt{\\det g(x_i)}$ and using the mean-field approximation:\n3942: \n3943: $$\n3944: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\frac{\\sqrt{\\det g(x_j)}}{\\sqrt{\\det g(x_i)}} = p_i(S)\n3945: $$\n3946: \n3947: **Weighted average convergence**: Define the selection-weighted average:\n3948: \n3949: $$\n3950: \\langle f \\rangle_{i,S} := \\frac{\\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot f(x_j)}{\\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S)}\n3951: $$\n3952: \n3953: For sufficiently smooth functions $f$, standard mean-field theory (McKean-Vlasov propagation of chaos; see Sznitman *Topics in propagation of chaos*, 1991, \u00a73) gives:\n3954: \n3955: $$\n3956: \\mathbb{E}_{X \\sim \\pi_{\\text{QSD}}}[\\langle f \\rangle_{i,S}] \\xrightarrow{N \\to \\infty} \\int_{\\mathcal{X}} f(x) \\rho_{\\text{spatial}}(x) \\, dx\n3957: $$\n3958: \n3959: with variance $\\text{Var}[\\langle f \\rangle_{i,S}] = O(1/N)$. Applying this with $f(x) = \\sqrt{\\det g(x)}$ and using concentration of measure, the weighted average converges to the spatial mean $\\langle \\det g \\rangle$ with high probability. Therefore:\n3960: \n3961: $$\n3962: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\sqrt{\\det g(x_j)} \\approx \\left[\\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S)\\right] \\cdot \\langle \\det g \\rangle\n3963: $$\n3964: \n3965: which gives:\n3966: \n3967: $$\n3968: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\approx p_i(S) \\cdot \\frac{\\langle \\det g \\rangle}{\\sqrt{\\det g(x_i)}}\n3969: $$\n3970: \n3971: Rearranging gives the flux balance condition:\n3972: \n3973: $$\n3974: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) = p_i(S) \\cdot \\sqrt{\\frac{\\det g(x_i)}{\\langle \\det g \\rangle}}\n3975: $$",
      "metadata": {},
      "section": "## 13. Companion Selection Flux Balance at Stationarity",
      "references": [
        "thm-qsd-spatial-riemannian-volume",
        "lem-velocity-marginalization"
      ],
      "raw_directive": "3849: :::\n3850: \n3851: :::{prf:proof}\n3852: **Strategy**: We show that at stationarity, the detailed balance condition for the cloning operator implies this flux balance through the Riemannian volume measure.\n3853: \n3854: **Part 1: Stationary Master Equation**\n3855: \n3856: At the QSD, the probability flux into and out of any configuration must balance. For the cloning operator, this reads:\n3857: \n3858: $$\n3859: \\sum_{X'} T_{\\text{clone}}(X \\to X') \\pi_{\\text{QSD}}(X) = \\sum_{X'} T_{\\text{clone}}(X' \\to X) \\pi_{\\text{QSD}}(X')\n3860: $$\n3861: \n3862: Focus on transitions where walker $i$ is replaced. The incoming flux (walker $i$ is created by some $j$ cloning from $k$) equals the outgoing flux (walker $i$ clones and is replaced).\n3863: \n3864: **Part 2: Spatial Marginal and Factorization**\n3865: \n3866: From Theorem {prf:ref}`thm-qsd-spatial-riemannian-volume` in Appendix A.1, the spatial marginal of QSD is:\n3867: \n3868: $$\n3869: \\rho_{\\text{spatial}}(x) \\propto \\sqrt{\\det g(x)} \\exp(-U_{\\text{eff}}(x)/T)\n3870: $$\n3871: \n3872: In the mean-field limit $N \\to \\infty$, the QSD factorizes as:\n3873: \n3874: $$\n3875: \\pi_{\\text{QSD}}(X) \\approx \\prod_{i=1}^N \\rho_1(x_i, v_i)\n3876: $$\n3877: \n3878: where $\\rho_1(x, v) \\propto \\sqrt{\\det g(x)} \\exp(-H_{\\text{eff}}(x,v)/T)$ is the single-particle density.\n3879: \n3880: **Part 3: Explicit Form of Single-Particle Density**\n3881: \n3882: From Part 2, the single-particle density at walker $i$'s state $(x_i, v_i)$ is:\n3883: \n3884: $$\n3885: \\rho_1(x_i, v_i) = C \\cdot \\sqrt{\\det g(x_i)} \\cdot \\exp(-H_{\\text{eff}}(x_i, v_i)/T)\n3886: $$\n3887: \n3888: where $C$ is a normalization constant. The key point: the **geometric factor $\\sqrt{\\det g(x_i)}$ is already present** in the stationary density.\n3889: \n3890: **Part 4: Cloning Flux Computation with Geometric Factors**\n3891: \n3892: The **outgoing flux** from walker $i$ (rate at which walker $i$ is replaced by cloning):\n3893: \n3894: $$\n3895: \\Gamma_{\\text{out}}(i) = p_i(S) \\cdot \\rho_1(x_i, v_i) = p_i(S) \\cdot C \\cdot \\sqrt{\\det g(x_i)} \\cdot e^{-H_{\\text{eff}}(x_i, v_i)/T}\n3896: $$\n3897: \n3898: where $p_i(S) = \\mathbb{E}_{c \\sim P_{\\text{comp}}}[\\text{clip}(S_i(c)/p_{\\max})]$ is the total cloning probability for walker $i$.\n3899: \n3900: The **incoming flux** to position $x_i$ (rate at which other walkers clone to create a new walker near $x_i$):\n3901: \n3902: $$\n3903: \\begin{align}\n3904: \\Gamma_{\\text{in}}(i) &= \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\rho_1(x_j, v_j) \\cdot K_{\\text{clone}}(x_j \\to x_i) \\\\\n3905: &\\approx \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\rho_1(x_j, v_j)\n3906: \\end{align}\n3907: $$\n3908: \n3909: where the second line uses the **local cloning approximation**: $K_{\\text{clone}}(x_j \\to x_i) \\approx \\delta(x_i - x_j)$ in the continuum limit (see justification below).\n3910: \n3911: **Crucially**, $\\rho_1(x_j, v_j)$ includes the factor $\\sqrt{\\det g(x_j)}$ from Part 3:\n3912: \n3913: $$\n3914: \\Gamma_{\\text{in}}(i) \\approx \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot C \\cdot \\sqrt{\\det g(x_j)} \\cdot e^{-H_{\\text{eff}}(x_j, v_j)/T}\n3915: $$\n3916: \n3917: **Justification of local cloning**: The cloning kernel $K_{\\text{clone}}(x_j \\to x_i) \\propto \\exp(-\\|x_i - x_j\\|^2/2\\sigma_{\\text{clone}}^2)$ has width $\\sigma_{\\text{clone}}$ much smaller than the typical distance over which $g(x)$ varies. In the continuum limit $N \\to \\infty$ with inter-particle spacing $O(N^{-1/d})$, the kernel converges weakly to $\\delta(x_i - x_j)$, making cloning effectively local.\n3918: \n3919: **Part 5: Stationarity and Geometric Balance**\n3920: \n3921: At stationarity, $\\Gamma_{\\text{in}}(i) = \\Gamma_{\\text{out}}(i)$. Using the explicit forms from Part 4:\n3922: \n3923: $$\n3924: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot C \\cdot \\sqrt{\\det g(x_j)} \\cdot e^{-H_{\\text{eff}}(x_j, v_j)/T} = p_i(S) \\cdot C \\cdot \\sqrt{\\det g(x_i)} \\cdot e^{-H_{\\text{eff}}(x_i, v_i)/T}\n3925: $$\n3926: \n3927: **Velocity thermalization**: On the timescale of spatial cloning dynamics, velocities rapidly thermalize to the Maxwell-Boltzmann distribution (Lemma {prf:ref}`lem-velocity-marginalization` in Appendix A.2). Therefore, for walkers at the same position $x$, the velocity-dependent factors $e^{-H_{\\text{eff}}/T}$ average out, and we can write:\n3928: \n3929: $$\n3930: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\sqrt{\\det g(x_j)} = p_i(S) \\cdot \\sqrt{\\det g(x_i)}\n3931: $$\n3932: \n3933: **Mean-field approximation**: In the large-$N$ limit, walkers are distributed according to the spatial marginal $\\rho_{\\text{spatial}}(x) \\propto \\sqrt{\\det g(x)} \\exp(-U_{\\text{eff}}(x)/T)$. For a sum over $j$ weighted by $P_{\\text{comp}}(i|j; S)$ (which depends on the swarm distribution), the geometric factors at different positions satisfy:\n3934: \n3935: $$\n3936: \\frac{1}{|\\mathcal{A}|} \\sum_{j \\in \\mathcal{A}} \\sqrt{\\det g(x_j)} \\xrightarrow{N \\to \\infty} \\langle \\det g \\rangle := \\frac{1}{|\\mathcal{A}|} \\sum_{k \\in \\mathcal{A}} \\sqrt{\\det g(x_k)}\n3937: $$\n3938: \n3939: where the convergence holds by the law of large numbers applied to the spatial marginal.\n3940: \n3941: Dividing both sides of the flux balance by $\\sqrt{\\det g(x_i)}$ and using the mean-field approximation:\n3942: \n3943: $$\n3944: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\frac{\\sqrt{\\det g(x_j)}}{\\sqrt{\\det g(x_i)}} = p_i(S)\n3945: $$\n3946: \n3947: **Weighted average convergence**: Define the selection-weighted average:\n3948: \n3949: $$\n3950: \\langle f \\rangle_{i,S} := \\frac{\\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot f(x_j)}{\\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S)}\n3951: $$\n3952: \n3953: For sufficiently smooth functions $f$, standard mean-field theory (McKean-Vlasov propagation of chaos; see Sznitman *Topics in propagation of chaos*, 1991, \u00a73) gives:\n3954: \n3955: $$\n3956: \\mathbb{E}_{X \\sim \\pi_{\\text{QSD}}}[\\langle f \\rangle_{i,S}] \\xrightarrow{N \\to \\infty} \\int_{\\mathcal{X}} f(x) \\rho_{\\text{spatial}}(x) \\, dx\n3957: $$\n3958: \n3959: with variance $\\text{Var}[\\langle f \\rangle_{i,S}] = O(1/N)$. Applying this with $f(x) = \\sqrt{\\det g(x)}$ and using concentration of measure, the weighted average converges to the spatial mean $\\langle \\det g \\rangle$ with high probability. Therefore:\n3960: \n3961: $$\n3962: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\cdot \\sqrt{\\det g(x_j)} \\approx \\left[\\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S)\\right] \\cdot \\langle \\det g \\rangle\n3963: $$\n3964: \n3965: which gives:\n3966: \n3967: $$\n3968: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) \\approx p_i(S) \\cdot \\frac{\\langle \\det g \\rangle}{\\sqrt{\\det g(x_i)}}\n3969: $$\n3970: \n3971: Rearranging gives the flux balance condition:\n3972: \n3973: $$\n3974: \\sum_{j \\neq i} P_{\\text{comp}}(i|j; S) \\cdot p_j(S) = p_i(S) \\cdot \\sqrt{\\frac{\\det g(x_i)}{\\langle \\det g \\rangle}}\n3975: $$\n3976: "
    }
  ],
  "validation": {
    "ok": true,
    "errors": []
  }
}